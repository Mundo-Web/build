import{j as e,o as r,m as t}from"./vendor-react-CZUvQwNQ.js";import{G as o}from"./Footer-DAm0kDL9.js";import{G as a}from"./General-ClVW7qxN.js";import{t as i}from"./OpenPayCardModal-BHkRoVZ6.js";const n=({children:t,className:o="",loading:a=!1,disabled:i=!1,...n})=>e.jsxs("button",{type:"button",disabled:i||a,className:`w-full bg-primary font-bold  py-3 px-4 hover:opacity-90 hover:shadow-md transition-all duration-300 focus:outline-none active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed rounded-xl flex items-center justify-center gap-2 ${o}`,...n,children:[a&&e.jsx(r,{className:"w-4 h-4 animate-spin"}),t]});class s{static async validateCoupon(e){try{const{status:r,result:o}=await t.Fetch("./api/coupons/validate",{method:"POST",body:JSON.stringify(e)});if(!r)throw new Error(o?.message||"Error al validar cupón");return o}catch(r){throw r}}static async generateCode(){try{const{status:e,result:r}=await t.Fetch("./api/coupons/generate-code",{method:"GET"});if(!e)throw new Error(r?.message||"Error al generar código");return r}catch(e){throw e}}}const c={initialized:!1,deviceFingerPrint:null,isAvailable:()=>void 0!==window.Culqi3DS,async init(e){if(!this.isAvailable())return!1;try{return window.Culqi3DS.publicKey=o.CULQI_PUBLIC_KEY,window.Culqi3DS.settings={charge:{totalAmount:e.amount,returnUrl:window.location.href,currency:e.currency||"PEN"},card:{email:e.email}},window.Culqi3DS.options={showModal:!0,showLoading:!0,showIcon:!0,closeModalAction:()=>{},style:{btnColor:o.APP_COLOR_PRIMARY||"#000000",btnTextColor:"#FFFFFF"}},this.initialized=!0,!0}catch(r){return!1}},async generateDeviceFingerPrint(){if(!this.isAvailable())return null;try{return this.deviceFingerPrint=await window.Culqi3DS.generateDevice(),this.deviceFingerPrint}catch(e){return null}},initAuthentication(e){return new Promise((r,t)=>{if(!this.isAvailable())return void t(new Error("Culqi3DS no está disponible"));const o=e=>{const a=e.data;a&&"object"==typeof a&&(a.loading,a.parameters3DS&&(window.removeEventListener("message",o),r({success:!0,parameters3DS:a.parameters3DS})),a.error&&(window.removeEventListener("message",o),t(new Error(a.error))))};window.addEventListener("message",o,!1);try{window.Culqi3DS.initAuthentication(e)}catch(a){window.removeEventListener("message",o),t(a)}})},reset(){this.isAvailable()&&"function"==typeof window.Culqi3DS.reset&&(window.Culqi3DS.reset(),this.deviceFingerPrint=null,this.initialized=!1)}},d={async createOrder(e,r){try{const{status:o,result:a}=await t.Fetch("/api/culqi/order",{method:"POST",body:JSON.stringify({sale:e,details:r})});if(!o)throw new Error(a?.message||"Error al crear orden en Culqi");return a}catch(o){throw o}},async createCheckoutOrder(e){try{const{status:r,result:o}=await t.Fetch("/api/culqi/checkout-order",{method:"POST",body:JSON.stringify(e)});if(!r)throw new Error(o?.message||"Error al crear orden de checkout en Culqi");return o}catch(r){throw r}}};function l(){return!0===o.CULQI_SUPPORTS_USD}function u(){return"USD"===function(){const e=a.get("currency")||"pen";return l()&&"usd"===e.toLowerCase()?"USD":(e.toLowerCase(),"PEN")}()?"$":"S/"}function p(e){const r=a.get("currency")||"pen";if("pen"===r.toLowerCase())return{amount:e,currency:"PEN",wasConverted:!1,exchangeRate:1,originalAmount:e,originalCurrency:"PEN"};if("usd"===r.toLowerCase()&&l())return{amount:e,currency:"USD",wasConverted:!1,exchangeRate:1,originalAmount:e,originalCurrency:"USD"};if("usd"===r.toLowerCase()&&!l()){const r=function(){const e=o.EXCHANGE_RATE||a.get("exchange_rate_usd_pen")||3.75;return parseFloat(e)}();return{amount:e*r,currency:"PEN",wasConverted:!0,exchangeRate:r,originalAmount:e,originalCurrency:"USD"}}return{amount:e,currency:r.toUpperCase(),wasConverted:!1,exchangeRate:1,originalAmount:e,originalCurrency:r.toUpperCase()}}let g=null;const h=async(e,r={})=>{if(!r.orderId&&!r.skipOrderCreation)try{const t=await d.createCheckoutOrder({amount:e.amount,email:e.email,name:e.name,lastname:e.lastname,phone:e.phone}),o=t?.data||t,a=o?.order_id;a&&(r.orderId=a,r.orderData=o)}catch(n){}return new Promise((n,s)=>{try{const{orderId:l,orderData:h}=r,m=!!l;if(!o.CULQI_ENABLED)return void s("Método de pago no disponible: Culqi está deshabilitado");if(void 0===window.CulqiCheckout)return void s("Error en la integración con Culqi: Script no cargado");if(!o.CULQI_PUBLIC_KEY)return void s("Error de configuración: Clave pública de Culqi no encontrada");const C=function(){const e=o.CULQI_RSA_ID,r=o.CULQI_RSA_PUBLIC_KEY;if(!e||!r)return{valid:!0,hasRSA:!1,warning:"RSA no configurado - Usando encriptación estándar de Culqi (segura)"};if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e))return{valid:!0,hasRSA:!1,warning:"RSA ID inválido - Usando encriptación estándar de Culqi"};const t=r.includes("-----BEGIN PUBLIC KEY-----"),a=r.includes("-----END PUBLIC KEY-----");return t&&a?(r.includes("MIGf")||r.includes("MIIBIj"),{valid:!0,hasRSA:!0,info:"RSA configurado correctamente para encriptación adicional"}):{valid:!0,hasRSA:!1,warning:"RSA Public Key formato inválido - Usando encriptación estándar de Culqi"}}();C.warning,C.hasRSA,C.hasRSA;o.CULQI_PUBLIC_KEY?.startsWith("pk_test_"),o.CULQI_PUBLIC_KEY?.startsWith("pk_live_"),a.get("currency");const w=p(e.amount);w.wasConverted?i.info("Conversión de moneda",{description:`Tu pago de $${w.originalAmount.toFixed(2)} USD será procesado como S/${w.amount.toFixed(2)} PEN (TC: ${w.exchangeRate})`,duration:5e3}):w.currency;const y=function(){let e="";for(let r=0;r<12;r++)e+=Math.floor(10*Math.random());return e}(),f=w.currency,P=(u(),parseFloat(w.amount.toFixed(2))),v=Math.round(100*P);if(v<("USD"===f?100:300))return void s(`El monto mínimo para pago con tarjeta es ${"USD"===f?"$1.00":"S/ 3.00"}`);const S={title:o.CULQI_NAME||o.APP_NAME||"Pago",currency:f,amount:v};!!0&&C.hasRSA;const E={email:e.email||""},A={lang:"auto",installments:!1,modal:!0,paymentMethods:m?{tarjeta:!0,yape:!0,bancaMovil:!0,agente:!0,billetera:!0,cuotealo:!1}:{tarjeta:!0,yape:!1,bancaMovil:!1,agente:!1,billetera:!1,cuotealo:!1},paymentMethodsSort:m?["tarjeta","yape","bancaMovil","billetera","agente"]:["tarjeta"]},b={theme:"default",hiddenCulqiLogo:!1,hiddenBannerContent:!1,hiddenBanner:!1,hiddenToolBarAmount:!1,menuType:"sidebar",buttonCardPayText:"Pagar",logo:(o.APP_URL||window.APP_URL||"")+"/assets/resources/logo.png",defaultStyle:{bannerColor:o.APP_COLOR_PRIMARY||"#000000",buttonBackground:o.APP_COLOR_PRIMARY||"#000000",menuColor:o.APP_COLOR_PRIMARY||"#000000",linksColor:o.APP_COLOR_PRIMARY||"#000000",buttonTextColor:"#FFFFFF",priceColor:o.APP_COLOR_PRIMARY||"#000000"}};m&&(S.order=l);const _={settings:S,client:E,options:A,appearance:b};try{g=new window.CulqiCheckout(o.CULQI_PUBLIC_KEY,_)}catch(d){return void s("Error en la integración con Culqi: "+d.message)}let D=!1;g.culqi=async function(){try{if(g.error){const e=g.error.user_message||g.error.merchant_message||"Error al procesar el pago";return i.error("Error en el pago",{description:e,duration:5e3,position:"top-right",richColors:!0}),void s(e)}if(g.charge){D=!0;const o=g.charge,a={...e,chargeId:o.id,orderNumber:y,chargeData:o,paymentType:"charge_completed"},{status:c,result:d}=await t.Fetch("./api/pago/charge-completed",{method:"POST",body:JSON.stringify(a)});try{g.close()}catch(r){}return c?(i.success("¡Pago exitoso!",{description:"Tu pago se procesó correctamente con autenticación 3DS.",duration:3e3,position:"top-right",richColors:!0}),void n(d)):(i.error("Error al registrar el pago",{description:d?.message||"Error al registrar el pago",duration:5e3,position:"top-right",richColors:!0}),void s(d?.message||"Error al registrar el pago"))}if(g.token){D=!0;const a=g.token.id,d=g.token;let l=null;c.isAvailable()&&(await c.init({amount:v,currency:f,email:e.email}),l=await c.generateDeviceFingerPrint());const u={...e,token:a,orderNumber:y,tokenData:d,deviceFingerPrint:l};let{status:p,result:h}=await t.Fetch("./api/pago",{method:"POST",body:JSON.stringify(u)});if(!p&&h?.requires_3ds){try{g.close()}catch(r){}if(!c.isAvailable())return i.error("Error en autenticación",{description:"El servicio de autenticación 3DS no está disponible. Por favor recarga la página.",duration:5e3,position:"top-right",richColors:!0}),void s("Servicio 3DS no disponible");try{i.info("Autenticación requerida",{description:"Por favor completa la verificación de seguridad de tu banco.",duration:5e3,position:"top-right",richColors:!0}),await new Promise(e=>setTimeout(e,300));const e=await c.initAuthentication(a);if(e.success&&e.parameters3DS){const r={...u,authentication_3DS:e.parameters3DS},o=await t.Fetch("./api/pago/3ds",{method:"POST",body:JSON.stringify(r)});p=o.status,h=o.result,c.reset()}}catch(o){return c.reset(),i.error("Error en autenticación",{description:o.message||"No se pudo completar la autenticación 3DS",duration:5e3,position:"top-right",richColors:!0}),void s(o.message||"Error en autenticación 3DS")}}if(!p)return i.error("Error en el pago",{description:h?.message||"Error al procesar el pago",duration:5e3,position:"top-right",richColors:!0}),void s(h?.message||"Error en el pago");try{g.close()}catch(r){}return i.success("¡Pago exitoso!",{description:"Tu pago se procesó correctamente. Pronto recibirás la confirmación.",duration:3e3,position:"top-right",richColors:!0}),void n(h)}if(g.order){D=!0;const o=g.order,a={...e,orderId:o.id,orderNumber:y,orderData:o,paymentType:"order"},{status:s,result:c}=await t.Fetch("./api/pago/order",{method:"POST",body:JSON.stringify(a)});try{g.close()}catch(r){}if(!s)throw new Error(c?.message||"Error al procesar la orden");return i.success("¡Orden creada!",{description:"Tu orden ha sido registrada. Completa el pago según las instrucciones.",duration:5e3,position:"top-right",richColors:!0}),void n(c)}s("No se recibió respuesta del procesador de pagos")}catch(d){i.error("¡Error en el Pago!",{description:d.message||"Error desconocido",duration:3e3,position:"top-right",richColors:!0}),s(d.message||"Error en el pago")}},g.open()}catch(d){i.error("¡Error en la integración con Culqi!",{description:d.message||"Error desconocido",duration:3e3,position:"top-right",richColors:!0}),s("Error en la integración con Culqi: "+d.message)}})};export{n as B,s as C,h as p};
