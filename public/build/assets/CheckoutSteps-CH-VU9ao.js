import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as c}from"./index-BOnQTV8N.js";import{C as y,N as j}from"./Number2Currency-D9Rjvh76.js";import{D as Ae,C as mt,B as Fe,a as Oe,P as pt,b as ut,A as xt,O as ht,I as Ze,S as ft,c as gt}from"./StorePickupSelector-CDjcQF6y.js";import{i as et}from"./tippy-react.esm-DmkRJDEW.js";import{O as Me,p as bt,U as yt,u as jt}from"./useEcommerceTracking-DJ8tdrxn.js";import{I as je}from"./InputForm-Dmyom2PO.js";import{S as vt}from"./SelectForm-BvZde-dr.js";import"./main-B6F2O9-U.js";import{l as Nt}from"./ShippingStep-C6i134TO.js";import{t as le}from"./CardProductKatya-ncpmQ0JU.js";import{G as te}from"./Global-CazroCzF.js";import{C as ge}from"./circle-x-5vreeYph.js";import{m as we}from"./proxy-B0QLMKEh.js";import"./ProductNavigation-C3qRptTo.js";import"./ProductCard-D_AgkLlk.js";/* empty css              */import"./BlogCarousel-DCQ9UYu0.js";/* empty css               */import"./BlogCarrusel-klwTVD05.js";import{R as wt}from"./PolicyModal-C80IvD61.js";import{H as St}from"./HtmlContent-ghmllTyl.js";import{X as Ct}from"./x-fof_H3Vv.js";import"./index-yBjzXJbu.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./General-BmbBKdsB.js";import"./createLucideIcon-DfjclApS.js";import"./sparkles-DvmvZ6mJ.js";import"./package-DBFPPBi1.js";import"./minus-Db6MFKEO.js";import"./plus-CTIomuuF.js";import"./trash-2-DU7LB6-f.js";import"./index-BQJyKPGC.js";import"./useStateManager-7e1e8489.esm-JZ1pGKcX.js";import"./hoist-non-react-statics.cjs-Dk09vysS.js";import"./index-pSueRYGM.js";import"./index-B6ujFmsw.js";import"./floating-ui.dom-C6hn-rxH.js";import"./StoresRest-Bb6TODpG.js";import"./BasicRest-BML1C-ua.js";import"./BooleanLimit-D-OsQsek.js";import"./chevron-down-uIVDLcM-.js";import"./search-BQ59Robe.js";import"./check-D5vaIe6v.js";import"./___vite-browser-external_commonjs-proxy-DDYoOVPM.js";import"./ItemsRest-Dp5IKigO.js";import"./HeaderSearch-DicFuFIN.js";import"./CartItemRow-FwA1YhUV.js";import"./index-BZvh78jk.js";import"./eye-ScgfreHn.js";import"./index-Chjiymov.js";function _t({data:f,cart:N,setCart:se,onContinue:Y,subTotal:O,envio:E,igv:X,fleteTotal:V,seguroImportacionTotal:g,derechoArancelarioTotal:U,totalFinal:de,openModal:$,categorias:W,automaticDiscounts:oe,setAutomaticDiscounts:o,automaticDiscountTotal:J,setAutomaticDiscountTotal:h,totalWithoutDiscounts:B,generals:b}){var xe,he,ve,T,fe,Ce;const[be,R]=c.useState(oe||[]),[A,P]=c.useState(J||0),[H,Z]=c.useState(!1),[ye,ae]=c.useState([]),[ee,G]=c.useState([]),[me,a]=c.useState(!1),[_,F]=c.useState(null),[re,Q]=c.useState(null),L=N.length===0;c.useEffect(()=>{const i=N.filter(r=>r.type==="combo");if(console.log("🔍 CartStep useEffect triggered:",{cartLength:N.length,subTotal:O,combosCount:i.length,combos:i}),N.length>0&&O>0)l();else{const r=[];R(r),P(0),ae([]),G([]),o&&o(r),h&&h(0)}},[N,O]);const l=async()=>{Z(!0);try{const i=N.reduce((p,q)=>p+(q.quantity||0),0),r=N.filter(p=>p.type==="combo");console.log("🛒 CartStep applying discounts:",{cart:N,subTotal:O,totalWithoutDiscounts:B,totalQuantity:i,cartLength:N.length,combosInCart:r.length,combos:r,cartItems:N.map(p=>({id:p.id||p.item_id,name:p.name,quantity:p.quantity,price:p.price||p.final_price,category_id:p.category_id,type:p.type}))});const m=await Ae.applyToCart(N,B);if(console.log("📥 Server response:",{success:m.success,data:m.data,error:m.error,fullResult:m}),m.success&&m.data){console.log("✅ Discounts found:",m.data.applied_discounts);const p=Ae.formatDiscounts(m.data.applied_discounts),q=m.data.total_discount||0,ie=Ae.getFreeItems(m.data.applied_discounts),ne=[];m.data.applied_discounts.forEach(z=>{z.suggested_items&&Array.isArray(z.suggested_items)&&ne.push(...z.suggested_items)}),R(p),P(q),ae(ie),G(ne),o&&o(p),h&&h(q),console.log("🔒 Preserving original cart, not updating from server response")}else{console.error("❌ Discount application failed:",{error:m.error,success:m.success,data:m.data,fullResult:m});const p=[],q=0;R(p),P(q),ae([]),G([]),o&&o(p),h&&h(q)}}catch(i){console.error("Error applying discount rules:",i);const r=[],m=0;R(r),P(m),ae([]),G([]),o&&o(r),h&&h(m)}finally{Z(!1)}},D=i=>ee.some(r=>r.item_id===i||r.triggering_item_id===i),pe=i=>ee.find(r=>r.item_id===i||r.triggering_item_id===i),Se=i=>{const r=pe(i.id);r&&(F(r),Q(i),a(!0))},ue=async i=>{try{console.log("CartStep - handleAddPromotionalItem received:",i),console.log("CartStep - current cart:",N),se(r=>{console.log("CartStep - old cart before update:",r);const m=r.findIndex(p=>(p.item_id||p.id)===i.item_id);if(console.log("CartStep - existingItemIndex:",m),m!==-1){const p=[...r],q=i.quantity||i.suggested_quantity||1;return console.log("CartStep - adding quantity:",q),p[m].quantity+=q,console.log("CartStep - updated cart:",p),p}else{console.log("CartStep - item not found, creating new product");const p={id:i.item_id,name:i.item_name,quantity:i.quantity||i.suggested_quantity||1,price:i.value||0,final_price:i.value||0,image:i.item_image||"default.jpg",brand:{name:i.item_brand||"N/A"},sku:i.item_sku||"PROMO",stock:999};return[...r,p]}}),setTimeout(()=>{l()},100)}catch(r){console.error("Error adding promotional item:",r)}};return e.jsxs("div",{className:"grid lg:grid-cols-5 gap-4 md:gap-8",children:[e.jsx("div",{className:"lg:col-span-3 space-y-4 md:space-y-6",children:L?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center animate-fade-in",children:[e.jsx("svg",{className:"w-24 h-24 text-gray-300 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"})}),e.jsx("h3",{className:"text-xl font-semibold text-gray-600 mb-2",children:"Tu carrito está vacío"}),e.jsx("p",{className:"text-gray-500",children:"¡Explora nuestros productos y encuentra algo especial!"})]}):N.map((i,r)=>e.jsx(mt,{...i,setCart:se,categorias:W,hasPromotion:D(i.id),onPromotionClick:Se},r))}),e.jsxs("div",{className:"lg:col-span-2 bg-[#F7F9FB] rounded-xl shadow-lg p-4 md:p-6 h-max mt-4 md:mt-0",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-bold pb-4 md:pb-6",children:"Resumen"}),e.jsxs("div",{className:"space-y-3 md:space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"Subtotal"}),e.jsxs("span",{className:"font-semibold",children:[y(),j(O)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:["IGV (",Number(((xe=b==null?void 0:b.find(i=>i.correlative==="igv_checkout"))==null?void 0:xe.description)||18),"%)"]}),e.jsxs("span",{className:"font-semibold",children:[y(),j(X)]})]}),Number((he=b==null?void 0:b.find(i=>i.correlative==="importation_seguro"))==null?void 0:he.description)>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:["Seguro (",Number(((ve=b==null?void 0:b.find(i=>i.correlative==="importation_seguro"))==null?void 0:ve.description)||0).toFixed(2),"%)"]}),e.jsxs("span",{className:"font-semibold",children:[y(),j(g)]})]}),Number((T=b==null?void 0:b.find(i=>i.correlative==="importation_derecho_arancelario"))==null?void 0:T.description)>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:["Derecho arancelario",((fe=b==null?void 0:b.find(i=>i.correlative==="importation_derecho_arancelario_descripcion"))==null?void 0:fe.description)&&e.jsx(et,{content:e.jsx("p",{className:"whitespace-pre-line",children:(Ce=b==null?void 0:b.find(i=>i.correlative==="importation_derecho_arancelario_descripcion"))==null?void 0:Ce.description}),allowHTML:!0,children:e.jsx("i",{className:"mdi mdi-information ms-1"})})]}),e.jsxs("span",{className:"font-semibold",children:[y(),j(U)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"Envío"}),e.jsxs("span",{className:"font-semibold",children:[y(),j(E)]})]}),H&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"Verificando descuentos..."}),e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary"})]}),!H&&be.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold pb-4 md:pb-6  customtext-neutral-dark mb-2",children:"🎉 Descuentos aplicados:"}),be.map((i,r)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:[i.name,i.description&&e.jsx("span",{className:"text-xs font-semibold block",children:i.description})]}),e.jsxs("span",{className:"customtext-neutral-dark font-semibold",children:["-",y(),j(i.amount)]})]},r)),e.jsxs("div",{className:"flex justify-between text-sm font-semibold customtext-neutral-dark pt-1",children:[e.jsx("span",{children:"Total descuentos:"}),e.jsxs("span",{children:["-",y(),j(A)]})]})]}),e.jsxs("div",{className:"py-3 border-y-2 mt-4 md:mt-6",children:[e.jsxs("div",{className:"flex justify-between font-bold text-lg md:text-[20px] items-center",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:[y(),j(de)]})]}),A>0&&e.jsxs("div",{className:"text-sm text-gray-500 mt-1",children:[e.jsxs("span",{className:"line-through",children:[y(),j(B||de+A)]}),e.jsxs("span",{className:"ml-2 customtext-neutral-dark font-semibold",children:["Ahorras ",y(),j(A)]})]})]}),e.jsxs("div",{className:"space-y-2 pt-3 md:pt-4",children:[e.jsx(Fe,{onClick:Y,disabled:L,className:`w-full ${(f==null?void 0:f.class_button)||"text-white"}`,children:L?"Carrito Vacío":"Continuar Compra"}),e.jsx(Oe,{href:"/",className:"w-full",children:L?"Ir a Comprar":"Cancelar"})]}),e.jsx("div",{children:e.jsxs("p",{className:"text-xs md:text-sm customtext-neutral-dark",children:["Al realizar tu pedido, aceptas los ",e.jsx("a",{href:"#",onClick:()=>$(1),className:"customtext-primary font-bold",children:"Términos y Condiciones"}),", y que nosotros usaremos sus datos personales de acuerdo con nuestra ",e.jsx("a",{href:"#",onClick:()=>$(0),className:"customtext-primary font-bold",children:"Política de Privacidad"}),"."]})})]})]}),e.jsx(pt,{isOpen:me,onClose:()=>a(!1),suggestion:_,onAddToCart:ue,productName:(re==null?void 0:re.name)||""})]})}function kt({data:f,cart:N,setSale:se,setCode:Y,setDelivery:O,setCart:E,onContinue:X,noContinue:V,subTotal:g,igv:U,fleteTotal:de,seguroImportacionTotal:$,derechoArancelarioTotal:W,totalFinal:oe,user:o,setEnvio:J,envio:h,ubigeos:B=[],openModal:b,categorias:be,setCouponDiscount:R,setCouponCode:A,automaticDiscounts:P=[],automaticDiscountTotal:H=0,setAutomaticDiscounts:Z,setAutomaticDiscountTotal:ye,totalWithoutDiscounts:ae,conversionScripts:ee,setConversionScripts:G,onPurchaseComplete:me,generals:a}){var He,Ge,Qe,Ke,Ye,Xe,We;const[_,F]=c.useState(null),[re,Q]=c.useState(null);P.reduce((t,s)=>s.free_items&&Array.isArray(s.free_items)?[...t,...s.free_items]:t,[]);const L=[{value:"dni",label:"DNI"},{value:"ruc",label:"RUC"},{value:"ce",label:"CE"},{value:"pasaporte",label:"Pasaporte"}],[l,D]=c.useState({name:(o==null?void 0:o.name)||"",lastname:(o==null?void 0:o.lastname)||"",email:(o==null?void 0:o.email)||"",phone:(o==null?void 0:o.phone)||"",documentType:((He=o==null?void 0:o.document_type)==null?void 0:He.toLowerCase())||"",document:(o==null?void 0:o.document_number)||"",department:(o==null?void 0:o.department)||"",province:(o==null?void 0:o.province)||"",district:(o==null?void 0:o.district)||"",address:(o==null?void 0:o.address)||"",number:(o==null?void 0:o.number)||"",comment:"",reference:(o==null?void 0:o.reference)||"",ubigeo:(o==null?void 0:o.ubigeo)||null});c.useEffect(()=>{if(console.log("🔍 ShippingStep - Verificando usuario:",{user:o,ubigeo:o==null?void 0:o.ubigeo,district:o==null?void 0:o.district,province:o==null?void 0:o.province,department:o==null?void 0:o.department}),o!=null&&o.ubigeo)if(!(o!=null&&o.district)||!(o!=null&&o.province)||!(o!=null&&o.department))console.log("🔍 ShippingStep - Buscando ubicación por ubigeo:",o.ubigeo),fetch(`/api/ubigeo/find/${o.ubigeo}`).then(t=>t.json()).then(t=>{if(t&&t.distrito){const s={value:o.ubigeo,label:`${t.distrito}, ${t.provincia}, ${t.departamento}`,data:{reniec:o.ubigeo,departamento:t.departamento,provincia:t.provincia,distrito:t.distrito}};console.log("✅ ShippingStep - Ubicación encontrada y cargada:",s),Q(s),F(s),Ue(s)}else console.log("❌ ShippingStep - No se encontró ubicación para ubigeo:",o.ubigeo)}).catch(t=>{console.error("❌ ShippingStep - Error al buscar ubicación:",t)});else{const t={value:o.ubigeo,label:`${o.district}, ${o.province}, ${o.department}`,data:{reniec:o.ubigeo,departamento:o.department,provincia:o.province,distrito:o.district}};console.log("✅ ShippingStep - Cargando ubicación por defecto:",t),Q(t),F(t),Ue(t)}else console.log("❌ ShippingStep - Usuario sin ubigeo registrado")},[o]),c.useEffect(()=>{o&&D(t=>{var s;return{...t,name:o.name||t.name,lastname:o.lastname||t.lastname,email:o.email||t.email,phone:o.phone||t.phone,documentType:((s=o.document_type)==null?void 0:s.toLowerCase())||t.documentType,document:o.document_number||t.document,department:o.department||t.department,province:o.province||t.province,district:o.district||t.district,address:o.address||t.address,number:o.number||t.number,reference:o.reference||t.reference,ubigeo:o.ubigeo||t.ubigeo}})},[o]);const[pe,Se]=c.useState(!1),[ue,xe]=c.useState(!1),[he,ve]=c.useState([]),[T,fe]=c.useState(null),[Ce,i]=c.useState(null),[r,m]=c.useState({}),[p,q]=c.useState(""),[ie,ne]=c.useState(!1),[z,_e]=c.useState(""),[n,w]=c.useState(null),[ce,ke]=c.useState(0),[Ne,Ie]=c.useState(!1),[Te,Ee]=c.useState(""),[qe,Re]=c.useState(null),[tt,Be]=c.useState(!1),[st,De]=c.useState(!1),ot=t=>{Re(t),m(s=>({...s,store:""}))},at=t=>{var u,I,x;const s=["name","lastname","documentType","document","email","phone","ubigeo","address","shipping"];for(const k of s)if(t[k]){let S=null,v=!1;if(k==="ubigeo"?S=((I=(u=document.querySelector('[name="ubigeo"]'))==null?void 0:u.parentElement)==null?void 0:I.parentElement)||document.querySelector(".css-1s2u09g-control")||document.querySelector('[class*="react-select"]'):k==="shipping"?S=((x=document.querySelector('input[name="shipping"]'))==null?void 0:x.closest(".space-y-4"))||document.querySelector(".space-y-4 h3")||document.querySelector("h3"):(S=document.querySelector(`[name="${k}"]`),v=!0),S){S.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),v&&setTimeout(()=>{try{S.focus(),S.tagName==="INPUT"&&S.type==="text"&&S.select()}catch(d){console.warn("No se pudo enfocar el elemento:",d)}},600),rt(S);break}}},rt=t=>{if(!t)return;const s=document.createElement("div");if(s.style.cssText=`
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid #ef4444;
            border-radius: 8px;
            pointer-events: none;
            z-index: 1000;
            animation: pulse 0.6s ease-in-out;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
        `,!document.querySelector("#error-highlight-styles")){const I=document.createElement("style");I.id="error-highlight-styles",I.textContent=`
                @keyframes pulse {
                    0% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.02); opacity: 0.8; }
                    100% { transform: scale(1); opacity: 1; }
                }
            `,document.head.appendChild(I)}const u=t.style.position;(!u||u==="static")&&(t.style.position="relative"),t.appendChild(s),setTimeout(()=>{s.parentNode&&(s.parentNode.removeChild(s),(!u||u==="static")&&(t.style.position=u))},1200)},Ue=async t=>{var u,I,x,k,S;if(!t)return;m(v=>({...v,ubigeo:""}));const{data:s}=t;D(v=>({...v,department:s.departamento,province:s.provincia,district:s.distrito,ubigeo:s.reniec})),Se(!0);try{const v=N.reduce((M,$e)=>M+$e.final_price*$e.quantity,0);console.log("🛒 ShippingStep - Cart total calculado:",v),console.log("🛒 ShippingStep - Cart items:",N.map(M=>({name:M.name,price:M.final_price,quantity:M.quantity,total:M.final_price*M.quantity}))),console.log("💰 ShippingStep - Comparación de totales:"),console.log("   - Cart total (solo productos):",v),console.log("   - SubTotal prop:",g),console.log("   - IGV prop:",U),console.log("   - Total con IGV:",g+U),console.log("   - Total final prop:",oe);const d=await ut.getShippingCost({ubigeo:s.reniec,cart_total:v});console.log("📦 ShippingStep - Respuesta del backend:",d.data),console.log("✅ ShippingStep - Califica para envío gratis?",d.data.qualifies_free_shipping),console.log("💰 ShippingStep - Umbral requerido:",d.data.free_shipping_threshold),console.log("🔍 ShippingStep - is_free:",d.data.is_free),console.log("🔍 ShippingStep - Descripción standard:",(u=d.data.standard)==null?void 0:u.description),console.log("🔍 ShippingStep - Tipo standard:",(I=d.data.standard)==null?void 0:I.type);const K=[];let Je=!1;if(d.data.is_free&&d.data.qualifies_free_shipping&&(console.log("✅ ShippingStep - Es zona is_free=true Y califica por monto - Agregando envío GRATIS"),K.push({type:"free",price:0,description:d.data.standard.description,deliveryType:d.data.standard.type,characteristics:d.data.standard.characteristics})),d.data.standard&&(!d.data.is_free||d.data.is_free&&!d.data.qualifies_free_shipping)){console.log("📦 ShippingStep - Agregando envío NORMAL");let M=d.data.standard.description;d.data.is_free||(M=M.replace(/envío gratis.*?/gi,"").replace(/envio gratis.*?/gi,"").replace(/gratis.*?compras.*?/gi,"").replace(/mayor.*?200.*?/gi,"").replace(/200.*?mayor.*?/gi,"").replace(/\s+/g," ").trim(),M||(M="Delivery a domicilio")),K.push({type:"standard",price:d.data.standard.price,description:M,deliveryType:d.data.standard.type,characteristics:d.data.standard.characteristics})}d.data.express&&d.data.express.price>0&&(console.log("⚡ ShippingStep - Agregando envío EXPRESS"),K.push({type:"express",price:d.data.express.price,description:d.data.express.description,deliveryType:d.data.express.type,characteristics:d.data.express.characteristics})),d.data.is_agency&&d.data.agency&&(console.log("🏢 ShippingStep - Agregando envío por AGENCIA"),K.push({type:"agency",price:d.data.agency.price||0,description:d.data.agency.description,deliveryType:d.data.agency.type,characteristics:d.data.agency.characteristics})),d.data.is_store_pickup&&(console.log("🏪 ShippingStep - Retiro en tienda disponible"),Je=!0),Je||d.data.is_store_pickup?(K.some($e=>$e.type==="store_pickup")||(d.data.store_pickup?K.push({type:"store_pickup",price:d.data.store_pickup.price,description:d.data.store_pickup.description,deliveryType:d.data.store_pickup.type,characteristics:d.data.store_pickup.characteristics}):K.push({type:"store_pickup",price:0,description:"Retira tu pedido en una de nuestras tiendas",deliveryType:"Retiro en Tienda",characteristics:["Sin costo de envío","Horarios flexibles","Atención personalizada"]})),Be(!0)):(Be(!1),Re(null)),ve(K),fe(((x=K[0])==null?void 0:x.type)||null),J(((k=K[0])==null?void 0:k.price)||0),ne(!1),console.log("📋 ShippingStep - Opciones finales de envío:",K),console.log("🚚 ShippingStep - Precio de envío seleccionado:",((S=K[0])==null?void 0:S.price)||0)}catch{le.error("Sin cobertura",{description:"No realizamos envíos a esta ubicación.",icon:e.jsx(Me,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"bottom-center"}),ve([]),fe(null),J(0),ne(!1)}Se(!1)},ze=async t=>{var x,k;if(t.preventDefault(),ue)return;if(!o){De(!0);return}const s={},u=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,I=/^[0-9]{9}$/;if(l.name.trim()||(s.name="Nombre es requerido"),l.lastname.trim()||(s.lastname="Apellido es requerido"),l.documentType.trim()||(s.documentType="Tipo de documento es requerido"),l.document.trim()||(s.document="Número de documento es requerido"),l.email.trim()?u.test(l.email)||(s.email="Email inválido"):s.email="Email es requerido",l.phone.trim()?I.test(l.phone.trim())||(s.phone="Teléfono debe tener exactamente 9 dígitos"):s.phone="Teléfono es requerido",l.ubigeo||(s.ubigeo="Ubicación es requerida"),l.address||(s.address="Dirección es requerida"),T||(s.shipping="Seleccione un método de envío"),Object.keys(s).length>0){m(s);const S=Object.keys(s)[0],v={name:"Por favor ingrese su nombre",lastname:"Por favor ingrese su apellido",documentType:"Por favor seleccione el tipo de documento",document:"Por favor ingrese su número de documento",email:(x=s.email)!=null&&x.includes("inválido")?"Por favor ingrese un correo electrónico válido":"Por favor ingrese su correo electrónico",phone:(k=s.phone)!=null&&k.includes("9 dígitos")?"El teléfono debe tener exactamente 9 dígitos":"Por favor ingrese su número de teléfono",ubigeo:"Por favor seleccione su ubicación de entrega",address:"Por favor ingrese su dirección de entrega",shipping:"Por favor seleccione un método de envío"};le.error("Complete el campo requerido",{description:v[S],icon:e.jsx(ge,{className:"h-5 w-5 text-red-500"}),duration:4e3,position:"top-center"}),at(s);return}xe(!0);try{if(!te.CULQI_ENABLED){le.error("Método de pago no disponible",{description:"El procesamiento de pagos con tarjeta está temporalmente deshabilitado",icon:e.jsx(ge,{className:"h-5 w-5 text-red-500"}),duration:4e3,position:"top-center"}),xe(!1);return}if(!te.CULQI_PUBLIC_KEY){le.error("Error de configuración",{description:"El sistema de pagos no está configurado correctamente",icon:e.jsx(ge,{className:"h-5 w-5 text-red-500"}),duration:4e3,position:"top-center"}),xe(!1);return}const S={user_id:o.id,...l,fullname:`${l.name} ${l.lastname}`,country:"Perú",document_type:l.documentType,amount:C(Le),delivery:C(h),seguro_importacion_total:C($||0),derecho_arancelario_total:C(W||0),flete_total:C(de||0),delivery_type:T,store_id:T==="store_pickup"?qe==null?void 0:qe.id:null,cart:N,coupon_id:(n==null?void 0:n.id)||null,coupon_code:(n==null?void 0:n.code)||null,coupon_discount:C(ce||0),applied_promotions:P||[],promotion_discount:C(H||0)};console.log("📦 Request completo a enviar:",S),console.log("💰 Monto final con cupón:",Le),console.log("🎟️ Descuento del cupón:",ce),console.log("🚚 Costo de envío:",h);const v=await bt(S);if(console.log("📋 Respuesta completa del procesamiento:",v),v.status){if(console.log("✅ Pago exitoso, procesando respuesta..."),se(v.sale),O(v.delivery),Y(v.code),v.conversion_scripts&&(console.log("Scripts de conversión recibidos:",v.conversion_scripts),G(v.conversion_scripts),me)){console.log("🎯 Ejecutando callback onPurchaseComplete...");try{await me(v.sale_id,v.conversion_scripts),console.log("✅ Callback onPurchaseComplete ejecutado exitosamente")}catch(d){console.error("❌ Error en callback onPurchaseComplete:",d)}}console.log("🛒 Limpiando carrito y continuando..."),E([]),X()}else console.log("❌ Pago rechazado:",v),le.error("Error en el pago",{description:v.message||"Pago rechazado",icon:e.jsx(Me,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"bottom-center"})}catch(S){console.error("💥 Error completo en handlePayment:",S),console.error("💥 Stack trace:",S.stack),console.error("💥 Error name:",S.name),console.error("💥 Error message:",S.message),le.error("Lo sentimos, no puede continuar con la compra",{description:`Ocurrió un error al procesar el pedido: ${S.message}`,icon:e.jsx(Me,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"bottom-center"})}finally{xe(!1)}},it=c.useCallback(Nt.debounce((t,s)=>{if(t.length<3){s([]);return}fetch(`/api/ubigeo/search?q=${encodeURIComponent(t)}`).then(u=>{if(!u.ok)throw new Error("Error en la respuesta");return u.json()}).then(u=>{const I=u.map(x=>({value:x.reniec,label:`${x.distrito}, ${x.provincia}, ${x.departamento}`,data:{inei:x.inei,reniec:x.reniec,departamento:x.departamento,provincia:x.provincia,distrito:x.distrito}}));s(I)}).catch(u=>{s([])})},300),[]);c.useEffect(()=>{m(t=>{const s={...t};return l.name.trim()&&delete s.name,l.lastname.trim()&&delete s.lastname,l.documentType.trim()&&delete s.documentType,l.document.trim()&&delete s.document,l.email.trim()&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(l.email)&&delete s.email,l.phone.trim()&&/^[0-9]{9}$/.test(l.phone.trim())&&delete s.phone,l.address.trim()&&delete s.address,l.ubigeo&&delete s.ubigeo,T&&delete s.shipping,s})},[l,T]);const nt=t=>({control:s=>({...s,border:`1px solid ${t?"#ef4444":"#e5e7eb"}`,boxShadow:"none",minHeight:"50px","&:hover":{borderColor:t?"#ef4444":"#6b7280"},borderRadius:"0.75rem",padding:"2px 8px"}),menu:s=>({...s,zIndex:9999,marginTop:"4px",borderRadius:"8px"}),option:s=>({...s,color:"#1f2937",backgroundColor:"white","&:hover":{backgroundColor:"#f3f4f6"},padding:"12px 16px"})}),ct=async()=>{var t;if(!z.trim()){Ee("Ingrese un código de cupón");return}Ie(!0),Ee("");try{const s=[...new Set(N.map(k=>k.category_id).filter(Boolean))],u=N.map(k=>k.id);console.log("Validando cupón:",{code:z.trim(),cart_total:g,category_ids:s,product_ids:u});const I=await gt.validateCoupon({code:z.trim(),cart_total:g,category_ids:s,product_ids:u});console.log("Respuesta del cupón:",I);const x=I.data||I;if(x&&x.valid){w(x.coupon);const k=Math.round(x.discount*100)/100;ke(k),R&&R(k),A&&A(((t=x.coupon)==null?void 0:t.code)||z.trim()),le.success("Cupón aplicado",{description:x.message||"Cupón aplicado correctamente",duration:3e3,position:"top-center"})}else{const k=(x==null?void 0:x.message)||"Cupón no válido";Ee(k),le.error("Cupón no válido",{description:k,icon:e.jsx(ge,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"top-center"})}}catch(s){console.error("Error al validar cupón:",s),Ee("Error al validar el cupón"),le.error("Error",{description:s.message||"No se pudo validar el cupón. Intente nuevamente.",icon:e.jsx(ge,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"top-center"})}finally{Ie(!1)}},lt=()=>{w(null),ke(0),_e(""),Ee(""),R&&R(0),A&&A(""),le.success("Cupón removido",{description:"El cupón ha sido removido de su pedido",duration:2e3,position:"top-center"})},C=t=>{const s=typeof t=="string"?parseFloat(t):t;return parseFloat(s.toFixed(2))},Ve=C(g)+C(U)+C(h)+C($)+C(W)-C(H);let Pe=0;n&&(n.type==="percentage"||n.type==="percent"?Pe=Ve*Number(n.value)/100:n.type==="fixed"&&(Pe=Number(n.value))),c.useEffect(()=>{ke(C(Pe)),R&&R(C(Pe))},[n,g,U,h,H]);const Le=Math.max(0,C(Ve-Pe)),dt=()=>{if(!st)return null;const t=s=>{s.target===s.currentTarget&&De(!1)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:t,children:e.jsx("div",{className:"bg-white rounded-xl p-6 max-w-md w-full shadow-2xl transform transition-all",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4",children:e.jsx(yt,{className:"h-8 w-8 customtext-primary"})}),e.jsx("h2",{className:"text-2xl font-bold customtext-neutral-dark mb-3",children:"Acceso requerido"}),e.jsx("p",{className:"customtext-neutral-light text-sm leading-relaxed",children:"Para continuar con su compra necesita iniciar sesión o crear una cuenta nueva."})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{window.location.href="/iniciar-sesion"},className:"w-full py-3 px-6 bg-primary text-white font-semibold rounded-lg  focus:outline-none focus:ring-2  focus:ring-offset-2 transition duration-200 transform hover:scale-[1.02]",children:"Iniciar sesión"}),e.jsx("button",{onClick:()=>{window.location.href="/crear-cuenta"},className:"w-full py-3 px-6 bg-accent text-white font-semibold rounded-lg  focus:outline-none focus:ring-2  focus:ring-offset-2 transition duration-200 transform hover:scale-[1.02]",children:"Crear cuenta nueva"}),e.jsx("button",{onClick:()=>De(!1),className:"w-full py-3 px-6 customtext-neutral-light hover:customtext-neutral-dark border border-secondary rounded-lg hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200",children:"Cancelar"})]})]})})})};return e.jsxs(e.Fragment,{children:[e.jsx(dt,{}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-5 md:gap-8",children:[e.jsx("div",{className:"lg:col-span-3",children:e.jsxs("form",{className:"space-y-4 md:space-y-6 bg-white p-4 md:p-6 rounded-xl shadow-sm",onSubmit:ze,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(je,{name:"name",label:"Nombres",value:l.name,error:r.name,onChange:t=>{D(s=>({...s,name:t.target.value})),t.target.value.trim()&&r.name&&m(s=>({...s,name:""}))},required:!0,className:`border-gray-200 ${r.name?"border-red-500 bg-red-50":""}`}),e.jsx(je,{name:"lastname",label:"Apellidos",value:l.lastname,error:r.lastname,onChange:t=>{D(s=>({...s,lastname:t.target.value})),t.target.value.trim()&&r.lastname&&m(s=>({...s,lastname:""}))},required:!0,className:`border-gray-200 ${r.lastname?"border-red-500 bg-red-50":""}`})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"space-y-2",children:e.jsx(vt,{label:"Tipo de documento",options:L,placeholder:"Selecciona tu documento",labelClass:"block text-sm 2xl:!text-base mb-1 customtext-neutral-dark",value:l.documentType,error:r.documentType,onChange:t=>{D(s=>({...s,documentType:t})),t&&r.documentType&&m(s=>({...s,documentType:""}))},required:!0})}),e.jsx(je,{name:"document",label:"Número de documento",value:l.document,error:r.document,onChange:t=>{D(s=>({...s,document:t.target.value})),t.target.value.trim()&&r.document&&m(s=>({...s,document:""}))},placeholder:"Ej: 12345678",required:!0,className:`border-gray-200 ${r.document?"border-red-500 bg-red-50":""}`})]}),e.jsx(je,{name:"email",label:"Correo electrónico",type:"email",value:l.email,error:r.email,onChange:t=>{D(s=>({...s,email:t.target.value})),t.target.value.trim()&&r.email&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.target.value)&&m(u=>({...u,email:""}))},required:!0,className:`border-gray-200 ${r.email?"border-red-500 bg-red-50":""}`}),e.jsx(je,{name:"phone",label:"Teléfono",type:"tel",value:l.phone,error:r.phone,onChange:t=>{const s=t.target.value.replace(/\D/g,"");D(u=>({...u,phone:s})),s.length===9&&r.phone&&m(u=>({...u,phone:""}))},maxLength:"9",placeholder:"Ej: 987654321",required:!0,className:`border-gray-200 ${r.phone?"border-red-500 bg-red-50":""}`}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"block text-sm 2xl:text-base mb-2 font-medium customtext-neutral-dark",children:["Distrito / Provincia / Departamento (Ubicación de entrega)",e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),e.jsx(xt,{name:"ubigeo",cacheOptions:!0,value:_,loadOptions:it,onChange:t=>{F(t),Ue(t),q("")},inputValue:p,onInputChange:(t,{action:s})=>{s==="input-change"&&q(t)},onFocus:()=>{F(null),q("")},onMenuOpen:()=>{_&&(F(null),q(""))},placeholder:"Buscar por Distrito ...",loadingMessage:()=>"Buscando ubicaciones...",noOptionsMessage:({inputValue:t})=>t.length<3?"Buscar por Distrito ...":"No se encontraron resultados",isLoading:pe,styles:nt(!!r.ubigeo),formatOptionLabel:({data:t})=>e.jsxs("div",{className:"text-sm py-1",children:[e.jsx("div",{className:"font-medium",children:t.distrito}),e.jsxs("div",{className:"text-gray-500",children:[t.provincia,", ",t.departamento]})]}),className:"w-full rounded-xl transition-all duration-300",menuPortalTarget:document.body,isClearable:!0}),r.ubigeo&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:r.ubigeo})]}),e.jsx(je,{name:"address",label:"Dirección ",value:l.address,error:r.address,onChange:t=>{D(s=>({...s,address:t.target.value})),t.target.value.trim()&&r.address&&m(s=>({...s,address:""}))},required:!0,className:`border-gray-200 ${r.address?"border-red-500 bg-red-50":""}`}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(je,{label:"Número",value:l.number,onChange:t=>D(s=>({...s,number:t.target.value})),className:"border-gray-200"}),e.jsx(je,{label:"Referencia",value:l.reference,onChange:t=>D(s=>({...s,reference:t.target.value})),className:"border-gray-200"})]}),he.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Método de envío"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:he.map(t=>e.jsx(ht,{title:t.deliveryType,price:t.price,description:t.description,selected:T===t.type,onSelect:()=>{fe(t.type),J(t.price),m(s=>({...s,shipping:"",store:""})),ne(!1),t.type!=="store_pickup"&&Re(null)}},t.type))}),T&&he.length>0&&e.jsx("div",{className:"space-y-3 mt-4",children:(()=>{var I;const t=((I=he.find(x=>x.type===T))==null?void 0:I.characteristics)||[],s=t.length>1,u=s&&!ie?t.slice(0,1):t;return e.jsxs(e.Fragment,{children:[u.map((x,k)=>e.jsxs("div",{className:"flex items-start gap-3 bg-gray-50 p-4 rounded-xl",children:[e.jsx("div",{className:"w-5 flex-shrink-0",children:e.jsx(Ze,{className:"customtext-primary"})}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"text-sm font-medium customtext-neutral-dark",children:x})})]},`char-${k}`)),s&&e.jsx("div",{className:"flex justify-center mt-3",children:e.jsxs("button",{type:"button",onClick:()=>ne(!ie),className:"flex items-center gap-2 px-4 py-2 text-sm font-medium customtext-primary hover:bg-blue-50 rounded-lg transition-colors duration-200",children:[e.jsx("span",{children:ie?"Ver menos información":`Ver más información (${t.length-1} más)`}),e.jsx("svg",{className:`w-4 h-4 transition-transform duration-200 ${ie?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})})]})})()})]}),T==="store_pickup"&&tt&&e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsx(ft,{ubigeoCode:l.ubigeo,onStoreSelect:ot,selectedStore:qe,className:"border border-gray-200 rounded-xl p-4"}),r.store&&e.jsxs("div",{className:"text-red-500 text-sm mt-2 flex items-center gap-2",children:[e.jsx(ge,{className:"h-4 w-4"}),r.store]})]}),!V&&e.jsxs("div",{className:"flex flex-col md:flex-row justify-end gap-3 md:gap-4 mt-6",children:[e.jsx(Oe,{type:"button",onClick:()=>window.history.back(),className:"w-full md:w-auto",children:"Regresar"}),e.jsx(Fe,{type:"submit",loading:pe,className:"w-full md:w-auto",children:"Continuar"})]})]})}),e.jsxs("div",{className:"bg-[#F7F9FB] rounded-xl shadow-lg p-6 col-span-2 h-max",children:[e.jsx("h3",{className:"text-2xl font-bold pb-6",children:"Resumen"}),e.jsx("div",{className:"space-y-4 border-b-2 pb-6",children:N.map(t=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("img",{src:t.type==="combo"?`/storage/images/combo/${t.image}`:`/storage/images/item/${t.image}`,alt:t.name,className:"w-16 h-16 object-cover rounded-lg",onError:s=>s.target.src="/api/cover/thumbnail/null"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:t.name}),e.jsxs("p",{className:"text-sm customtext-neutral-dark",children:["Cantidad: ",t.quantity]}),e.jsxs("p",{className:"text-sm customtext-neutral-dark",children:[y(),j(t.final_price)]})]})]},t.id))}),e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:[y(),j(C(g))]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["IGV (",Number(((Ge=a==null?void 0:a.find(t=>t.correlative==="igv_checkout"))==null?void 0:Ge.description)||18),"%):"]}),e.jsxs("span",{children:[y(),j(C(U))]})]}),Number((Qe=a==null?void 0:a.find(t=>t.correlative==="importation_seguro"))==null?void 0:Qe.description)>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["Seguro (",Number(((Ke=a==null?void 0:a.find(t=>t.correlative==="importation_seguro"))==null?void 0:Ke.description)||0).toFixed(2),"%):"]}),e.jsxs("span",{children:[y(),j(C($))]})]}),Number((Ye=a==null?void 0:a.find(t=>t.correlative==="importation_derecho_arancelario"))==null?void 0:Ye.description)>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["Derecho arancelario",((Xe=a==null?void 0:a.find(t=>t.correlative==="importation_derecho_arancelario_descripcion"))==null?void 0:Xe.description)&&e.jsx(et,{content:e.jsx("p",{className:"whitespace-pre-line",children:(We=a==null?void 0:a.find(t=>t.correlative==="importation_derecho_arancelario_descripcion"))==null?void 0:We.description}),allowHTML:!0,children:e.jsx("i",{className:"mdi mdi-information ms-1"})})]}),e.jsxs("span",{children:[y(),j(C(W))]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Envío:"}),e.jsx("span",{className:"font-semibold",children:T==="free"||T==="store_pickup"||h===0?e.jsx("span",{className:"customtext-neutral-dark",children:"Gratis"}):`${y()} ${j(h)}`})]}),e.jsx("div",{className:"space-y-4 border-t pt-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"block text-sm font-medium customtext-neutral-dark",children:"¿Tienes un cupón de descuento?"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("input",{type:"text",placeholder:"Ingresa tu código de cupón",value:z,onChange:t=>_e(t.target.value.toUpperCase()),className:`w-full px-4 py-3 border customtext-neutral-dark  border-gray-100 rounded-xl focus:ring-0 focus:outline-0   transition-all duration-300 ${Te?"border-red-300 bg-red-50 text-red-900 focus:border-red-500 focus:ring-red-200":n?"border-gray-200 bg-white customtext-neutral-dark focus:ring-blue-200":" bg-white border-neutral-light focus:ring-0 focus:outline-0"} `,disabled:!!n||Ne}),Ne&&e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:e.jsx("div",{className:"w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"})})]}),n?e.jsx("button",{type:"button",onClick:lt,className:"px-4 py-3 bg-gray-200 customtext-neutral-dark text-sm rounded-xl hover:bg-gray-300 transition-colors duration-200",title:"Remover cupón",children:e.jsx(ge,{className:"h-4 w-4"})}):e.jsx("button",{type:"button",onClick:ct,disabled:Ne||!z.trim(),className:"px-6 py-3 bg-primary text-white text-sm font-medium rounded-xl hover:opacity-90 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all duration-200 whitespace-nowrap",children:Ne?"Validando...":"Aplicar"})]}),Te&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(ge,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{children:Te})]}),n&&e.jsx("div",{className:"bg-gray-50 border-2  rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 w-8/12",children:[e.jsx("div",{className:"w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})}),e.jsxs("div",{children:[e.jsxs("p",{className:"customtext-primary font-semibold text-sm",children:["Descto. ",n.type==="percentage"?`${n.value}%`:`${y()}${j(n.value)}`]}),e.jsx("p",{className:"customtext-primary text-xs mt-1",children:n.code})]})]}),e.jsx("div",{className:"text-right w-4/12",children:e.jsxs("span",{className:"customtext-primary font-bold text-base",children:["-",y(),j(C(ce))]})})]})})]})}),P&&P.length>0&&e.jsx("div",{className:"space-y-4 border-t pt-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium customtext-neutral-dark mb-2",children:"🎉 Descuentos automáticos aplicados:"}),P.map((t,s)=>e.jsx("div",{className:" border-2  rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 w-8/12",children:[e.jsx("div",{className:"w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})}),e.jsxs("div",{children:[e.jsx("p",{className:"customtext-neutral-dark font-semibold text-sm",children:t.name}),t.description&&e.jsx("p",{className:"customtext-neutral-dark text-xs mt-1",children:t.description})]})]}),e.jsx("div",{className:"text-right w-4/12",children:e.jsxs("span",{className:"customtext-neutral-dark font-bold text-base",children:["-",y(),j(t.amount)]})})]})},s)),H>0&&e.jsx("div",{className:"l p-3",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"customtext-neutral-dark font-semibold",children:"Total descuentos automáticos:"}),e.jsxs("span",{className:"customtext-neutral-dark font-bold text-lg",children:["-",y(),j(H)]})]})})]})}),e.jsx("div",{className:"pt-4 border-t-2",children:e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{children:[y(),j(C(Le))]})]})}),!te.CULQI_ENABLED&&e.jsx("div",{className:"mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ze,{className:"h-5 w-5 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800",children:"El procesamiento de pagos con tarjeta está temporalmente deshabilitado"})]})}),te.CULQI_ENABLED&&!te.CULQI_PUBLIC_KEY&&e.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ge,{className:"h-5 w-5 text-red-600 mr-2"}),e.jsx("span",{className:"text-sm text-red-800",children:"Error de configuración: Sistema de pagos no configurado"})]})}),e.jsx(Fe,{onClick:ze,disabled:ue||!te.CULQI_ENABLED||!te.CULQI_PUBLIC_KEY,loading:ue,className:`w-full mt-6 ${(f==null?void 0:f.class_button)||"text-white"} ${!te.CULQI_ENABLED||!te.CULQI_PUBLIC_KEY?"opacity-50 cursor-not-allowed":""}`,children:ue?"Procesando...":te.CULQI_ENABLED?te.CULQI_PUBLIC_KEY?`Pagar ${y()}${j(C(Le))}`:"Configuración pendiente":"Pago no disponible"}),e.jsx(Oe,{onClick:V,className:"w-full mt-3",disabled:ue,children:"Regresar al carrito"}),e.jsxs("p",{className:"text-xs md:text-sm customtext-neutral-dark",children:["Al realizar tu pedido, aceptas los ",e.jsx("a",{href:"#",onClick:()=>b(1),className:"customtext-primary font-bold",children:"Términos y Condiciones"}),", y que nosotros usaremos sus datos personales de acuerdo con nuestra ",e.jsx("a",{href:"#",onClick:()=>b(0),className:"customtext-primary font-bold",children:"Política de Privacidad"}),"."]})]})]})]})]})}function Et({cart:f,code:N,delivery:se,subTotal:Y,igv:O,fleteTotal:E=0,seguroImportacionTotal:X=0,derechoArancelarioTotal:V=0,totalFinal:g,couponDiscount:U=0,couponCode:de=null,conversionScripts:$=null,automaticDiscounts:W=[],automaticDiscountTotal:oe=0,generals:o}){var ee,G,me;console.log("ConfirmationStep - Props received:",{cart:f,cartLength:f==null?void 0:f.length,subTotal:Y,igv:O,totalFinal:g,delivery:se,couponDiscount:U,automaticDiscountTotal:oe,seguroImportacionTotal:X,derechoArancelarioTotal:V,fleteTotal:E});const J=f.reduce((a,_)=>a+(_.type==="combo"?_.final_price||_.price:_.final_price)*_.quantity,0),h=Y>0?Y:parseFloat((J/1.18).toFixed(2)),B=Y>0?O:parseFloat((J-h).toFixed(2)),b=f.reduce((a,_)=>{const F=parseFloat(_.weight)||0;return a+F*_.quantity},0),be=Number((ee=o==null?void 0:o.find(a=>a.correlative==="importation_flete"))==null?void 0:ee.description)||0,R=E>0?E:be>0?b*be:0,A=(Number((G=o==null?void 0:o.find(a=>a.correlative==="importation_seguro"))==null?void 0:G.description)||0)/100,P=X>0?X:h*A,H=parseFloat(h)+parseFloat(R)+parseFloat(P),Z=(Number((me=o==null?void 0:o.find(a=>a.correlative==="importation_derecho_arancelario"))==null?void 0:me.description)||0)/100,ye=V>0?V:H*Z,ae=h+B+(se||0)+P+ye-(U||0)-(oe||0);return console.log("ConfirmationStep - Debug totals:",{recalculatedTotal:J,passedSubTotal:Y,passedIgv:O,actualSubTotal:h,actualIgv:B,passedSeguro:X,actualSeguro:P,passedDerecho:V,actualDerecho:ye,passedTotalFinal:g,actualTotalFinal:ae,cart:f.map(a=>({name:a.name,type:a.type,price:a.price,final_price:a.final_price,quantity:a.quantity,weight:a.weight}))}),c.useEffect(()=>{if($){console.log("Executing conversion scripts...");try{if($.head){const a=document.createElement("script");a.innerHTML=$.head,document.head.appendChild(a)}if($.body){const a=document.createElement("script");a.innerHTML=$.body,document.body.appendChild(a)}console.log("Conversion scripts executed successfully")}catch(a){console.error("Error executing conversion scripts:",a)}}},[$]),e.jsx(we.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6},className:"mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-12",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl p-6 md:p-10",children:e.jsxs(we.div,{initial:{scale:.9},animate:{scale:1},transition:{delay:.3},className:"text-center space-y-6",children:[e.jsx(we.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",delay:.5},className:"w-20 h-20 bg-secondary rounded-full mx-auto flex items-center justify-center",children:e.jsx("span",{className:"text-4xl",children:"✓"})}),e.jsx("h2",{className:"text-2xl md:text-3xl customtext-neutral-light animate-bounce",children:"¡Gracias por tu compra! 🎉"}),e.jsx("p",{className:"customtext-neutral-dark text-3xl md:text-5xl font-bold",children:"Tu orden ha sido recibida"}),e.jsxs(we.div,{whileHover:{scale:1.05},className:"py-6 px-4 bg-secondary rounded-xl inline-block",children:[e.jsx("div",{className:"customtext-neutral-light",children:"Código de pedido"}),e.jsx("div",{className:"customtext-neutral-dark text-xl font-bold",children:`#${N}`})]}),e.jsxs("div",{className:"space-y-6 bg-[#F7F9FB] p-6 md:p-8 rounded-xl shadow-inner",children:[e.jsx("div",{className:"space-y-6 border-b-2 pb-6",children:f.map((a,_)=>{var re,Q;const F=()=>a.type==="combo"?a.final_price||a.price:a.final_price;return e.jsx(we.div,{initial:{x:-20,opacity:0},animate:{x:0,opacity:1},transition:{delay:_*.2},className:"bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow duration-300",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-6 items-center sm:items-start",children:[e.jsx("div",{className:"bg-gray-50 p-3 rounded-xl",children:e.jsx("img",{src:(a==null?void 0:a.type)==="combo"?`/storage/images/combo/${a==null?void 0:a.image}`:`/storage/images/item/${a==null?void 0:a.image}`,alt:a==null?void 0:a.name,className:"w-24 h-24 object-cover rounded-lg",onError:L=>L.target.src="/api/cover/thumbnail/null",loading:"lazy"})}),e.jsxs("div",{className:"text-center sm:text-left flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between mb-3",children:[e.jsxs("div",{className:"lg:w-8/12",children:[e.jsx("h3",{className:"font-semibold text-xl line-clamp-3 mb-2",children:a==null?void 0:a.name}),a.type==="combo"&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"mb-2",children:e.jsx("span",{className:"inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full",children:"COMBO"})}),e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Contiene:"}),e.jsx("div",{className:"mt-1",children:a.combo_items&&a.combo_items.length>0?a.combo_items.map((L,l)=>e.jsxs("div",{className:"text-xs text-gray-500",children:["• ",L.quantity||1,"x ",L.name]},l)):a.items&&a.items.length>0?a.items.map((L,l)=>e.jsxs("div",{className:"text-xs text-gray-500",children:["• ",L.quantity||1,"x ",L.name]},l)):e.jsx("span",{className:"text-xs text-gray-400",children:"Información de combo no disponible"})})]})]})]}),e.jsx("div",{className:"mt-2 sm:mt-0 text-center lg:text-right lg:w-4/12",children:e.jsxs("div",{className:"font-bold text-lg customtext-primary",children:[y(),j(F()*(a==null?void 0:a.quantity))]})})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[((re=a==null?void 0:a.brand)==null?void 0:re.name)&&e.jsxs("p",{className:"text-sm customtext-neutral-dark",children:["Marca: ",e.jsx("span",{className:"customtext-neutral-dark font-medium",children:((Q=a==null?void 0:a.brand)==null?void 0:Q.name)||"N/A"})]}),e.jsxs("p",{className:"text-sm customtext-neutral-dark",children:["Cantidad: ",e.jsx("span",{className:"customtext-neutral-dark font-medium",children:a==null?void 0:a.quantity})]}),(a==null?void 0:a.sku)&&e.jsxs("p",{className:"text-sm customtext-neutral-dark",children:["SKU: ",e.jsx("span",{className:"customtext-neutral-dark font-medium",children:(a==null?void 0:a.sku)||"N/A"})]})]})]})]})},_)})}),e.jsxs(we.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.8},className:"space-y-4 mt-6",children:[[{label:"Subtotal",value:h},{label:"IGV",value:B},...P>0?[{label:"Seguro de Importación",value:P}]:[],...ye>0?[{label:"Derecho Arancelario",value:ye}]:[],{label:"Envío",value:se}].map((a,_)=>e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsx("span",{className:"customtext-neutral-dark",children:a.label}),e.jsxs("span",{className:"font-semibold",children:[y(),j(a.value)]})]},_)),U>0&&de&&e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsxs("span",{className:"customtext-neutral-dark text-start",children:["Cupón: ",e.jsx("br",{className:"lg:hidden"}),e.jsxs("span",{className:"font-semibold text-xs lg:text-base",children:["(",de,")"]})]}),e.jsxs("span",{className:"font-semibold",children:["-",y(),j(U)]})]}),oe>0&&W.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold pb-4 md:pb-6 customtext-neutral-dark mb-2",children:"🎉 Descuentos aplicados:"}),W.map((a,_)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:[a.name,a.description&&e.jsx("span",{className:"text-xs font-semibold block",children:a.description})]}),e.jsxs("span",{className:"customtext-neutral-dark font-semibold",children:["-",y(),j(a.amount)]})]},_)),e.jsxs("div",{className:"flex justify-between text-sm font-semibold customtext-neutral-dark pt-1",children:[e.jsx("span",{children:"Total descuentos:"}),e.jsxs("span",{children:["-",y(),j(oe)]})]})]}),e.jsx("div",{className:"py-4 border-y-2 mt-6",children:e.jsxs("div",{className:"flex justify-between font-bold text-xl md:text-2xl items-center",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:[y(),j(ae)]})]})})]}),e.jsx(we.div,{className:"pt-6",whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsx(Fe,{href:"/catalogo",className:"w-full mx-auto md:w-auto text-white",children:"Seguir Comprando"})})]})]})})})}function _s({cart:f,setCart:N,user:se,ubigeos:Y=[],items:O,generals:E,data:X,categorias:V}){var ne,z,_e;const[g,U]=c.useState(1);c.useEffect(()=>{const n=f.filter(w=>w.type==="combo");console.log("🔍 CheckoutSteps cart changed:",{totalItems:f.length,combos:n.length,currentStep:g,cart:f.map(w=>({id:w.id,name:w.name,type:w.type,quantity:w.quantity,final_price:w.final_price,price:w.price}))}),n.length===0&&f.length===0&&console.warn("🚨 ALERT: Cart is empty - this might indicate combos were removed")},[f,g]);const de=n=>n.type==="combo"?n.final_price||n.price:n.final_price,$=f.reduce((n,w)=>{const ce=de(w);return n+ce*w.quantity},0);console.log(V,"eeeeeeeeeeee");const{trackCheckoutPageView:W,trackInitiateCheckout:oe,trackPurchase:o,resetTracking:J}=jt(),h=parseFloat(($/1.18).toFixed(2)),B=parseFloat(($-h).toFixed(2)),[b,be]=c.useState(0),R=f.reduce((n,w)=>{const ce=Number(w.weight)||0;return n+ce*w.quantity},0),A=Number((ne=E==null?void 0:E.find(n=>n.correlative==="importation_flete"))==null?void 0:ne.description)||0,P=A>0?R*A:0,H=(Number((z=E==null?void 0:E.find(n=>n.correlative==="importation_seguro"))==null?void 0:z.description)||0)/100,Z=h*H,ye=parseFloat(h)+parseFloat(P)+parseFloat(Z),ae=(Number((_e=E==null?void 0:E.find(n=>n.correlative==="importation_derecho_arancelario"))==null?void 0:_e.description)||0)/100,ee=ye*ae,[G,me]=c.useState(0),[a,_]=c.useState(null),[F,re]=c.useState([]),[Q,L]=c.useState(0),l=h+B+parseFloat(b)+parseFloat(Z)+parseFloat(ee),D=G+Q,pe=Math.max(0,l-D),[Se,ue]=c.useState([]),[xe,he]=c.useState([]),[ve,T]=c.useState([]),[fe,Ce]=c.useState(null);c.useEffect(()=>(W(g,f),()=>J()),[]),c.useEffect(()=>{W(g,f),g===2&&oe(f,pe)},[g]);const i=n=>{U(n),window.scrollTo({top:0,behavior:"smooth"})},r={privacy_policy:"Políticas de privacidad",terms_conditions:"Términos y condiciones",saleback_policy:"Políticas de devolucion y cambio"},[m,p]=c.useState(null),q=n=>p(n),ie=()=>p(null);return e.jsxs("div",{className:"min-h-screen bg-[#F7F9FB] py-4 md:py-12 px-2 sm:px-primary 2xl:px-0 2xl:max-w-7xl mx-auto",children:[e.jsxs("div",{className:"bg-white p-3 md:p-8 rounded-lg md:rounded-xl shadow-sm",children:[e.jsx("div",{className:"mb-4 md:mb-8",children:e.jsxs("div",{className:"flex items-center justify-between gap-1 md:gap-4 max-w-3xl mx-auto",children:[e.jsxs("div",{className:`flex flex-col items-center md:flex-row md:items-center gap-1 md:gap-2 ${g===1?"customtext-primary font-medium":"customtext-neutral-dark"}`,children:[e.jsx("span",{className:" bg-primary text-white w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs md:text-sm",children:"1"}),e.jsx("span",{className:"text-[10px] md:text-sm text-center",children:"Carrito"})]}),e.jsx("div",{className:"mb-4 lg:mb-0  flex-1 h-[2px] bg-gray-200 relative",children:e.jsx("div",{className:"absolute inset-0 bg-primary transition-all duration-500",style:{width:g>1?"100%":"0%"}})}),e.jsxs("div",{className:`flex flex-col items-center md:flex-row md:items-center gap-1 md:gap-2 ${g>1?"customtext-primary font-medium":"customtext-neutral-dark"}`,children:[e.jsx("span",{className:`w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs md:text-sm ${g>1?"bg-primary text-white":"bg-white customtext-primary"}`,children:"2"}),e.jsx("span",{className:"text-[10px] md:text-sm text-center",children:"Envío"})]}),e.jsx("div",{className:"mb-4 lg:mb-0  flex-1 h-[2px] bg-gray-200 relative",children:e.jsx("div",{className:"absolute inset-0 bg-primary transition-all duration-500",style:{width:g>2?"100%":"0%"}})}),e.jsxs("div",{className:`flex flex-col items-center md:flex-row md:items-center gap-1 md:gap-2 ${g===3?"customtext-primary  font-medium":"customtext-neutral-dark"}`,children:[e.jsx("span",{className:`w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs md:text-sm ${g===3?"bg-primary text-white":"bg-white customtext-primary"}`,children:"3"}),e.jsx("span",{className:"text-[10px] md:text-sm text-center",children:"Confirmación"})]})]})}),g===1&&e.jsx(_t,{data:X,cart:f,setCart:N,onContinue:()=>i(2),subTotal:h,envio:b,igv:B,fleteTotal:P,seguroImportacionTotal:Z,derechoArancelarioTotal:ee,totalFinal:pe,openModal:q,categorias:V,automaticDiscounts:F,setAutomaticDiscounts:re,automaticDiscountTotal:Q,setAutomaticDiscountTotal:L,totalWithoutDiscounts:l,generals:E}),g===2&&e.jsx(kt,{data:X,items:O,setCode:he,setDelivery:T,cart:f,setSale:ue,setCart:N,onContinue:()=>i(3),noContinue:()=>i(1),subTotal:h,envio:b,setEnvio:be,igv:B,fleteTotal:P,seguroImportacionTotal:Z,derechoArancelarioTotal:ee,totalFinal:pe,user:se,ubigeos:Y,categorias:V,openModal:q,setCouponDiscount:me,setCouponCode:_,automaticDiscounts:F,setAutomaticDiscounts:re,automaticDiscountTotal:Q,setAutomaticDiscountTotal:L,totalWithoutDiscounts:l,conversionScripts:fe,setConversionScripts:Ce,onPurchaseComplete:(n,w)=>{o(n,w)},generals:E}),g===3&&e.jsx(Et,{code:xe,delivery:ve,cart:Se,subTotal:h,envio:b,igv:B,fleteTotal:P,seguroImportacionTotal:Z,derechoArancelarioTotal:ee,totalFinal:pe,couponDiscount:G,couponCode:a,automaticDiscounts:F,automaticDiscountTotal:Q,totalWithoutDiscounts:l,conversionScripts:fe,setConversionScripts:Ce,onPurchaseComplete:(n,w)=>{o(n,w)},generals:E})]}),Object.keys(r).map((n,w)=>{var Ne;const ce=r[n],ke=((Ne=E.find(Ie=>Ie.correlative==n))==null?void 0:Ne.description)??"";return e.jsx(wt,{isOpen:m===w,onRequestClose:ie,contentLabel:ce,className:"fixed top-0 left-0 right-0 bottom-0 flex items-center justify-center p-4 z-50",overlayClassName:"fixed inset-0 bg-black bg-opacity-50 z-[999]",ariaHideApp:!1,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 pr-4",children:ce}),e.jsx("button",{onClick:ie,className:"flex-shrink-0 text-gray-400 hover:text-red-500 transition-colors duration-200 p-1 hover:bg-gray-100 rounded-full","aria-label":"Cerrar modal",children:e.jsx(Ct,{size:24,strokeWidth:2})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:e.jsx("div",{className:"prose prose-gray max-w-none",children:e.jsx(St,{html:ke})})}),e.jsx("div",{className:"flex justify-end p-6 border-t border-gray-200",children:e.jsx("button",{onClick:ie,className:"px-6 py-2 bg-primary text-white rounded-lg  transition-colors duration-200 font-medium",children:"Cerrar"})})]})},w)})]})}export{_s as default};
