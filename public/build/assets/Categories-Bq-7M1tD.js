var J=Object.defineProperty;var L=(m,g,p)=>g in m?J(m,g,{enumerable:!0,configurable:!0,writable:!0,value:p}):m[g]=p;var T=(m,g,p)=>L(m,typeof g!="symbol"?g+"":g,p);import{j as t}from"./AboutSimple-Cf8x2fCZ.js";import{B as z}from"./Base-GfEhzAjp.js";import{S as O}from"./SwitchFormGroup-DXN0cwVk.js";import{T as P}from"./TextareaFormGroup-CliirJM1.js";import{r as h}from"./index-BOnQTV8N.js";import{c as q}from"./ReactAppend-QR5TrZfj.js";import{S as A}from"./ProductCard-D9l7c7at.js";import{B as H}from"./BasicRest-BML1C-ua.js";import{I as _}from"./ImageFormGroup-40MuGzez.js";import{P as U}from"./plus-CTIomuuF.js";import{I as K}from"./image-BPmHvEaV.js";import{M as Q,a as W}from"./move-up-Gz4AiwKb.js";import{T as X}from"./trash-2-DU7LB6-f.js";import{S as Y}from"./SelectAPIFormGroup-BZe8H0Ph.js";import{M as Z}from"./Modal-xDw9ufjg.js";import{T as ee}from"./Table-Cv1BshIS.js";import{D as M}from"./DxButton-DV0H-ZcL.js";import{C as te,F as R,h as se}from"./CreateReactScript-Bqovr-Zn.js";import{R as S}from"./ReactAppend-Vm5G2nof.js";import{B as v}from"./BooleanLimit-D-OsQsek.js";import{I as V}from"./InputFormGroup-iZIO11ZN.js";import{S as re}from"./SetSelectValue-UxyCmHse.js";import"./index-yBjzXJbu.js";import"./Global-CazroCzF.js";import"./tippy-react.esm-DmkRJDEW.js";import"./index-pSueRYGM.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./index-B6ujFmsw.js";/* empty css              */import"./Logout-BpuTJ_83.js";import"./main-B6F2O9-U.js";import"./___vite-browser-external_commonjs-proxy-DDYoOVPM.js";import"./MenuItemContainer-DcxtOi47.js";import"./index.esm-C48oHfFw.js";import"./index-ngrFHoWO.js";import"./CanAccess-BlvzCYjQ.js";import"./CardProductKatya-ncpmQ0JU.js";import"./createLucideIcon-DfjclApS.js";/* empty css               */import"./General-apRuNwp7.js";import"./LaravelSession-Dz9cpV3l.js";class ne extends H{constructor(){super(...arguments);T(this,"path","admin/categories");T(this,"hasFiles",!0)}}const G=h.forwardRef(({name:m="banners",label:g="Banners",initialValue:p=[],model:D="category"},B)=>{const[u,j]=h.useState([]),[c,d]=h.useState({}),i=h.useRef({});h.useImperativeHandle(B,()=>({getValue:()=>JSON.stringify(u),setValue:s=>{console.log("BannersJsonEditor.setValue called with:",s,"type:",typeof s);try{const r=typeof s=="string"?JSON.parse(s):s;if(console.log("Parsed value:",r,"is array:",Array.isArray(r)),j(Array.isArray(r)?r:[]),console.log("setBanners called, should trigger re-render"),Array.isArray(r)&&r.length>0){const o={};r.forEach((e,n)=>{o[n]=!0}),d(o)}}catch(r){console.error("Error setting banners:",r),j([])}},reset:()=>{j([]),i.current={}},getImageRefs:()=>i.current,getImageFiles:()=>{const s={};return console.log("getImageFiles - imageRefs.current:",i.current),Object.keys(i.current).forEach(r=>{var e,n;const o=i.current[r];console.log(`getImageFiles - index ${r}:`,o),(n=(e=o==null?void 0:o.current)==null?void 0:e.files)!=null&&n[0]&&(s[`banner_image_${r}`]=o.current.files[0],console.log(`getImageFiles - Added file for banner_image_${r}:`,o.current.files[0].name))}),console.log("getImageFiles - Final files object:",s),s}}));const F=()=>{const s={image:"",title:"",description:"",button_text:"",button_link:""},r=[...u,s];j(r),d({...c,[r.length-1]:!0}),i.current[r.length-1]={current:null}},k=async s=>{const{isConfirmed:r}=await A.fire({title:"¿Eliminar banner?",text:"Esta acción no se puede deshacer",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});if(r){const o=u.filter((a,l)=>l!==s);j(o),delete i.current[s];const e={};Object.keys(i.current).forEach(a=>{const l=parseInt(a);l>s?e[l-1]=i.current[a]:l<s&&(e[l]=i.current[a])}),i.current=e;const n={};Object.keys(c).forEach(a=>{const l=parseInt(a);l<s?n[l]=c[a]:l>s&&(n[l-1]=c[a])}),d(n)}},C=(s,r)=>{const o=r==="up"?s-1:s+1;if(o<0||o>=u.length)return;const e=[...u];[e[s],e[o]]=[e[o],e[s]],j(e);const n=i.current[s];i.current[s]=i.current[o],i.current[o]=n;const a=c[s],l=c[o];d({...c,[s]:l,[o]:a})},w=(s,r,o)=>{const e=[...u];e[s]={...e[s],[r]:o},j(e)},I=s=>{d({...c,[s]:!c[s]})};return t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"font-weight-bold mb-2",children:g}),t.jsxs("div",{className:"border rounded p-3 bg-light",children:[t.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[t.jsxs("small",{className:"text-muted",children:[u.length," banner",u.length!==1?"s":""," configurado",u.length!==1?"s":""]}),t.jsxs("button",{type:"button",className:"btn btn-sm btn-primary",onClick:F,children:[t.jsx(U,{size:16,className:"mr-1"}),"Agregar Banner"]})]}),u.length===0?t.jsxs("div",{className:"text-center py-4 text-muted",children:[t.jsx(K,{size:48,className:"mb-2 opacity-50",style:{display:"block",margin:"0 auto"}}),t.jsx("p",{className:"mb-0",children:"No hay banners configurados"}),t.jsx("small",{children:'Haz clic en "Agregar Banner" para comenzar'})]}):t.jsx("div",{className:"space-y-2",children:u.map((s,r)=>t.jsxs("div",{className:"card mb-2 shadow-sm",children:[t.jsxs("div",{className:"card-header bg-white d-flex justify-content-between align-items-center p-2",children:[t.jsxs("button",{type:"button",className:"btn btn-link text-left flex-grow-1 text-decoration-none p-2",onClick:()=>I(r),children:[t.jsxs("strong",{children:["Banner ",r+1]}),s.title&&t.jsxs("small",{className:"text-muted ml-2",children:["- ",s.title]})]}),t.jsxs("div",{className:"d-flex gap-1",children:[r>0&&t.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>C(r,"up"),title:"Mover arriba",children:t.jsx(Q,{size:14})}),r<u.length-1&&t.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>C(r,"down"),title:"Mover abajo",children:t.jsx(W,{size:14})}),t.jsx("button",{type:"button",className:"btn btn-sm btn-outline-danger",onClick:()=>k(r),title:"Eliminar",children:t.jsx(X,{size:14})})]})]}),c[r]&&t.jsx("div",{className:"card-body p-3",children:t.jsxs("div",{className:"row",children:[t.jsxs("div",{className:"col-12 mb-3",children:[t.jsx(_,{eRef:(i.current[r]||(i.current[r]={current:null}),i.current[r]),name:`banner_image_${r}`,label:"Imagen del Banner",col:"col-12",aspect:16/9,onChange:o=>{if(o.target.files&&o.target.files[0]){const e=o.target.files[0];w(r,"image",e.name)}}}),s.image&&t.jsxs("small",{className:"text-muted d-block mt-2",children:["Archivo actual: ",t.jsx("strong",{children:s.image})]})]}),t.jsxs("div",{className:"col-12 mb-3",children:[t.jsx("label",{className:"font-weight-semibold small",children:"Título"}),t.jsx("input",{type:"text",className:"form-control form-control-sm",placeholder:"Título del banner",value:s.title||"",onChange:o=>w(r,"title",o.target.value)})]}),t.jsxs("div",{className:"col-12 mb-3",children:[t.jsx("label",{className:"font-weight-semibold small",children:"Descripción"}),t.jsx("textarea",{className:"form-control form-control-sm",rows:"3",placeholder:"Descripción del banner",value:s.description||"",onChange:o=>w(r,"description",o.target.value)})]}),t.jsxs("div",{className:"col-md-6 mb-3",children:[t.jsx("label",{className:"font-weight-semibold small",children:"Texto del Botón"}),t.jsx("input",{type:"text",className:"form-control form-control-sm",placeholder:"Ver más",value:s.button_text||"",onChange:o=>w(r,"button_text",o.target.value)})]}),t.jsxs("div",{className:"col-md-6 mb-3",children:[t.jsx("label",{className:"font-weight-semibold small",children:"Link del Botón"}),t.jsx("input",{type:"text",className:"form-control form-control-sm",placeholder:"/ruta-destino",value:s.button_link||"",onChange:o=>w(r,"button_link",o.target.value)})]})]})})]},`banner-${r}-${s.image||"new"}`))})]}),t.jsx("input",{type:"hidden",name:m,value:JSON.stringify(u)})]})});G.displayName="BannersJsonEditor";const E=new ne,ae=()=>{const m=h.useRef(),g=h.useRef(),p="categories",D=h.useRef(),B=h.useRef(),u=h.useRef(),j=h.useRef(),c=h.useRef(),d=h.useRef(),i=h.useRef(),F=h.useRef(),[k,C]=h.useState(!1),w=e=>{if(console.log("=== onModalOpen called ==="),console.log("Full data object:",e),console.log("data.banners specifically:",e==null?void 0:e.banners),console.log("typeof data.banners:",typeof(e==null?void 0:e.banners)),e!=null&&e.id?C(!0):C(!1),D.current.value=(e==null?void 0:e.id)??"",B.current.value=(e==null?void 0:e.name)??"",u.current.value=(e==null?void 0:e.alias)??"",j.current.value=(e==null?void 0:e.description)??"",c.image.src=e!=null&&e.banner?`/storage/images/category/${e.banner}`:"",c.current.value=null,d.image.src=e!=null&&e.image?`/storage/images/category/${e.image}`:"",d.current.value=null,i.current){let n=(e==null?void 0:e.banners)||[];if(console.log("Categories.onModalOpen - data.banners:",e==null?void 0:e.banners),console.log("Categories.onModalOpen - banners type:",typeof n),typeof n=="string")try{n=JSON.parse(n)}catch(l){console.error("Error parsing banners JSON:",l),n=[]}console.log("Categories.onModalOpen - calling setValue with:",n),i.current.setValue(n);const a=(l=1)=>{console.log(`Attempt ${l} to load banner images...`);const f=i.current.getImageRefs();console.log("imageRefs:",f);let y=!0;n.forEach((N,b)=>{if(N.image){const x=f[b];console.log(`Banner ${b} - Full ref:`,x),console.log(`Banner ${b} - imgRef.image:`,x==null?void 0:x.image),console.log(`Banner ${b} - All properties:`,Object.keys(x||{})),x!=null&&x.image?(x.image.src=`/storage/images/category/${N.image}`,console.log(`✓ Loaded image for banner ${b}:`,N.image)):(y=!1,console.log(`✗ Ref not ready for banner ${b}`))}}),!y&&l<5&&setTimeout(()=>a(l+1),300)};setTimeout(()=>a(),500)}re(F.current,(e==null?void 0:e.stores)??[],"id","name"),c.resetDeleteFlag&&c.resetDeleteFlag(),d.resetDeleteFlag&&d.resetDeleteFlag(),$(g.current).modal("show")},I=async e=>{e.preventDefault();const n={id:D.current.value||void 0,name:B.current.value,alias:u.current.value,description:j.current.value},a=new FormData;for(const b in n)a.append(b,n[b]);const l=d.current.files[0];l&&a.append("image",l);const f=c.current.files[0];if(f&&a.append("banner",f),i.current){a.append("banners",i.current.getValue());const b=i.current.getImageFiles();Object.keys(b).forEach(x=>{a.append(x,b[x])})}const y=$(F.current).val();y&&y.length>0?a.append("stores",JSON.stringify(y)):a.append("stores",JSON.stringify([])),c.getDeleteFlag&&c.getDeleteFlag()&&a.append("banner_delete","DELETE"),d.getDeleteFlag&&d.getDeleteFlag()&&a.append("image_delete","DELETE");for(let[b,x]of a.entries());await E.save(a)&&(c.resetDeleteFlag&&c.resetDeleteFlag(),d.resetDeleteFlag&&d.resetDeleteFlag(),$(m.current).dxDataGrid("instance").refresh(),$(g.current).modal("hide"))},s=async({id:e,value:n,previous:a})=>{if(n&&v.shouldBlock(p,"featured",a)){const f=v.get(p,"featured");let N=(f==null?void 0:f.message)??"Se alcanzó el límite de categorías destacadas.";f&&(N+=` Actualmente hay ${f.active??0} de ${f.max??0} categorías activas.`,se("Root")&&f.general_key&&(N+=` Puedes ajustar el límite en Generales usando la clave ${f.general_key}.`)),A.fire({icon:"warning",title:"Límite alcanzado",text:N});return}const l=await E.boolean({id:e,field:"featured",value:n});l&&(v.has(p,"featured")&&(typeof l=="object"&&(l!=null&&l.limit)?v.updateFromServer(p,l):v.applyChange(p,"featured",{previous:a,next:n})),$(m.current).dxDataGrid("instance").refresh())},r=async({id:e,value:n})=>{await E.boolean({id:e,field:"visible",value:n})&&$(m.current).dxDataGrid("instance").refresh()},o=async e=>{const{isConfirmed:n}=await A.fire({title:"Eliminar registro",text:"¿Estas seguro de eliminar este registro?",icon:"warning",showCancelButton:!0,confirmButtonText:"Si, eliminar",cancelButtonText:"Cancelar"});!n||!await E.delete(e.id)||(v.has(p,"featured")&&e.featured&&v.applyChange(p,"featured",{previous:!0,next:!1}),$(m.current).dxDataGrid("instance").refresh())};return t.jsxs(t.Fragment,{children:[t.jsx(ee,{gridRef:m,title:"Categorías",rest:E,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(m.current).dxDataGrid("instance").refresh()}}),e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",text:"Nuevo registro",hint:"Nuevo registro",onClick:()=>w()}})},columns:[{dataField:"id",caption:"ID",visible:!1},{dataField:"name",caption:"Categoría",width:"30%"},{dataField:"description",caption:"Descripción",width:"50%"},R.has("categories","image")&&{dataField:"image",caption:"Imagen",width:"90px",allowFiltering:!1,cellTemplate:(e,{data:n})=>{S(e,t.jsx("img",{src:`/storage/images/category/${n.image}`,style:{width:"80px",height:"48px",objectFit:"cover",objectPosition:"center",borderRadius:"4px"},onError:a=>a.target.src="/api/cover/thumbnail/null"}))}},R.has("categories","banner")&&{dataField:"banner",caption:"Banner",width:"90px",allowFiltering:!1,cellTemplate:(e,{data:n})=>{S(e,t.jsx("img",{src:`/storage/images/category/${n.banner}`,style:{width:"80px",height:"48px",objectFit:"cover",objectPosition:"center",borderRadius:"4px"},onError:a=>a.target.src="/api/cover/thumbnail/null"}))}},{dataField:"featured",caption:"Destacado",dataType:"boolean",cellTemplate:(e,{data:n})=>{$(e).empty();const a=n.featured==1,f=v.has(p,"featured")&&v.shouldBlock(p,"featured",a),y=f?v.getMessage(p,"featured"):null;y?$(e).attr("title",y):$(e).removeAttr("title"),S(e,t.jsx(O,{checked:a,disabled:f,onChange:()=>s({id:n.id,value:!a,previous:a})}))}},{dataField:"visible",caption:"Visible",dataType:"boolean",cellTemplate:(e,{data:n})=>{$(e).empty(),S(e,t.jsx(O,{checked:n.visible==1,onChange:()=>r({id:n.id,value:!n.visible})}))}},{caption:"Acciones",cellTemplate:(e,{data:n})=>{e.css("text-overflow","unset"),e.append(M({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>w(n)})),e.append(M({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash",onClick:()=>o(n)}))},allowFiltering:!1,allowExporting:!1}]}),t.jsxs(Z,{modalRef:g,title:k?"Editar categoría":"Agregar categoría",onSubmit:I,children:[t.jsx("input",{ref:D,type:"hidden"}),t.jsxs("div",{className:"row",id:"categories-container",children:[t.jsxs("div",{className:!R.has("categories","banner")&&!R.has("categories","image")?"hidden":"col-md-6",children:[t.jsx(_,{eRef:c,name:"banner",label:"Banner",col:"col-12",aspect:3/1,hidden:!R.has("categories","banner")}),t.jsx(_,{eRef:d,name:"image",label:"Imagen",col:"col-12",aspect:16/9,hidden:!R.has("categories","image")})]}),t.jsxs("div",{className:!R.has("categories","banner")&&!R.has("categories","image")?"col-md-12":"col-md-6",children:[t.jsx(V,{eRef:B,label:"Categoría",rows:2,required:!0}),t.jsx(V,{eRef:u,label:"Alias (Nombre para mostrar)",col:"col-12"}),t.jsx(P,{eRef:j,label:"Descripción",rows:3})]}),t.jsx("div",{className:"col-12 mt-3",children:t.jsx(G,{ref:i,name:"banners",label:"Banners del Catálogo",initialValue:[],model:"category"})}),t.jsx("div",{className:"col-12 mt-3",children:t.jsx(Y,{id:"stores",eRef:F,searchAPI:"/api/admin/stores/paginate",searchBy:"name",label:"Ubicaciones (Stores)",dropdownParent:"#categories-container",tags:!0,multiple:!0})})]})]})]})};te((m,g)=>{q.createRoot(m).render(t.jsx(z,{...g,title:"Categorías",children:t.jsx(ae,{...g})}))});
