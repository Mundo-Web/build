import{j as t}from"./AboutSimple-Cf8x2fCZ.js";import{r as o}from"./index-BH53Isel.js";import{c as Le}from"./ReactAppend-DTVVXReZ.js";import{B as Oe}from"./Base-DhUmgPjL.js";import{C as Qe}from"./CreateReactScript-Bq8gMpEh.js";import{T as ze}from"./Table-DitbKwtZ.js";import{I as d}from"./InputFormGroup-D5I6zpZc.js";import{R as ve}from"./ReactAppend-D7S498fx.js";import{D as oe}from"./DxButton-DV0H-ZcL.js";import{S as L}from"./SwitchFormGroup-CGYpv_4Q.js";import{S as ce}from"./SelectFormGroup-YqB1XVb8.js";import{S as E}from"./SelectAPIFormGroup-BYWbn4kr.js";import{T as Je}from"./TextareaFormGroup-DVzYJtLM.js";import{M as je}from"./Modal-CIqmjseY.js";import{S as p}from"./ProductCard-Ap6bpF1Q.js";import{B as He}from"./BasicRest-B3rfI5GY.js";import{m as O}from"./main-BvVILmTO.js";import{s as Q}from"./server.browser-Bf4gQIc7.js";import{S as z}from"./SetSelectValue-UxyCmHse.js";import"./index-yBjzXJbu.js";import"./index-fNjTmf9T.js";import"./Global-ErywZRdd.js";import"./tippy-react.esm-BWiGTO87.js";import"./index-rimy3MAc.js";/* empty css              */import"./Logout-7s5dsuEK.js";import"./MenuItemContainer-BwGvRAHs.js";import"./index.esm-CveLAcri.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";/* empty css               */import"./General-BmbBKdsB.js";import"./LaravelSession-Dz9cpV3l.js";import"./index-CMHsc23u.js";class Ye extends He{constructor(){super(),this.path="admin/discount-rules"}async toggleActive(n,l){try{const{status:a,result:_}=await O.Fetch(`/api/${this.path}/${n}/toggle-active`,{method:"PATCH",body:JSON.stringify({active:l})});if(!a)throw new Error((_==null?void 0:_.message)||"Error toggling active status");return _}catch(a){return console.error("Error toggling active status:",a),!1}}async duplicate(n){try{const{status:l,result:a}=await O.Fetch(`/api/${this.path}/${n}/duplicate`,{method:"POST"});if(!l)throw new Error((a==null?void 0:a.message)||"Error duplicating rule");return a}catch(l){return console.error("Error duplicating rule:",l),!1}}async getProducts(){try{const n=await this.simpleGet(`/api/${this.path}/products`);return(n==null?void 0:n.data)||n||[]}catch(n){return console.error("Error fetching products:",n),[]}}async getCategories(){try{const n=await this.simpleGet(`/api/${this.path}/categories`);return(n==null?void 0:n.data)||n||[]}catch(n){return console.error("Error fetching categories:",n),[]}}async getProductsByIds(n){try{if(!n||n.length===0)return[];console.log("Fetching products by IDs:",n);const{status:l,result:a}=await O.Fetch(`/api/${this.path}/products/by-ids`,{method:"POST",body:JSON.stringify({ids:n})});if(!l)throw new Error((a==null?void 0:a.message)||"Error fetching products by IDs");return console.log("Products fetched by IDs result:",a),(a==null?void 0:a.data)||a||[]}catch(l){return console.error("Error fetching products by ids:",l),[]}}async getCategoriesByIds(n){try{if(!n||n.length===0)return[];console.log("Fetching categories by IDs:",n);const{status:l,result:a}=await O.Fetch(`/api/${this.path}/categories/by-ids`,{method:"POST",body:JSON.stringify({ids:n})});if(!l)throw new Error((a==null?void 0:a.message)||"Error fetching categories by IDs");return console.log("Categories fetched by IDs result:",a),(a==null?void 0:a.data)||a||[]}catch(l){return console.error("Error fetching categories by ids:",l),[]}}async getRuleTypes(){try{const n=await this.simpleGet(`/api/${this.path}/rule-types`);return(n==null?void 0:n.data)||n||{}}catch(n){return console.error("Error fetching rule types:",n),{}}}async getUsageStats(n){try{return await this.simpleGet(`/api/${this.path}/${n}/usage-stats`)}catch(l){return console.error("Error fetching usage stats:",l),null}}}const g=new Ye,Ue=({})=>{var ge,he,ye;const y=o.useRef(),n=o.useRef(),l=o.useRef(),a=o.useRef(),_=o.useRef(),J=o.useRef(),P=o.useRef(),V=o.useRef(),H=o.useRef(),Y=o.useRef(),U=o.useRef(),X=o.useRef(),K=o.useRef(),W=o.useRef(),Z=o.useRef(),R=o.useRef(),F=o.useRef(),q=o.useRef(),w=o.useRef(),A=o.useRef(),C=o.useRef(),S=o.useRef(),x=o.useRef(),N=o.useRef(),I=o.useRef(),D=o.useRef(),T=o.useRef(),[ee,ae]=o.useState(!1),[Xe,le]=o.useState(null),[k,Re]=o.useState({}),[Ke,qe]=o.useState([]),[We,we]=o.useState([]),[h,b]=o.useState({}),[u,v]=o.useState({}),[f,ue]=o.useState(""),de=e=>{const r=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),c=String(e.getHours()).padStart(2,"0"),m=String(e.getMinutes()).padStart(2,"0");return`${r}-${s}-${i}T${c}:${m}`},me=e=>{const r=new Date(e),s=String(r.getDate()).padStart(2,"0"),i=String(r.getMonth()+1).padStart(2,"0"),c=String(r.getFullYear()).slice(-2),m=String(r.getHours()).padStart(2,"0"),j=String(r.getMinutes()).padStart(2,"0");return`${s}/${i}/${c} ${m}:${j}`},pe=e=>({quantity_discount:{conditions:{min_quantity:2,product_ids:[],category_ids:[]},actions:{discount_type:"percentage",discount_value:10}},cart_discount:{conditions:{min_amount:100,currency:"PEN"},actions:{discount_type:"percentage",discount_value:10}},buy_x_get_y:{conditions:{buy_quantity:2,product_ids:[]},actions:{get_quantity:1,discount_type:"fixed",discount_value:0}},category_discount:{conditions:{category_ids:[],min_quantity:1},actions:{discount_type:"percentage",discount_value:15}},tiered_discount:{conditions:{tiers:[{min_quantity:3,max_quantity:5},{min_quantity:6,max_quantity:10},{min_quantity:11,max_quantity:null}]},actions:{tier_discounts:[{discount_type:"percentage",discount_value:5},{discount_type:"percentage",discount_value:10},{discount_type:"percentage",discount_value:15}]}},bundle_discount:{conditions:{required_products:[],min_quantity_each:1},actions:{discount_type:"percentage",discount_value:25}}})[e]||{conditions:{min_quantity:1},actions:{discount_type:"percentage",discount_value:10}},$e=e=>{if(ue(e),e){const r=pe(e);b(r.conditions),v(r.actions)}else b({}),v({})};o.useEffect(()=>{Ce()},[]);const Ce=async()=>{const[e,r,s]=await Promise.all([g.getRuleTypes(),g.getProducts(),g.getCategories()]);Re(e),qe(r),we(s)},fe=e=>{e!=null&&e.id?(ae(!0),le(e)):(ae(!1),le(null)),a.current.value=(e==null?void 0:e.id)??"",_.current.value=(e==null?void 0:e.name)??"",J.current.value=(e==null?void 0:e.description)??"";const r=(e==null?void 0:e.rule_type)??"";if(ue(r),P.current&&($(P.current).val(r).trigger("change"),$(P.current).off("change.ruleType").on("change.ruleType",function(){const s=$(this).val();$e(s)})),H.current.value=(e==null?void 0:e.priority)??0,Y.current.value=e!=null&&e.starts_at?de(new Date(e.starts_at)):"",U.current.value=e!=null&&e.ends_at?de(new Date(e.ends_at)):"",X.current.value=(e==null?void 0:e.usage_limit)??"",K.current.value=(e==null?void 0:e.usage_limit_per_customer)??"",(e==null?void 0:e.active)!==void 0?$(V.current).prop("checked",e.active).trigger("change"):$(V.current).prop("checked",!0).trigger("change"),$(W.current).prop("checked",(e==null?void 0:e.combinable)??!1).trigger("change"),$(Z.current).prop("checked",(e==null?void 0:e.stop_further_rules)??!1).trigger("change"),console.log("Datos recibidos en onModalOpen:",{dataConditions:e==null?void 0:e.conditions,dataActions:e==null?void 0:e.actions,ruleType:r}),e!=null&&e.conditions||e!=null&&e.actions){const s=typeof e.conditions=="string"?JSON.parse(e.conditions):e.conditions||{},i=typeof e.actions=="string"?JSON.parse(e.actions):e.actions||{};console.log("Conditions y actions parseados:",{parsedConditions:s,parsedActions:i}),b(s),v(i)}else if(r){const s=pe(r);b(s.conditions),v(s.actions)}else b({}),v({});$(n.current).modal("show")},Se=async e=>{if(e.preventDefault(),!se())return;const r={id:a.current.value||void 0,name:_.current.value,description:J.current.value,rule_type:$(P.current).val(),active:V.current.checked,priority:parseInt(H.current.value)||0,starts_at:Y.current.value||null,ends_at:U.current.value||null,usage_limit:parseInt(X.current.value)||null,usage_limit_per_customer:parseInt(K.current.value)||null,combinable:W.current.checked,stop_further_rules:Z.current.checked,conditions:h,actions:u};await g.save(r)&&($(y.current).dxDataGrid("instance").refresh(),$(n.current).modal("hide"),p.fire({icon:"success",title:"¡Guardado!",text:ee?"La regla ha sido actualizada correctamente":"La nueva regla ha sido creada correctamente",timer:2e3,showConfirmButton:!1}))},Ne=async({id:e,value:r})=>{await g.toggleActive(e,r)&&$(y.current).dxDataGrid("instance").refresh()},Te=async e=>{await g.duplicate(e)&&$(y.current).dxDataGrid("instance").refresh()},Ee=async e=>{const{isConfirmed:r}=await p.fire({title:"Eliminar regla de descuento",text:"¿Estás seguro de eliminar esta regla?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});!r||!await g.delete(e)||$(y.current).dxDataGrid("instance").refresh()},Pe=()=>{console.log("Abriendo modal de condiciones...",{isEditing:ee,conditions:h,actions:u}),$(l.current).modal("show"),(Object.keys(h).length>0||Object.keys(u).length>0)&&(console.log("Regla con datos existentes detectada, cargando valores..."),$(l.current).one("shown.bs.modal",()=>{console.log("Modal completamente visible, cargando valores..."),setTimeout(()=>{Ie({conditions:h,actions:u})},500)}))},Fe=e=>{const r=e.status||"Activa";return`<span class="badge badge-${{Activa:"success",Inactiva:"secondary",Programada:"info",Expirada:"warning",Agotada:"danger"}[r]||"secondary"}">${r}</span>`},Ae=e=>{const r=e.conditions||{},s=e.actions||{};let i=e.description||"";return e.rule_type==="quantity_discount"&&r.min_quantity&&s.discount_value?i=`Compra ${r.min_quantity}+ items → ${s.discount_value}${s.discount_type==="percentage"?"%":" soles"} desc.`:e.rule_type==="cart_discount"&&r.min_amount&&s.discount_value?i=`Compras desde S/${r.min_amount} → ${s.discount_value}${s.discount_type==="percentage"?"%":" soles"} desc.`:e.rule_type==="buy_x_get_y"&&r.buy_quantity&&s.get_quantity&&(i=`Compra ${r.buy_quantity} lleva ${s.get_quantity} gratis`),i},G=(e,r)=>{b(s=>({...s,[e]:r}))},te=(e,r)=>{v(s=>({...s,[e]:r}))},re=()=>{const e={conditions:{},actions:{}};if(R.current&&(e.conditions.min_quantity=parseInt(R.current.value)||1),F.current&&(e.conditions.min_amount=parseFloat(F.current.value)||0),q.current&&(e.conditions.buy_quantity=parseInt(q.current.value)||1),A.current&&(e.conditions.min_quantity_each=parseInt(A.current.value)||1),x.current){const r=$(x.current).val();e.conditions.product_ids=r||[]}if(N.current){const r=$(N.current).val();e.conditions.category_ids=r||[]}if(I.current){const r=$(I.current).val();e.conditions.required_products=r||[]}if(C.current&&(e.actions.discount_type=C.current.value),S.current&&(e.actions.discount_value=parseFloat(S.current.value)||0),D.current&&(e.actions.max_discount=parseFloat(D.current.value)||null),w.current&&(e.actions.get_quantity=parseInt(w.current.value)||1),T.current){const r=$(T.current).val();e.actions.free_product_ids=r||[]}return e},Ie=e=>{const r=e.conditions||{},s=e.actions||{};console.log("setFieldValues ejecutándose con:",{conditionsData:r,actionsData:s,selectedRuleType:f,refs:{buyQuantityRef:q.current,productIdsRef:x.current,getQuantityRef:w.current,freeProductIdsRef:T.current}}),R.current&&(R.current.value=r.min_quantity||"",console.log("Cantidad mínima establecida:",r.min_quantity)),F.current&&(F.current.value=r.min_amount||"",console.log("Monto mínimo establecido:",r.min_amount)),q.current&&(q.current.value=r.buy_quantity||"",console.log("Cantidad compra establecida:",r.buy_quantity)),A.current&&(A.current.value=r.min_quantity_each||""),C.current&&(C.current.value=s.discount_type||"percentage",console.log("Tipo descuento establecido:",s.discount_type)),S.current&&(S.current.value=s.discount_value||"",console.log("Valor descuento establecido:",s.discount_value)),D.current&&(D.current.value=s.max_discount||""),w.current&&(w.current.value=s.get_quantity||"",console.log("Cantidad gratis establecida:",s.get_quantity));const i=async()=>{console.log("Estableciendo valores de selects con SetSelectValue...");try{if(x.current&&r.product_ids&&Array.isArray(r.product_ids)&&r.product_ids.length>0){console.log("Cargando productos para establecer:",r.product_ids);const c=await g.getProductsByIds(r.product_ids);console.log("Productos cargados:",c),z(x.current,c,"id","name")}if(N.current&&r.category_ids&&Array.isArray(r.category_ids)&&r.category_ids.length>0){console.log("Cargando categorías para establecer:",r.category_ids);const c=await g.getCategoriesByIds(r.category_ids);console.log("Categorías cargadas:",c),z(N.current,c,"id","name")}if(I.current&&r.required_products&&Array.isArray(r.required_products)&&r.required_products.length>0){console.log("Cargando productos requeridos para establecer:",r.required_products);const c=await g.getProductsByIds(r.required_products);console.log("Productos requeridos cargados:",c),z(I.current,c,"id","name")}if(T.current&&s.free_product_ids&&Array.isArray(s.free_product_ids)&&s.free_product_ids.length>0){console.log("Cargando productos gratis para establecer:",s.free_product_ids);const c=await g.getProductsByIds(s.free_product_ids);console.log("Productos gratis cargados:",c),z(T.current,c,"id","name")}}catch(c){console.error("Error cargando datos para selects:",c)}};setTimeout(()=>i(),300),setTimeout(()=>i(),700),setTimeout(()=>i(),1200)},De=()=>{switch(f){case"quantity_discount":return t.jsxs(t.Fragment,{children:[t.jsx(d,{eRef:R,label:"Cantidad mínima requerida",type:"number",min:"1",required:!0,specification:"El cliente debe comprar al menos esta cantidad"}),t.jsx(E,{eRef:x,label:"Productos específicos (opcional)",searchAPI:"/api/admin/items/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,specification:"Si no selecciona ninguno, aplicará a todos los productos"}),t.jsx(E,{eRef:N,label:"Categorías específicas (opcional)",searchAPI:"/api/admin/categories/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,specification:"Si no selecciona ninguna, aplicará a todas las categorías"})]});case"cart_discount":return t.jsx(t.Fragment,{children:t.jsx(d,{eRef:F,label:"Monto mínimo del carrito",type:"number",min:"0",step:"0.01",required:!0,prefix:"S/ ",specification:"El carrito debe alcanzar este monto mínimo"})});case"buy_x_get_y":return t.jsxs(t.Fragment,{children:[t.jsx(d,{eRef:q,label:"Cantidad a comprar",type:"number",min:"1",required:!0,specification:"Cuántos productos debe comprar el cliente"}),t.jsx(E,{eRef:x,label:"Productos aplicables",searchAPI:"/api/admin/items/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,required:!0,specification:"Debe seleccionar al menos un producto"})]});case"category_discount":return t.jsxs(t.Fragment,{children:["            ",t.jsx(E,{eRef:N,label:"Categorías",searchAPI:"/api/admin/categories/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,required:!0,specification:"Seleccione las categorías que tendrán descuento"}),t.jsx(d,{eRef:R,label:"Cantidad mínima por categoría",type:"number",min:"1",specification:"Cantidad mínima de productos de la categoría seleccionada"})]});case"bundle_discount":return t.jsxs(t.Fragment,{children:["            ",t.jsx(E,{eRef:I,label:"Productos requeridos",searchAPI:"/api/admin/items/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,required:!0,specification:"El cliente debe comprar TODOS estos productos para obtener el descuento"}),t.jsx(d,{eRef:A,label:"Cantidad mínima de cada producto",type:"number",min:"1",specification:"Cantidad mínima que debe comprar de cada producto"})]});case"tiered_discount":return t.jsxs("div",{children:[t.jsx("div",{className:"alert alert-info",children:t.jsxs("small",{children:[t.jsx("strong",{children:"Descuento escalonado:"})," Diferentes descuentos según la cantidad comprada"]})}),t.jsx("label",{className:"form-label",children:"Configuración de niveles:"}),(h.tiers||[]).map((e,r)=>{var s,i;return t.jsx("div",{className:"card mb-2",children:t.jsx("div",{className:"card-body p-3",children:t.jsxs("div",{className:"row",children:[t.jsx("div",{className:"col-4",children:t.jsx(d,{label:"Cantidad mínima",type:"number",min:"1",value:e.min_quantity||1,onChange:c=>{const m=[...h.tiers||[]];m[r]={...e,min_quantity:parseInt(c.target.value)||1},G("tiers",m)}})}),t.jsx("div",{className:"col-4",children:t.jsx(d,{label:"Cantidad máxima",type:"number",placeholder:"Sin límite",value:e.max_quantity||"",onChange:c=>{const m=[...h.tiers||[]];m[r]={...e,max_quantity:c.target.value?parseInt(c.target.value):null},G("tiers",m)}})}),t.jsx("div",{className:"col-3",children:t.jsx(d,{label:"Descuento (%)",type:"number",min:"0",max:"100",value:((i=(s=u.tier_discounts)==null?void 0:s[r])==null?void 0:i.discount_value)||0,onChange:c=>{const m=[...u.tier_discounts||[]];m[r]={discount_type:"percentage",discount_value:parseInt(c.target.value)||0},te("tier_discounts",m)}})}),t.jsx("div",{className:"col-1 d-flex align-items-end",children:t.jsx("button",{type:"button",className:"btn btn-sm btn-danger mb-3",onClick:()=>{var j,B;const c=((j=h.tiers)==null?void 0:j.filter((ne,M)=>M!==r))||[],m=((B=u.tier_discounts)==null?void 0:B.filter((ne,M)=>M!==r))||[];G("tiers",c),te("tier_discounts",m)},title:"Eliminar nivel",children:t.jsx("i",{className:"fa fa-trash"})})})]})})},r)}),t.jsxs("button",{type:"button",className:"btn btn-sm btn-success",onClick:()=>{const e=[...h.tiers||[],{min_quantity:1,max_quantity:null}],r=[...u.tier_discounts||[],{discount_type:"percentage",discount_value:5}];G("tiers",e),te("tier_discounts",r)},children:[t.jsx("i",{className:"fa fa-plus mr-1"})," Agregar nivel"]})]});default:return t.jsx("div",{className:"alert alert-warning",children:t.jsx("p",{className:"mb-0",children:"Seleccione un tipo de regla para configurar las condiciones."})})}},ke=()=>{switch(f){case"quantity_discount":case"cart_discount":case"category_discount":return t.jsxs(t.Fragment,{children:[t.jsxs(ce,{eRef:C,label:"Tipo de descuento",dropdownParent:"#conditions-actions-form",required:!0,specification:"Seleccione si el descuento es porcentaje o monto fijo",children:[t.jsx("option",{value:"percentage",children:"Porcentaje (%)"}),t.jsx("option",{value:"fixed",children:"Monto fijo (S/)"})]}),t.jsx(d,{eRef:S,label:"Valor del descuento",type:"number",min:"0",step:u.discount_type==="percentage"?"1":"0.01",max:u.discount_type==="percentage"?"100":void 0,required:!0,prefix:u.discount_type==="fixed"?"S/ ":"",suffix:u.discount_type==="percentage"?"%":"",specification:u.discount_type==="percentage"?"Porcentaje de descuento (1-100%)":"Monto fijo en soles"}),t.jsx(d,{eRef:D,label:"Descuento máximo (opcional)",type:"number",min:"0",step:"0.01",prefix:"S/ ",specification:"Límite máximo del descuento aplicado"})]});case"buy_x_get_y":return t.jsxs(t.Fragment,{children:[t.jsx(d,{eRef:w,label:"Cantidad gratis a obtener",type:"number",min:"1",required:!0,specification:"Cuántos productos gratis obtendrá el cliente"}),t.jsx(E,{eRef:T,label:"Productos gratis (opcional)",searchAPI:"/api/admin/items/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,specification:"Si no selecciona, los productos gratis serán los mismos que debe comprar"})]});case"bundle_discount":return t.jsxs(t.Fragment,{children:[t.jsxs(ce,{eRef:C,label:"Tipo de descuento del bundle",required:!0,specification:"Tipo de descuento para el conjunto de productos",dropdownParent:"#conditions-actions-form",children:[t.jsx("option",{value:"percentage",children:"Porcentaje (%)"}),t.jsx("option",{value:"fixed",children:"Monto fijo (S/)"})]}),t.jsx(d,{eRef:S,label:"Valor del descuento",type:"number",min:"0",step:u.discount_type==="percentage"?"1":"0.01",max:u.discount_type==="percentage"?"100":void 0,required:!0,prefix:u.discount_type==="fixed"?"S/ ":"",suffix:u.discount_type==="percentage"?"%":"",specification:"Descuento aplicado al conjunto completo de productos"})]});case"tiered_discount":return t.jsx("div",{className:"alert alert-info",children:t.jsxs("p",{className:"mb-0",children:[t.jsx("i",{className:"fa fa-info-circle mr-1"}),"Los descuentos escalonados se configuran en la sección de condiciones arriba."]})});default:return t.jsx("div",{className:"alert alert-warning",children:t.jsx("p",{className:"mb-0",children:"Seleccione un tipo de regla para configurar las acciones."})})}},Be=()=>{var c,m,j,B;if(!f)return"Seleccione un tipo de regla";const e=re(),r={...h,...e.conditions},s={...u,...e.actions},i=s.discount_type==="percentage"?`${s.discount_value||0}% de descuento`:s.discount_type==="fixed"?`S/ ${s.discount_value||0} de descuento`:`${s.get_quantity||1} producto(s) gratis`;switch(f){case"quantity_discount":const ne=(c=r.product_ids)!=null&&c.length?"en productos seleccionados":"en cualquier producto",M=(m=r.category_ids)!=null&&m.length?" de las categorías seleccionadas":"";return`Al comprar ${r.min_quantity||2} o más productos${M}, obtén ${i} ${ne}`;case"cart_discount":return`En compras desde S/ ${r.min_amount||100}, obtén ${i}`;case"buy_x_get_y":return`Compra ${r.buy_quantity||2} productos de los seleccionados y lleva ${s.get_quantity||1} gratis`;case"category_discount":return`En productos de categorías${(j=r.category_ids)!=null&&j.length?" (categorías seleccionadas)":" (debe seleccionar categorías)"}, obtén ${i}`;case"bundle_discount":return`Al comprar ${((B=r.required_products)==null?void 0:B.length)||0} productos específicos juntos (${r.min_quantity_each||1} de cada uno), obtén ${i}`;case"tiered_discount":const _e=r.tiers||[];return _e.length===0?"Configurar niveles de descuento escalonado":`Descuentos escalonados: ${_e.map((ie,Me)=>{var xe,be;const Ve=((be=(xe=s.tier_discounts)==null?void 0:xe[Me])==null?void 0:be.discount_value)||0,Ge=ie.max_quantity?` a ${ie.max_quantity}`:"+";return`${ie.min_quantity}${Ge} productos: ${Ve}%`}).join(" | ")}`;default:return"Configuración por defecto aplicada"}};o.useEffect(()=>{const e=()=>{$(l.current).on("shown.bs.modal",function(){$('[data-toggle="select2"]',this).each(function(){$(this).hasClass("select2-hidden-accessible")||$(this).select2({dropdownParent:$("#conditions-actions-form"),width:"100%",placeholder:$(this).attr("placeholder")||"Seleccionar...",allowClear:!0,ajax:$(this).data("ajax")?{url:$(this).data("ajax"),dataType:"json",delay:250,data:function(r){return{search:r.term,page:r.page||1}},processResults:function(r,s){return s.page=s.page||1,{results:r.data.map(i=>({id:i.id,text:i.name||i.title})),pagination:{more:s.page*10<r.total}}}}:void 0})})}),$(l.current).on("hidden.bs.modal",function(){$('[data-toggle="select2"]',this).each(function(){$(this).hasClass("select2-hidden-accessible")&&$(this).select2("destroy")})})};return l.current&&e(),()=>{l.current&&$(l.current).off("shown.bs.modal hidden.bs.modal")}},[]);const se=(e=null,r=null)=>{if(!f)return p.fire("Error","Debe seleccionar un tipo de regla","error"),!1;if(!e||!r){const s=re();e={...h,...s.conditions},r={...u,...s.actions}}switch(f){case"quantity_discount":if(!e.min_quantity||e.min_quantity<1)return p.fire("Error","La cantidad mínima debe ser mayor a 0","error"),!1;break;case"cart_discount":if(!e.min_amount||e.min_amount<=0)return p.fire("Error","El monto mínimo debe ser mayor a 0","error"),!1;break;case"buy_x_get_y":if(!e.buy_quantity||e.buy_quantity<1)return p.fire("Error","La cantidad a comprar debe ser mayor a 0","error"),!1;if(!e.product_ids||e.product_ids.length===0)return p.fire("Error",'Debe seleccionar al menos un producto para la regla "Compra X lleva Y"',"error"),!1;if(!r.get_quantity||r.get_quantity<1)return p.fire("Error","La cantidad gratis debe ser mayor a 0","error"),!1;break;case"category_discount":if(!e.category_ids||e.category_ids.length===0)return p.fire("Error","Debe seleccionar al menos una categoría","error"),!1;break;case"bundle_discount":if(!e.required_products||e.required_products.length<2)return p.fire("Error","Debe seleccionar al menos 2 productos para el paquete","error"),!1;break;case"tiered_discount":if(!e.tiers||e.tiers.length===0)return p.fire("Error","Debe configurar al menos un nivel de descuento","error"),!1;for(let s=0;s<e.tiers.length-1;s++){const i=e.tiers[s],c=e.tiers[s+1];if(i.max_quantity&&c.min_quantity<=i.max_quantity)return p.fire("Error",`Los niveles ${s+1} y ${s+2} se superponen. Revise las cantidades.`,"error"),!1}break}if(f!=="tiered_discount"&&f!=="buy_x_get_y"){if(!r.discount_value||r.discount_value<=0)return p.fire("Error","El valor del descuento debe ser mayor a 0","error"),!1;if(r.discount_type==="percentage"&&r.discount_value>100)return p.fire("Error","El porcentaje de descuento no puede ser mayor a 100%","error"),!1}return!0};return t.jsxs(t.Fragment,{children:[t.jsx(ze,{gridRef:y,title:"Reglas de Descuento",rest:g,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(y.current).dxDataGrid("instance").refresh()}}),e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",text:"Nueva regla",hint:"Crear nueva regla de descuento",onClick:()=>fe()}})},columns:[{dataField:"id",caption:"ID",width:"60px",visible:!1},{dataField:"name",caption:"Nombre",width:"25%",cellTemplate:(e,{data:r})=>{ve(e,t.jsxs("div",{children:[t.jsx("strong",{className:"d-block",children:r.name}),t.jsx("small",{className:"text-muted",children:Ae(r)})]}))}},{dataField:"rule_type",caption:"Tipo",width:"15%",cellTemplate:(e,{data:r})=>{var i;const s=((i=k[r.rule_type])==null?void 0:i.name)||r.rule_type;e.html(Q.renderToString(t.jsx("span",{className:"badge badge-info",children:s})))}},{dataField:"priority",caption:"Prioridad",width:"80px",cellTemplate:(e,{data:r})=>{e.html(Q.renderToString(t.jsx("span",{className:"badge badge-primary",children:r.priority})))}},{dataField:"dates",caption:"Vigencia",width:"15%",allowFiltering:!1,cellTemplate:(e,{data:r})=>{const s=r.starts_at||r.ends_at?t.jsxs(t.Fragment,{children:["                  ",r.starts_at&&t.jsx("div",{children:t.jsxs("small",{children:[t.jsx("strong",{children:"Desde:"})," ",me(r.starts_at)]})}),r.ends_at&&t.jsx("div",{children:t.jsxs("small",{children:[t.jsx("strong",{children:"Hasta:"})," ",me(r.ends_at)]})})]}):t.jsx("small",{className:"text-muted",children:"Sin límite de tiempo"});e.html(Q.renderToString(s))}},{dataField:"usage",caption:"Uso",width:"10%",allowFiltering:!1,cellTemplate:(e,{data:r})=>{const s=r.used_count||0,i=r.usage_limit,c=i?`${s}/${i}`:`${s}`;e.html(Q.renderToString(t.jsxs("div",{className:"text-center",children:[t.jsx("strong",{children:c}),i&&t.jsx("div",{className:"progress progress-sm mt-1",children:t.jsx("div",{className:"progress-bar",style:{width:`${Math.min(s/i*100,100)}%`}})})]})))}},{dataField:"status",caption:"Estado",width:"10%",cellTemplate:(e,{data:r})=>{e.html(Fe(r))}},{dataField:"active",caption:"Activa",width:"80px",cellTemplate:(e,{data:r})=>{ve(e,t.jsx(L,{checked:r.active,onChange:s=>Ne({id:r.id,value:s.target.checked})}))}},{caption:"Acciones",width:"120px",cellTemplate:(e,{data:r})=>{e.css("text-overflow","unset"),e.append(oe({className:"btn btn-xs btn-soft-info mr-1",title:"Duplicar",icon:"fa fa-copy",onClick:()=>Te(r.id)})),e.append(oe({className:"btn btn-xs btn-soft-primary mr-1",title:"Editar",icon:"fa fa-pen",onClick:()=>fe(r)})),e.append(oe({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash",onClick:()=>Ee(r.id)}))},allowFiltering:!1,allowExporting:!1}]}),t.jsx(je,{modalRef:n,title:ee?"Editar regla de descuento":"Nueva regla de descuento",onSubmit:Se,size:"lg",children:t.jsxs("div",{className:"row",id:"discount-rule-form",children:[t.jsx("input",{ref:a,type:"hidden"}),t.jsxs("div",{className:"col-md-8",children:[t.jsx(d,{eRef:_,label:"Nombre de la regla",required:!0}),t.jsx(Je,{eRef:J,label:"Descripción",rows:2})]}),t.jsxs("div",{className:"col-md-4",children:[t.jsx(L,{eRef:V,label:"Regla activa"}),t.jsx(d,{eRef:H,label:"Prioridad",type:"number",min:0,specification:"Mayor número = mayor prioridad"})]}),t.jsx("div",{className:"col-md-6",children:t.jsxs(ce,{eRef:P,label:"Tipo de regla",dropdownParent:"#discount-rule-form",required:!0,children:[t.jsx("option",{value:"",children:"Seleccione un tipo"}),Object.entries(k).map(([e,r])=>t.jsx("option",{value:e,children:r.name},e))]})}),t.jsx("div",{className:"col-md-3",children:t.jsx(d,{eRef:Y,label:"Inicia",type:"datetime-local"})}),t.jsx("div",{className:"col-md-3",children:t.jsx(d,{eRef:U,label:"Termina",type:"datetime-local"})}),t.jsx("div",{className:"col-md-6",children:t.jsx(d,{eRef:X,label:"Límite total de usos",type:"number",min:1})}),t.jsx("div",{className:"col-md-6",children:t.jsx(d,{eRef:K,label:"Límite por cliente",type:"number",min:1})}),t.jsx("div",{className:"col-md-6",children:t.jsx(L,{eRef:W,label:"Combinable con otras reglas"})}),t.jsx("div",{className:"col-md-6",children:t.jsx(L,{eRef:Z,label:"Detener evaluación de otras reglas"})}),t.jsxs("div",{className:"col-12",children:[t.jsx("hr",{}),t.jsxs("button",{type:"button",className:"btn btn-info btn-block",onClick:Pe,children:[t.jsx("i",{className:"fa fa-cogs mr-2"}),"Configurar Condiciones y Acciones"]}),"          ",t.jsx("small",{className:"text-muted",children:"Define cuándo se aplica la regla y qué descuento otorga"})]})]})}),t.jsx(je,{modalRef:l,title:"Configurar Condiciones y Acciones",size:"xl",onSubmit:e=>{if(e.preventDefault(),se()){const r=re();b(s=>({...s,...r.conditions})),v(s=>({...s,...r.actions})),$(l.current).modal("hide"),p.fire({icon:"success",title:"¡Configuración guardada!",text:"Las condiciones y acciones han sido configuradas correctamente.",timer:2e3,showConfirmButton:!1})}},children:t.jsx("div",{className:"row",id:"conditions-actions-form",children:t.jsx("div",{className:"col-12",children:f?t.jsxs("div",{children:[t.jsxs("div",{className:"alert alert-info",children:[t.jsxs("h5",{children:[t.jsx("i",{className:"fa fa-info-circle mr-2"}),"Tipo de regla: ",(ge=k[f])==null?void 0:ge.name]}),t.jsx("p",{children:(he=k[f])==null?void 0:he.description}),t.jsxs("small",{children:[t.jsx("strong",{children:"Ejemplo:"})," ",(ye=k[f])==null?void 0:ye.example]})]}),t.jsxs("div",{className:"row",children:[t.jsx("div",{className:"col-md-6",children:t.jsxs("div",{className:"card",children:[t.jsx("div",{className:"card-header",children:t.jsxs("h6",{className:"mb-0",children:[t.jsx("i",{className:"fa fa-filter mr-2"}),"Condiciones (¿Cuándo aplicar?)"]})}),t.jsx("div",{className:"card-body",children:De()})]})}),t.jsx("div",{className:"col-md-6",children:t.jsxs("div",{className:"card",children:[t.jsx("div",{className:"card-header",children:t.jsxs("h6",{className:"mb-0",children:[t.jsx("i",{className:"fa fa-bolt mr-2"}),"Acciones (¿Qué descuento dar?)"]})}),t.jsx("div",{className:"card-body",children:ke()})]})})]}),t.jsx("div",{className:"mt-3",children:t.jsxs("div",{className:"alert alert-success",children:[t.jsxs("h6",{children:[t.jsx("i",{className:"fa fa-eye mr-2"}),"Vista previa de la regla:"]}),t.jsx("p",{className:"mb-2",children:Be()}),"                  ",t.jsxs("button",{type:"button",className:"btn btn-sm btn-info",onClick:()=>{se()&&p.fire({icon:"success",title:"¡Configuración válida!",text:"La regla está configurada correctamente y lista para usar.",timer:2e3,showConfirmButton:!1})},children:[t.jsx("i",{className:"fa fa-check mr-1"})," Probar configuración"]})]})})]}):t.jsxs("div",{className:"alert alert-warning",children:[t.jsxs("h5",{children:[t.jsx("i",{className:"fa fa-exclamation-triangle mr-2"}),"Selecciona un tipo de regla"]}),t.jsx("p",{children:"Primero debes seleccionar un tipo de regla para configurar las condiciones y acciones."})]})})})})]})};Qe((y,n)=>{Le.createRoot(y).render(t.jsx(Oe,{...n,title:"Reglas de Descuento",children:t.jsx(Ue,{...n})}))});
