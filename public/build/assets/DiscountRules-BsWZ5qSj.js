import{m as e,c as t,j as a,r,s as n}from"./vendor-react-CZUvQwNQ.js";import{B as s}from"./Base-C0wMu-P3.js";import{C as i}from"./CreateReactScript-CPSgwmJG.js";import{T as c}from"./Table-B5gvhzpg.js";import{I as o}from"./InputFormGroup-BuXn3s3l.js";import{R as d}from"./ReactAppend-Db2K6xCH.js";import{D as l}from"./DxButton-C6FT_beP.js";import{S as u}from"./SwitchFormGroup-CA4b2Uj0.js";import{S as m}from"./SelectFormGroup-CuRVgWYg.js";import{S as p}from"./SelectAPIFormGroup-Dmb18ATV.js";import{T as g}from"./TextareaFormGroup-dfKTDx8M.js";import{M as f}from"./Modal-MmI0jF6v.js";import{S as h}from"./CartKuchara-C7vqSevl.js";import{B as _}from"./BasicRest-BMJgRso_.js";import{S as y}from"./SetSelectValue-DCHQOIKz.js";import{C as x}from"./Number2Currency-BX4epFEo.js";import"./vendor-swiper-Cr_RrIb_.js";import"./Footer-B_HfpgRC.js";import"./TippyButton-Gia9IjJq.js";import"./Logout-D6byb_Ua.js";import"./MenuItemContainer-BaCqn8PU.js";import"./Menu-EkCXeLHq.js";import"./General-ClVW7qxN.js";import"./LaravelSession-ByQnaUD3.js";import"./BooleanLimit-q2Ad9fGY.js";import"./OpenPayCardModal-BHkRoVZ6.js";const j=new class extends _{constructor(){super(),this.path="admin/discount-rules"}async duplicate(t){try{const{status:a,result:r}=await e.Fetch(`/api/${this.path}/${t}/duplicate`,{method:"POST"});if(!a)throw new Error(r?.message||"Error duplicating rule");return r}catch(a){return!1}}async getProducts(){try{const e=await this.simpleGet(`/api/${this.path}/products`);return e?.data||e||[]}catch(e){return[]}}async getCategories(){try{const e=await this.simpleGet(`/api/${this.path}/categories`);return e?.data||e||[]}catch(e){return[]}}async getProductsByIds(t){try{if(!t||0===t.length)return[];const{status:a,result:r}=await e.Fetch(`/api/${this.path}/products/by-ids`,{method:"POST",body:JSON.stringify({ids:t})});if(!a)throw new Error(r?.message||"Error fetching products by IDs");return r?.data||r||[]}catch(a){return[]}}async getCategoriesByIds(t){try{if(!t||0===t.length)return[];const{status:a,result:r}=await e.Fetch(`/api/${this.path}/categories/by-ids`,{method:"POST",body:JSON.stringify({ids:t})});if(!a)throw new Error(r?.message||"Error fetching categories by IDs");return r?.data||r||[]}catch(a){return[]}}async getRuleTypes(){try{const e=await this.simpleGet(`/api/${this.path}/rule-types`);return e?.data||e||{}}catch(e){return{}}}async getUsageStats(e){try{return await this.simpleGet(`/api/${this.path}/${e}/usage-stats`)}catch(t){return null}}},b=({})=>{const e=r.useRef(),t=r.useRef(),s=r.useRef(),i=r.useRef(),_=r.useRef(),b=r.useRef(),v=r.useRef(),q=r.useRef(),w=r.useRef(),N=r.useRef(),R=r.useRef(),S=r.useRef(),C=r.useRef(),P=r.useRef(),E=r.useRef(),T=r.useRef(),D=r.useRef(),F=r.useRef(),I=r.useRef(),B=r.useRef(),k=r.useRef(),A=r.useRef(),G=r.useRef(),L=r.useRef(),M=r.useRef(),O=r.useRef(),z=r.useRef(),[J,V]=r.useState(!1),[H,Y]=r.useState(null),[K,U]=r.useState({}),[Q,X]=r.useState([]),[W,Z]=r.useState([]),[ee,te]=r.useState({}),[ae,re]=r.useState({}),[ne,se]=r.useState(""),ie=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}T${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`,ce=e=>{const t=new Date(e);return`${String(t.getDate()).padStart(2,"0")}/${String(t.getMonth()+1).padStart(2,"0")}/${String(t.getFullYear()).slice(-2)} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},oe=e=>({quantity_discount:{conditions:{min_quantity:2,product_ids:[],category_ids:[]},actions:{discount_type:"percentage",discount_value:10}},cart_discount:{conditions:{min_amount:100,currency:"PEN"},actions:{discount_type:"percentage",discount_value:10}},buy_x_get_y:{conditions:{buy_quantity:2,product_ids:[]},actions:{get_quantity:1,discount_type:"fixed",discount_value:0}},category_discount:{conditions:{category_ids:[],min_quantity:1},actions:{discount_type:"percentage",discount_value:15}},tiered_discount:{conditions:{tiers:[{min_quantity:3,max_quantity:5},{min_quantity:6,max_quantity:10},{min_quantity:11,max_quantity:null}]},actions:{tier_discounts:[{discount_type:"percentage",discount_value:5},{discount_type:"percentage",discount_value:10},{discount_type:"percentage",discount_value:15}]}},bundle_discount:{conditions:{required_products:[],min_quantity_each:1},actions:{discount_type:"percentage",discount_value:25}}}[e]||{conditions:{min_quantity:1},actions:{discount_type:"percentage",discount_value:10}});r.useEffect(()=>{de()},[]);const de=async()=>{const[e,t,a]=await Promise.all([j.getRuleTypes(),j.getProducts(),j.getCategories()]);U(e),X(t),Z(a)},le=e=>{e?.id?(V(!0),Y(e)):(V(!1),Y(null)),i.current.value=e?.id??"",_.current.value=e?.name??"",b.current.value=e?.description??"";const a=e?.rule_type??"";if(se(a),v.current&&($(v.current).val(a).trigger("change"),$(v.current).off("change.ruleType").on("change.ruleType",function(){(e=>{if(se(e),e){const t=oe(e);te(t.conditions),re(t.actions)}else te({}),re({})})($(this).val())})),w.current.value=e?.priority??0,N.current.value=e?.starts_at?ie(new Date(e.starts_at)):"",R.current.value=e?.ends_at?ie(new Date(e.ends_at)):"",S.current.value=e?.usage_limit??"",C.current.value=e?.usage_limit_per_customer??"",void 0!==e?.active?$(q.current).prop("checked",e.active).trigger("change"):$(q.current).prop("checked",!0).trigger("change"),$(P.current).prop("checked",e?.combinable??!1).trigger("change"),$(E.current).prop("checked",e?.stop_further_rules??!1).trigger("change"),e?.conditions||e?.actions){const t="string"==typeof e.conditions?JSON.parse(e.conditions):e.conditions||{},a="string"==typeof e.actions?JSON.parse(e.actions):e.actions||{};te(t),re(a)}else if(a){const e=oe(a);te(e.conditions),re(e.actions)}else te({}),re({});$(t.current).modal("show")},ue=e=>{const t=e.conditions||{},a=e.actions||{};let r=e.description||"";return"quantity_discount"===e.rule_type&&t.min_quantity&&a.discount_value?r=`Compra ${t.min_quantity}+ items → ${a.discount_value}${"percentage"===a.discount_type?"%":" soles"} desc.`:"cart_discount"===e.rule_type&&t.min_amount&&a.discount_value?r=`Compras desde ${x()} ${t.min_amount} → ${a.discount_value}${"percentage"===a.discount_type?"%":" soles"} desc.`:"buy_x_get_y"===e.rule_type&&t.buy_quantity&&a.get_quantity&&(r=`Compra ${t.buy_quantity} lleva ${a.get_quantity} gratis`),r},me=(e,t)=>{te(a=>({...a,[e]:t}))},pe=(e,t)=>{re(a=>({...a,[e]:t}))},ge=()=>{const e={conditions:{},actions:{}};if(T.current&&(e.conditions.min_quantity=parseInt(T.current.value)||1),D.current&&(e.conditions.min_amount=parseFloat(D.current.value)||0),F.current&&(e.conditions.buy_quantity=parseInt(F.current.value)||1),B.current&&(e.conditions.min_quantity_each=parseInt(B.current.value)||1),G.current){const t=$(G.current).val();e.conditions.product_ids=t||[]}if(L.current){const t=$(L.current).val();e.conditions.category_ids=t||[]}if(M.current){const t=$(M.current).val();e.conditions.required_products=t||[]}if(k.current&&(e.actions.discount_type=k.current.value),A.current&&(e.actions.discount_value=parseFloat(A.current.value)||0),O.current&&(e.actions.max_discount=parseFloat(O.current.value)||null),I.current&&(e.actions.get_quantity=parseInt(I.current.value)||1),z.current){const t=$(z.current).val();e.actions.free_product_ids=t||[]}return e},fe=e=>{const t=e.conditions||{},a=e.actions||{};T.current&&(T.current.value=t.min_quantity||""),D.current&&(D.current.value=t.min_amount||""),F.current&&(F.current.value=t.buy_quantity||""),B.current&&(B.current.value=t.min_quantity_each||""),k.current&&(k.current.value=a.discount_type||"percentage"),A.current&&(A.current.value=a.discount_value||""),O.current&&(O.current.value=a.max_discount||""),I.current&&(I.current.value=a.get_quantity||"");const r=async()=>{try{if(G.current&&t.product_ids&&Array.isArray(t.product_ids)&&t.product_ids.length>0){const e=await j.getProductsByIds(t.product_ids);y(G.current,e,"id","name")}if(L.current&&t.category_ids&&Array.isArray(t.category_ids)&&t.category_ids.length>0){const e=await j.getCategoriesByIds(t.category_ids);y(L.current,e,"id","name")}if(M.current&&t.required_products&&Array.isArray(t.required_products)&&t.required_products.length>0){const e=await j.getProductsByIds(t.required_products);y(M.current,e,"id","name")}if(z.current&&a.free_product_ids&&Array.isArray(a.free_product_ids)&&a.free_product_ids.length>0){const e=await j.getProductsByIds(a.free_product_ids);y(z.current,e,"id","name")}}catch(e){}};setTimeout(()=>r(),300),setTimeout(()=>r(),700),setTimeout(()=>r(),1200)};r.useEffect(()=>{const e=()=>{$(s.current).on("shown.bs.modal",function(){$('[data-toggle="select2"]',this).each(function(){$(this).hasClass("select2-hidden-accessible")||$(this).select2({dropdownParent:$("#conditions-actions-form"),width:"100%",placeholder:$(this).attr("placeholder")||"Seleccionar...",allowClear:!0,ajax:$(this).data("ajax")?{url:$(this).data("ajax"),dataType:"json",delay:250,data:function(e){return{search:e.term,page:e.page||1}},processResults:function(e,t){return t.page=t.page||1,{results:e.data.map(e=>({id:e.id,text:e.name||e.title})),pagination:{more:10*t.page<e.total}}}}:void 0})})}),$(s.current).on("hidden.bs.modal",function(){$('[data-toggle="select2"]',this).each(function(){$(this).hasClass("select2-hidden-accessible")&&$(this).select2("destroy")})})};return s.current&&e(),()=>{s.current&&$(s.current).off("shown.bs.modal hidden.bs.modal")}},[]);const he=(e=null,t=null)=>{if(!ne)return h.fire("Error","Debe seleccionar un tipo de regla","error"),!1;if(!e||!t){const a=ge();e={...ee,...a.conditions},t={...ae,...a.actions}}switch(ne){case"quantity_discount":if(!e.min_quantity||e.min_quantity<1)return h.fire("Error","La cantidad mínima debe ser mayor a 0","error"),!1;break;case"cart_discount":if(!e.min_amount||e.min_amount<=0)return h.fire("Error","El monto mínimo debe ser mayor a 0","error"),!1;break;case"buy_x_get_y":if(!e.buy_quantity||e.buy_quantity<1)return h.fire("Error","La cantidad a comprar debe ser mayor a 0","error"),!1;if(!e.product_ids||0===e.product_ids.length)return h.fire("Error",'Debe seleccionar al menos un producto para la regla "Compra X lleva Y"',"error"),!1;if(!t.get_quantity||t.get_quantity<1)return h.fire("Error","La cantidad gratis debe ser mayor a 0","error"),!1;break;case"category_discount":if(!e.category_ids||0===e.category_ids.length)return h.fire("Error","Debe seleccionar al menos una categoría","error"),!1;break;case"bundle_discount":if(!e.required_products||e.required_products.length<2)return h.fire("Error","Debe seleccionar al menos 2 productos para el paquete","error"),!1;break;case"tiered_discount":if(!e.tiers||0===e.tiers.length)return h.fire("Error","Debe configurar al menos un nivel de descuento","error"),!1;for(let t=0;t<e.tiers.length-1;t++){const a=e.tiers[t],r=e.tiers[t+1];if(a.max_quantity&&r.min_quantity<=a.max_quantity)return h.fire("Error",`Los niveles ${t+1} y ${t+2} se superponen. Revise las cantidades.`,"error"),!1}}if("tiered_discount"!==ne&&"buy_x_get_y"!==ne){if(!t.discount_value||t.discount_value<=0)return h.fire("Error","El valor del descuento debe ser mayor a 0","error"),!1;if("percentage"===t.discount_type&&t.discount_value>100)return h.fire("Error","El porcentaje de descuento no puede ser mayor a 100%","error"),!1}return!0};return a.jsxs(a.Fragment,{children:[a.jsx(c,{gridRef:e,title:"Reglas de Descuento",rest:j,toolBar:t=>{t.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(e.current).dxDataGrid("instance").refresh()}}),t.unshift({widget:"dxButton",location:"after",options:{icon:"plus",text:"Nueva regla",hint:"Crear nueva regla de descuento",onClick:()=>le()}})},columns:[{dataField:"id",caption:"ID",width:"60px",visible:!1},{dataField:"name",caption:"Nombre",width:"25%",cellTemplate:(e,{data:t})=>{d(e,a.jsxs("div",{children:[a.jsx("strong",{className:"d-block",children:t.name}),a.jsx("small",{className:"text-muted",children:ue(t)})]}))}},{dataField:"rule_type",caption:"Tipo",width:"15%",cellTemplate:(e,{data:t})=>{const r=K[t.rule_type]?.name||t.rule_type;e.html(n.renderToString(a.jsx("span",{className:"badge badge-info",children:r})))}},{dataField:"priority",caption:"Prioridad",width:"80px",cellTemplate:(e,{data:t})=>{e.html(n.renderToString(a.jsx("span",{className:"badge badge-primary",children:t.priority})))}},{dataField:"dates",caption:"Vigencia",width:"15%",allowFiltering:!1,cellTemplate:(e,{data:t})=>{const r=t.starts_at||t.ends_at?a.jsxs(a.Fragment,{children:["                  ",t.starts_at&&a.jsx("div",{children:a.jsxs("small",{children:[a.jsx("strong",{children:"Desde:"})," ",ce(t.starts_at)]})}),t.ends_at&&a.jsx("div",{children:a.jsxs("small",{children:[a.jsx("strong",{children:"Hasta:"})," ",ce(t.ends_at)]})})]}):a.jsx("small",{className:"text-muted",children:"Sin límite de tiempo"});e.html(n.renderToString(r))}},{dataField:"usage",caption:"Uso",width:"10%",allowFiltering:!1,cellTemplate:(e,{data:t})=>{const r=t.used_count||0,s=t.usage_limit,i=s?`${r}/${s}`:`${r}`;e.html(n.renderToString(a.jsxs("div",{className:"text-center",children:[a.jsx("strong",{children:i}),s&&a.jsx("div",{className:"progress progress-sm mt-1",children:a.jsx("div",{className:"progress-bar",style:{width:`${Math.min(r/s*100,100)}%`}})})]})))}},{dataField:"status",caption:"Estado",width:"10%",cellTemplate:(e,{data:t})=>{e.html((e=>{const t=e.status||"Activa";return`<span class="badge badge-${{Activa:"success",Inactiva:"secondary",Programada:"info",Expirada:"warning",Agotada:"danger"}[t]||"secondary"}">${t}</span>`})(t))}},{dataField:"active",caption:"Activa",width:"80px",cellTemplate:(t,{data:r})=>{const n=1===r.active||"1"===r.active||!0===r.active;d(t,a.jsx(u,{checked:n,onChange:t=>(async({id:t,field:a,value:r})=>{await j.boolean({id:t,field:a,value:r})&&$(e.current).dxDataGrid("instance").refresh()})({id:r.id,field:"active",value:t.target.checked?1:0})}))}},{caption:"Acciones",width:"120px",cellTemplate:(t,{data:a})=>{t.css("text-overflow","unset"),t.append(l({className:"btn btn-xs btn-soft-info mr-1",title:"Duplicar",icon:"fa fa-copy",onClick:()=>(async t=>{await j.duplicate(t)&&$(e.current).dxDataGrid("instance").refresh()})(a.id)})),t.append(l({className:"btn btn-xs btn-soft-primary mr-1",title:"Editar",icon:"fa fa-pen",onClick:()=>le(a)})),t.append(l({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash",onClick:()=>(async t=>{const{isConfirmed:a}=await h.fire({title:"Eliminar regla de descuento",text:"¿Estás seguro de eliminar esta regla?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});if(!a)return;await j.delete(t)&&$(e.current).dxDataGrid("instance").refresh()})(a.id)}))},allowFiltering:!1,allowExporting:!1}]}),a.jsx(f,{modalRef:t,title:J?"Editar regla de descuento":"Nueva regla de descuento",onSubmit:async a=>{if(a.preventDefault(),!he())return;const r={id:i.current.value||void 0,name:_.current.value,description:b.current.value,rule_type:$(v.current).val(),active:q.current.checked,priority:parseInt(w.current.value)||0,starts_at:N.current.value||null,ends_at:R.current.value||null,usage_limit:parseInt(S.current.value)||null,usage_limit_per_customer:parseInt(C.current.value)||null,combinable:P.current.checked,stop_further_rules:E.current.checked,conditions:ee,actions:ae};await j.save(r)&&($(e.current).dxDataGrid("instance").refresh(),$(t.current).modal("hide"),h.fire({icon:"success",title:"¡Guardado!",text:J?"La regla ha sido actualizada correctamente":"La nueva regla ha sido creada correctamente",timer:2e3,showConfirmButton:!1}))},size:"lg",children:a.jsxs("div",{className:"row",id:"discount-rule-form",children:[a.jsx("input",{ref:i,type:"hidden"}),a.jsxs("div",{className:"col-md-8",children:[a.jsx(o,{eRef:_,label:"Nombre de la regla",required:!0}),a.jsx(g,{eRef:b,label:"Descripción",rows:2})]}),a.jsxs("div",{className:"col-md-4",children:[a.jsx(u,{eRef:q,label:"Regla activa"}),a.jsx(o,{eRef:w,label:"Prioridad",type:"number",min:0,specification:"Mayor número = mayor prioridad"})]}),a.jsx("div",{className:"col-md-6",children:a.jsxs(m,{eRef:v,label:"Tipo de regla",dropdownParent:"#discount-rule-form",required:!0,children:[a.jsx("option",{value:"",children:"Seleccione un tipo"}),Object.entries(K).map(([e,t])=>a.jsx("option",{value:e,children:t.name},e))]})}),a.jsx("div",{className:"col-md-3",children:a.jsx(o,{eRef:N,label:"Inicia",type:"datetime-local"})}),a.jsx("div",{className:"col-md-3",children:a.jsx(o,{eRef:R,label:"Termina",type:"datetime-local"})}),a.jsx("div",{className:"col-md-6",children:a.jsx(o,{eRef:S,label:"Límite total de usos",type:"number",min:1})}),a.jsx("div",{className:"col-md-6",children:a.jsx(o,{eRef:C,label:"Límite por cliente",type:"number",min:1})}),a.jsx("div",{className:"col-md-6",children:a.jsx(u,{eRef:P,label:"Combinable con otras reglas"})}),a.jsx("div",{className:"col-md-6",children:a.jsx(u,{eRef:E,label:"Detener evaluación de otras reglas"})}),a.jsxs("div",{className:"col-12",children:[a.jsx("hr",{}),a.jsxs("button",{type:"button",className:"btn btn-info btn-block",onClick:()=>{$(s.current).modal("show"),(Object.keys(ee).length>0||Object.keys(ae).length>0)&&$(s.current).one("shown.bs.modal",()=>{setTimeout(()=>{fe({conditions:ee,actions:ae})},500)})},children:[a.jsx("i",{className:"fa fa-cogs mr-2"}),"Configurar Condiciones y Acciones"]}),"          ",a.jsx("small",{className:"text-muted",children:"Define cuándo se aplica la regla y qué descuento otorga"})]})]})}),a.jsx(f,{modalRef:s,title:"Configurar Condiciones y Acciones",size:"xl",onSubmit:e=>{if(e.preventDefault(),he()){const e=ge();te(t=>({...t,...e.conditions})),re(t=>({...t,...e.actions})),$(s.current).modal("hide"),h.fire({icon:"success",title:"¡Configuración guardada!",text:"Las condiciones y acciones han sido configuradas correctamente.",timer:2e3,showConfirmButton:!1})}},children:a.jsx("div",{className:"row",id:"conditions-actions-form",children:a.jsx("div",{className:"col-12",children:ne?a.jsxs("div",{children:[a.jsxs("div",{className:"alert alert-info",children:[a.jsxs("h5",{children:[a.jsx("i",{className:"fa fa-info-circle mr-2"}),"Tipo de regla: ",K[ne]?.name]}),a.jsx("p",{children:K[ne]?.description}),a.jsxs("small",{children:[a.jsx("strong",{children:"Ejemplo:"})," ",K[ne]?.example]})]}),a.jsxs("div",{className:"row",children:[a.jsx("div",{className:"col-md-6",children:a.jsxs("div",{className:"card",children:[a.jsx("div",{className:"card-header",children:a.jsxs("h6",{className:"mb-0",children:[a.jsx("i",{className:"fa fa-filter mr-2"}),"Condiciones (¿Cuándo aplicar?)"]})}),a.jsx("div",{className:"card-body",children:(()=>{switch(ne){case"quantity_discount":return a.jsxs(a.Fragment,{children:[a.jsx(o,{eRef:T,label:"Cantidad mínima requerida",type:"number",min:"1",required:!0,specification:"El cliente debe comprar al menos esta cantidad"}),a.jsx(p,{eRef:G,label:"Productos específicos (opcional)",searchAPI:"/api/admin/items/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,specification:"Si no selecciona ninguno, aplicará a todos los productos"}),a.jsx(p,{eRef:L,label:"Categorías específicas (opcional)",searchAPI:"/api/admin/categories/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,specification:"Si no selecciona ninguna, aplicará a todas las categorías"})]});case"cart_discount":return a.jsx(a.Fragment,{children:a.jsx(o,{eRef:D,label:"Monto mínimo del carrito",type:"number",min:"0",step:"0.01",required:!0,prefix:x(),specification:"El carrito debe alcanzar este monto mínimo"})});case"buy_x_get_y":return a.jsxs(a.Fragment,{children:[a.jsx(o,{eRef:F,label:"Cantidad a comprar",type:"number",min:"1",required:!0,specification:"Cuántos productos debe comprar el cliente"}),a.jsx(p,{eRef:G,label:"Productos aplicables",searchAPI:"/api/admin/items/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,required:!0,specification:"Debe seleccionar al menos un producto"})]});case"category_discount":return a.jsxs(a.Fragment,{children:["            ",a.jsx(p,{eRef:L,label:"Categorías",searchAPI:"/api/admin/categories/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,required:!0,specification:"Seleccione las categorías que tendrán descuento"}),a.jsx(o,{eRef:T,label:"Cantidad mínima por categoría",type:"number",min:"1",specification:"Cantidad mínima de productos de la categoría seleccionada"})]});case"bundle_discount":return a.jsxs(a.Fragment,{children:["            ",a.jsx(p,{eRef:M,label:"Productos requeridos",searchAPI:"/api/admin/items/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,required:!0,specification:"El cliente debe comprar TODOS estos productos para obtener el descuento"}),a.jsx(o,{eRef:B,label:"Cantidad mínima de cada producto",type:"number",min:"1",specification:"Cantidad mínima que debe comprar de cada producto"})]});case"tiered_discount":return a.jsxs("div",{children:[a.jsx("div",{className:"alert alert-info",children:a.jsxs("small",{children:[a.jsx("strong",{children:"Descuento escalonado:"})," Diferentes descuentos según la cantidad comprada"]})}),a.jsx("label",{className:"form-label",children:"Configuración de niveles:"}),(ee.tiers||[]).map((e,t)=>a.jsx("div",{className:"card mb-2",children:a.jsx("div",{className:"card-body p-3",children:a.jsxs("div",{className:"row",children:[a.jsx("div",{className:"col-4",children:a.jsx(o,{label:"Cantidad mínima",type:"number",min:"1",value:e.min_quantity||1,onChange:a=>{const r=[...ee.tiers||[]];r[t]={...e,min_quantity:parseInt(a.target.value)||1},me("tiers",r)}})}),a.jsx("div",{className:"col-4",children:a.jsx(o,{label:"Cantidad máxima",type:"number",placeholder:"Sin límite",value:e.max_quantity||"",onChange:a=>{const r=[...ee.tiers||[]];r[t]={...e,max_quantity:a.target.value?parseInt(a.target.value):null},me("tiers",r)}})}),a.jsx("div",{className:"col-3",children:a.jsx(o,{label:"Descuento (%)",type:"number",min:"0",max:"100",value:ae.tier_discounts?.[t]?.discount_value||0,onChange:e=>{const a=[...ae.tier_discounts||[]];a[t]={discount_type:"percentage",discount_value:parseInt(e.target.value)||0},pe("tier_discounts",a)}})}),a.jsx("div",{className:"col-1 d-flex align-items-end",children:a.jsx("button",{type:"button",className:"btn btn-sm btn-danger mb-3",onClick:()=>{const e=ee.tiers?.filter((e,a)=>a!==t)||[],a=ae.tier_discounts?.filter((e,a)=>a!==t)||[];me("tiers",e),pe("tier_discounts",a)},title:"Eliminar nivel",children:a.jsx("i",{className:"fa fa-trash"})})})]})})},t)),a.jsxs("button",{type:"button",className:"btn btn-sm btn-success",onClick:()=>{const e=[...ee.tiers||[],{min_quantity:1,max_quantity:null}],t=[...ae.tier_discounts||[],{discount_type:"percentage",discount_value:5}];me("tiers",e),pe("tier_discounts",t)},children:[a.jsx("i",{className:"fa fa-plus mr-1"})," Agregar nivel"]})]});default:return a.jsx("div",{className:"alert alert-warning",children:a.jsx("p",{className:"mb-0",children:"Seleccione un tipo de regla para configurar las condiciones."})})}})()})]})}),a.jsx("div",{className:"col-md-6",children:a.jsxs("div",{className:"card",children:[a.jsx("div",{className:"card-header",children:a.jsxs("h6",{className:"mb-0",children:[a.jsx("i",{className:"fa fa-bolt mr-2"}),"Acciones (¿Qué descuento dar?)"]})}),a.jsx("div",{className:"card-body",children:(()=>{switch(ne){case"quantity_discount":case"cart_discount":case"category_discount":return a.jsxs(a.Fragment,{children:[a.jsxs(m,{eRef:k,label:"Tipo de descuento",dropdownParent:"#conditions-actions-form",required:!0,specification:"Seleccione si el descuento es porcentaje o monto fijo",children:[a.jsx("option",{value:"percentage",children:"Porcentaje (%)"}),a.jsxs("option",{value:"fixed",children:["Monto fijo (",x(),")"]})]}),a.jsx(o,{eRef:A,label:"Valor del descuento",type:"number",min:"0",step:"percentage"===ae.discount_type?"1":"0.01",max:"percentage"===ae.discount_type?"100":void 0,required:!0,prefix:"fixed"===ae.discount_type?x():"",suffix:"percentage"===ae.discount_type?"%":"",specification:"percentage"===ae.discount_type?"Porcentaje de descuento (1-100%)":"Monto fijo en soles"}),a.jsx(o,{eRef:O,label:"Descuento máximo (opcional)",type:"number",min:"0",step:"0.01",prefix:x(),specification:"Límite máximo del descuento aplicado"})]});case"buy_x_get_y":return a.jsxs(a.Fragment,{children:[a.jsx(o,{eRef:I,label:"Cantidad gratis a obtener",type:"number",min:"1",required:!0,specification:"Cuántos productos gratis obtendrá el cliente"}),a.jsx(p,{eRef:z,label:"Productos gratis (opcional)",searchAPI:"/api/admin/items/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,specification:"Si no selecciona, los productos gratis serán los mismos que debe comprar"})]});case"bundle_discount":return a.jsxs(a.Fragment,{children:[a.jsxs(m,{eRef:k,label:"Tipo de descuento del bundle",required:!0,specification:"Tipo de descuento para el conjunto de productos",dropdownParent:"#conditions-actions-form",children:[a.jsx("option",{value:"percentage",children:"Porcentaje (%)"}),a.jsxs("option",{value:"fixed",children:["Monto fijo (",x(),")"]})]}),a.jsx(o,{eRef:A,label:"Valor del descuento",type:"number",min:"0",step:"percentage"===ae.discount_type?"1":"0.01",max:"percentage"===ae.discount_type?"100":void 0,required:!0,prefix:"fixed"===ae.discount_type?x():"",suffix:"percentage"===ae.discount_type?"%":"",specification:"Descuento aplicado al conjunto completo de productos"})]});case"tiered_discount":return a.jsx("div",{className:"alert alert-info",children:a.jsxs("p",{className:"mb-0",children:[a.jsx("i",{className:"fa fa-info-circle mr-1"}),"Los descuentos escalonados se configuran en la sección de condiciones arriba."]})});default:return a.jsx("div",{className:"alert alert-warning",children:a.jsx("p",{className:"mb-0",children:"Seleccione un tipo de regla para configurar las acciones."})})}})()})]})})]}),a.jsx("div",{className:"mt-3",children:a.jsxs("div",{className:"alert alert-success",children:[a.jsxs("h6",{children:[a.jsx("i",{className:"fa fa-eye mr-2"}),"Vista previa de la regla:"]}),a.jsx("p",{className:"mb-2",children:(()=>{if(!ne)return"Seleccione un tipo de regla";const e=ge(),t={...ee,...e.conditions},a={...ae,...e.actions},r="percentage"===a.discount_type?`${a.discount_value||0}% de descuento`:"fixed"===a.discount_type?`${x()} ${a.discount_value||0} de descuento`:`${a.get_quantity||1} producto(s) gratis`;switch(ne){case"quantity_discount":const e=t.product_ids?.length?"en productos seleccionados":"en cualquier producto",n=t.category_ids?.length?" de las categorías seleccionadas":"";return`Al comprar ${t.min_quantity||2} o más productos${n}, obtén ${r} ${e}`;case"cart_discount":return`En compras desde ${x()} ${t.min_amount||100}, obtén ${r}`;case"buy_x_get_y":return`Compra ${t.buy_quantity||2} productos de los seleccionados y lleva ${a.get_quantity||1} gratis`;case"category_discount":return`En productos de categorías${t.category_ids?.length?" (categorías seleccionadas)":" (debe seleccionar categorías)"}, obtén ${r}`;case"bundle_discount":return`Al comprar ${t.required_products?.length||0} productos específicos juntos (${t.min_quantity_each||1} de cada uno), obtén ${r}`;case"tiered_discount":const s=t.tiers||[];if(0===s.length)return"Configurar niveles de descuento escalonado";return`Descuentos escalonados: ${s.map((e,t)=>{const r=a.tier_discounts?.[t]?.discount_value||0,n=e.max_quantity?` a ${e.max_quantity}`:"+";return`${e.min_quantity}${n} productos: ${r}%`}).join(" | ")}`;default:return"Configuración por defecto aplicada"}})()}),"                  ",a.jsxs("button",{type:"button",className:"btn btn-sm btn-info",onClick:()=>{he()&&h.fire({icon:"success",title:"¡Configuración válida!",text:"La regla está configurada correctamente y lista para usar.",timer:2e3,showConfirmButton:!1})},children:[a.jsx("i",{className:"fa fa-check mr-1"})," Probar configuración"]})]})})]}):a.jsxs("div",{className:"alert alert-warning",children:[a.jsxs("h5",{children:[a.jsx("i",{className:"fa fa-exclamation-triangle mr-2"}),"Selecciona un tipo de regla"]}),a.jsx("p",{children:"Primero debes seleccionar un tipo de regla para configurar las condiciones y acciones."})]})})})})]})};i((e,r)=>{t.createRoot(e).render(a.jsx(s,{...r,title:"Reglas de Descuento",children:a.jsx(b,{...r})}))});
