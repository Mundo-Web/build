var e=Object.defineProperty,t=(t,r,a)=>((t,r,a)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[r]=a)(t,"symbol"!=typeof r?r+"":r,a);import{c as r,j as a,r as i,s}from"./vendor-react-CtPXetfm.js";import{B as n}from"./Base-B2hVq4yw.js";import{S as o}from"./SwitchFormGroup-CB0qoXn0.js";import{S as c}from"./CartKuchara-Bi-J8T1O.js";import{M as l}from"./Modal-CUkY7A3F.js";import{T as d}from"./Table-CdAbWBID.js";import{I as m}from"./ImageFormGroup-Cr7oEweG.js";import{I as u}from"./InputFormGroup-CRGKsLQr.js";import{S as p}from"./SelectAPIFormGroup-BjT0ctnU.js";import{D as f}from"./DxButton-C6FT_beP.js";import{C as b}from"./CreateReactScript-Cjoo020C.js";import{C as h,N as x}from"./Number2Currency-BX4epFEo.js";import{R as j}from"./ReactAppend-RIOEhuYO.js";import"./OpenPayCardModal-DGeo-a3a.js";import{B as g}from"./BasicRest-xQKzLTAw.js";import"./vendor-swiper-Cr_RrIb_.js";import"./Footer-coriRrmf.js";import"./TippyButton-Dqi9Vaf_.js";import"./Logout-DQyEsGXW.js";import"./MenuItemContainer-UDNHvqM7.js";import"./Menu-BjIZNCK0.js";import"./BooleanLimit-q2Ad9fGY.js";import"./General-ClVW7qxN.js";import"./LaravelSession-ByQnaUD3.js";const v=new class extends g{constructor(){super(...arguments),t(this,"path","admin/combos"),t(this,"hasFiles",!0)}},F=({items:e})=>{const[t,r]=i.useState([]),[n,b]=i.useState(null),[g,F]=i.useState(0),w=i.useRef(),y=i.useRef(),C=i.useRef(),D=i.useRef(),R=i.useRef(),E=i.useRef(),N=i.useRef(),S=i.useRef(),[T,B]=i.useState(!1);i.useEffect(()=>{const e=t.reduce((e,t)=>e+parseFloat(t.final_price||0),0);F(e)},[t]),i.useEffect(()=>{R.current&&(R.current.value=g.toFixed(2))},[g]);const P=async e=>{if(e?.id){B(!0);const t=await v.get(e.id,["items"]);if(!t)return;C.current.value=t.id||"",D.current.value=t.name||"",R.current.value=t.price||0,E.current.value=t.discount||0,S.current.value=null,S.image.src=t?.image?`/storage/images/combo/${t.image}`:"",S.resetDeleteFlag&&S.resetDeleteFlag();const a=t.items||[],i=a.find(e=>{const t=e.pivot?.is_main_item;return 1===t||"1"===t||!0===t||"true"===t});b(i||null),r(a),setTimeout(()=>{if(N.current){const e=a.map(e=>e.id.toString());$(N.current).val(e)}},100)}else B(!1),r([]),b(null),F(0),C.current.value="",D.current.value="",R.current.value=0,E.current.value=0,S.resetDeleteFlag&&S.resetDeleteFlag(),N.current&&$(N.current).val([]);$(y.current).modal("show")};return a.jsxs(a.Fragment,{children:[a.jsx(d,{gridRef:w,title:"Combos",rest:v,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(w.current).dxDataGrid("instance").refresh()}}),e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",text:"Nuevo combo",hint:"Nuevo combo",onClick:()=>P()}})},exportable:!0,exportableName:"Combos",columns:[{dataField:"id",caption:"ID",visible:!1},{dataField:"name",caption:"Nombre",cellTemplate:(e,{data:t})=>{e.html(s.renderToString(a.jsxs(a.Fragment,{children:[a.jsx("b",{children:t.name}),a.jsx("br",{}),a.jsx("span",{className:"truncate",children:t.summary})]})))}},{dataField:"image",caption:"Imagen",width:"80px",cellTemplate:(e,{data:t})=>{j(e,a.jsx("img",{src:`/storage/images/combo/${t.image}`,style:{width:"80px",height:"48px",objectFit:"cover",objectPosition:"center",borderRadius:"4px"},onError:e=>e.target.src="/api/cover/thumbnail/null"}))}},{dataField:"final_price",caption:"Precio",dataType:"number",width:"100px",cellTemplate:(e,{data:t})=>{e.html(s.renderToString(a.jsxs(a.Fragment,{children:[t.discount>0&&a.jsxs("small",{className:"d-block text-muted",style:{textDecoration:"line-through"},children:[h()," ",x(t.price)]}),a.jsxs("span",{children:[h()," ",x(t.discount>0?t.discount:t.price)]})]})))}},{dataField:"visible",caption:"Visible",dataType:"boolean",width:"80px",cellTemplate:(e,{data:t})=>{j(e,a.jsx(o,{checked:t.visible,onChange:e=>(async({id:e,value:t})=>{await v.boolean({id:e,field:"visible",value:t})&&$(w.current).dxDataGrid("instance").refresh()})({id:t.id,value:e.target.checked})}))}},{caption:"Acciones",width:"100px",cellTemplate:(e,{data:t})=>{e.css("text-overflow","unset"),e.append(f({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>P(t)})),e.append(f({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash",onClick:()=>(async e=>{const{isConfirmed:t}=await c.fire({title:"Eliminar combo",text:"¿Estás seguro de eliminar este combo?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});if(!t)return;await v.delete(e)&&$(w.current).dxDataGrid("instance").refresh()})(t.id)}))},allowFiltering:!1,allowExporting:!1}]}),a.jsx(l,{modalRef:y,title:T?"Editar combo":"Agregar combo",onSubmit:async e=>{if(e.preventDefault(),0===t.length)return void c.fire({title:"Error",text:"Debes seleccionar al menos un producto para crear el combo.",icon:"error"});if(!n)return void c.fire({title:"Error",text:"Debes marcar un producto como principal antes de guardar el combo.",icon:"error"});const a={id:C.current.value||void 0,name:D.current.value,price:g,discount:E.current.value,final_price:E.current.value>0&&E.current.value<g?E.current.value:g,discount_percent:100-E.current.value/R.current.value*100},i=new FormData;for(const t in a)void 0!==a[t]&&i.append(t,a[t]);t.forEach((e,t)=>{i.append(`items[${t}][item_id]`,e.id),i.append(`items[${t}][is_main_item]`,n?.id===e.id?1:0)});const s=S.current.files[0];s&&i.append("image",s),S.getDeleteFlag&&S.getDeleteFlag()&&i.append("image_delete","DELETE");await v.save(i)&&(S.resetDeleteFlag&&S.resetDeleteFlag(),$(w.current).dxDataGrid("instance").refresh(),$(y.current).modal("hide"),r([]),b(null),F(0),N.current&&$(N.current).val([]))},size:"lg",children:a.jsxs("div",{className:"row",id:"combo-container",children:[a.jsx("input",{ref:C,type:"hidden"}),a.jsxs("div",{className:"col-md-6",children:[a.jsx(u,{eRef:D,label:"Nombre",required:!0}),a.jsx(u,{label:"Precio",eRef:R,type:"number",readOnly:!0}),a.jsx(u,{eRef:E,label:"Precio con Descuento",type:"number",step:"0.01",onChange:e=>{parseFloat(e.target.value||0)>g&&(c.fire("Error","El precio con descuento no puede ser mayor al precio acumulado.","error"),E.current.value="")}}),a.jsx(p,{id:"items",eRef:N,searchAPI:"/api/admin/items/paginate",searchBy:"name",label:"Productos",dropdownParent:"#combo-container",multiple:!0,onChange:e=>{const t=$(e.target).select2("data").map(e=>e.data);r(e=>{const r=e.map(e=>e.id),a=t.filter(e=>!r.includes(e.id));return[...e,...a]})}})]}),a.jsx("div",{className:"col-md-6",children:a.jsx(m,{eRef:S,name:"image",label:"Imagen del Combo",col:"col-12",aspect:"4/3",required:!0})}),a.jsxs("div",{className:"col-md-12 row",children:[a.jsx("h4",{className:"col-md-12",children:"Productos Seleccionados"}),a.jsx("ul",{className:"list-unstyled col-md-12 row",children:t.map(e=>{const i=n&&`${n.id}`==`${e.id}`;return a.jsxs("li",{className:"col-md-6",children:[a.jsx("input",{type:"radio",name:"mainProduct",checked:i,onChange:()=>{b(e)}}),a.jsx("div",{children:a.jsx("div",{class:"card mb-3",children:a.jsxs("div",{class:"row g-0",children:[a.jsx("div",{class:"col-md-4",children:a.jsx("img",{src:`/storage/images/item/${e?.image??"undefined"}`,class:"img-thumbnail rounded-start",alt:e.name})}),a.jsx("div",{class:"col-md-8",children:a.jsxs("div",{class:"card-body",children:[a.jsxs("h5",{class:"card-title",children:[e?.name," "]}),a.jsxs("p",{class:"card-text small line-clamp-2",children:[e?.summary," "]}),a.jsx("p",{class:"card-text",children:a.jsxs("strong",{children:["Precio: ",h()," ",e?.final_price]})}),a.jsx("button",{className:"btn btn-sm btn-danger pull-left",type:"button",onClick:()=>(e=>{const a=t.filter(t=>t.id!==e);if(r(a),N.current){const e=a.map(e=>e.id.toString());$(N.current).val(e)}n?.id===e&&b(null)})(e.id),children:"Eliminar"})]})})]})})})]},e.id)})})]})]})})]})};b((e,t)=>{r.createRoot(e).render(a.jsx(n,{...t,title:"Combos",children:a.jsx(F,{...t})}))});
