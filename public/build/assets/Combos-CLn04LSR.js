var J=Object.defineProperty;var K=(l,i,c)=>i in l?J(l,i,{enumerable:!0,configurable:!0,writable:!0,value:c}):l[i]=c;var y=(l,i,c)=>K(l,typeof i!="symbol"?i+"":i,c);import{j as t}from"./AboutSimple-Cf8x2fCZ.js";import{B as L}from"./Base-DKjYZsUF.js";import{S as Q}from"./SwitchFormGroup-B-vmnVqk.js";import{r as a}from"./index-BOnQTV8N.js";import{c as U}from"./ReactAppend-DTVVXReZ.js";import{s as T}from"./server.browser-Bf4gQIc7.js";import{S as D}from"./ProductCard-Lp5WfZrB.js";import{M as W}from"./Modal-BYL-UsqM.js";import{T as X}from"./Table-CCZDHBJ5.js";import{I as Y}from"./ImageFormGroup-Brimgjsn.js";import{I as E}from"./InputFormGroup-iZIO11ZN.js";import{S as Z}from"./SelectAPIFormGroup-1XgklNMJ.js";import{D as I}from"./DxButton-DV0H-ZcL.js";import{C as ee}from"./CreateReactScript-DlXLjWSJ.js";import{N as k}from"./Number2Currency-B5ZenVq9.js";import{R as _}from"./ReactAppend-D7S498fx.js";import"./main-DKOTUah5.js";import"./index-DRg3WPTA.js";import{B as te}from"./BasicRest-BCYKfs4R.js";import"./index-yBjzXJbu.js";import"./Global-DWbVqTT_.js";import"./tippy-react.esm-Ce0cOK54.js";import"./index-C0Swrixi.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./index-fNjTmf9T.js";/* empty css              */import"./Logout-W0zm0J8x.js";import"./MenuItemContainer-CEON2wjZ.js";import"./index.esm-BNsoPXs8.js";import"./index-NIGUFBhG.js";import"./___vite-browser-external_commonjs-proxy-DDYoOVPM.js";import"./CanAccess-DKJVq_mE.js";/* empty css               */import"./General-BmbBKdsB.js";import"./LaravelSession-Dz9cpV3l.js";class se extends te{constructor(){super(...arguments);y(this,"path","admin/combos");y(this,"hasFiles",!0)}}const j=new se,re=({items:l})=>{const[i,c]=a.useState([]),[o,x]=a.useState(null),[p,S]=a.useState(0),b=a.useRef(),C=a.useRef(),N=a.useRef(),w=a.useRef(),f=a.useRef(),m=a.useRef(),h=a.useRef(),R=a.useRef(),[B,F]=a.useState(!1),G=e=>e.reduce((s,r)=>{const n=parseFloat(r.final_price||0);return s+n},0);a.useEffect(()=>{const e=G(i);S(e)},[i]),a.useEffect(()=>{f.current&&(f.current.value=p.toFixed(2))},[p]),a.useEffect(()=>{if(h.current){const e=i.map(s=>s.id.toString());$(h.current).val(e).trigger("change")}},[i]),a.useEffect(()=>{console.log("Main product changed:",o),console.log("Selected products:",i)},[o,i]);const M=e=>{const r=$(e.target).select2("data").map(n=>n.data);c(n=>{const g=n.map(u=>u.id),d=r.filter(u=>!g.includes(u.id));return[...n,...d]})},V=e=>{const s=i.filter(n=>n.id!==e);c(s);const r=s.map(n=>n.id.toString());$(h.current).val(r).trigger("change"),(o==null?void 0:o.id)===e&&x(null)},A=e=>{parseFloat(e.target.value||0)>p&&(D.fire("Error","El precio con descuento no puede ser mayor al precio acumulado.","error"),m.current.value="")},P=async e=>{var s;if(e!=null&&e.id){F(!0);const r=await j.get(e.id,["items"]);if(!r)return;N.current.value=r.id||"",w.current.value=r.name||"",f.current.value=r.price||0,m.current.value=r.discount||0,R.current.value=null,R.image.src=`/storage/images/combo/${(r==null?void 0:r.image)??"undefined"}`;const n=r.items||[],g=(s=r.items.find(u=>{var v;return(v=u.pivot)==null?void 0:v.is_main_item}))==null?void 0:s.id,d=g?n.find(u=>u.id===g):null;c(n),x(d),setTimeout(()=>{var v;const u=n.map(H=>H.id.toString());(v=h.current)!=null&&v.setValue&&h.current.setValue(u)},100)}else F(!1),N.current.value="",w.current.value="",f.current.value=0,m.current.value=0,c([]),x(null),S(0);$(C.current).modal("show")},q=async e=>{e.preventDefault();const s={id:N.current.value||void 0,name:w.current.value,price:p,discount:m.current.value,final_price:m.current.value>0&&m.current.value<p?m.current.value:p,discount_percent:100-m.current.value/f.current.value*100,items:i.map(d=>({item_id:d.id,is_main_item:(o==null?void 0:o.id)===d.id}))},r=new FormData;for(const d in s)r.append(d,s[d]);const n=R.current.files[0];n&&r.append("image",n),await j.save(r)&&($(b.current).dxDataGrid("instance").refresh(),$(C.current).modal("hide"),c([]),x(null),S(0))},O=async({id:e,value:s})=>{await j.boolean({id:e,field:"visible",value:s})&&$(b.current).dxDataGrid("instance").refresh()},z=async e=>{const{isConfirmed:s}=await D.fire({title:"Eliminar combo",text:"¿Estás seguro de eliminar este combo?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});!s||!await j.delete(e)||$(b.current).dxDataGrid("instance").refresh()};return t.jsxs(t.Fragment,{children:[t.jsx(X,{gridRef:b,title:"Combos",rest:j,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(b.current).dxDataGrid("instance").refresh()}}),e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",text:"Nuevo combo",hint:"Nuevo combo",onClick:()=>P()}})},exportable:!0,exportableName:"Combos",columns:[{dataField:"id",caption:"ID",visible:!1},{dataField:"name",caption:"Nombre",cellTemplate:(e,{data:s})=>{e.html(T.renderToString(t.jsxs(t.Fragment,{children:[t.jsx("b",{children:s.name}),t.jsx("br",{}),t.jsx("span",{className:"truncate",children:s.summary})]})))}},{dataField:"image",caption:"Imagen",width:"80px",cellTemplate:(e,{data:s})=>{_(e,t.jsx("img",{src:`/storage/images/combo/${s.image}`,style:{width:"80px",height:"48px",objectFit:"cover",objectPosition:"center",borderRadius:"4px"},onError:r=>r.target.src="/api/cover/thumbnail/null"}))}},{dataField:"final_price",caption:"Precio",dataType:"number",width:"100px",cellTemplate:(e,{data:s})=>{e.html(T.renderToString(t.jsxs(t.Fragment,{children:[s.discount>0&&t.jsxs("small",{className:"d-block text-muted",style:{textDecoration:"line-through"},children:["S/.",k(s.price)]}),t.jsxs("span",{children:["S/.",k(s.discount>0?s.discount:s.price)]})]})))}},{dataField:"visible",caption:"Visible",dataType:"boolean",width:"80px",cellTemplate:(e,{data:s})=>{_(e,t.jsx(Q,{checked:s.visible,onChange:r=>O({id:s.id,value:r.target.checked})}))}},{caption:"Acciones",width:"100px",cellTemplate:(e,{data:s})=>{e.css("text-overflow","unset"),e.append(I({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>P(s)})),e.append(I({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash",onClick:()=>z(s.id)}))},allowFiltering:!1,allowExporting:!1}]}),t.jsx(W,{modalRef:C,title:B?"Editar combo":"Agregar combo",onSubmit:q,size:"lg",children:t.jsxs("div",{className:"row",id:"combo-container",children:[t.jsx("input",{ref:N,type:"hidden"}),t.jsxs("div",{className:"col-md-6",children:[t.jsx(E,{eRef:w,label:"Nombre",required:!0}),t.jsx(E,{label:"Precio",eRef:f,type:"number",readOnly:!0}),t.jsx(E,{eRef:m,label:"Descuento",type:"number",step:"0.01",onChange:A}),t.jsx(Z,{id:"items",eRef:h,searchAPI:"/api/admin/items/paginate",searchBy:"name",label:"Productos",dropdownParent:"#combo-container",multiple:!0,onChange:M})]}),t.jsx("div",{className:"col-md-6",children:t.jsx(Y,{eRef:R,label:"Imagen del Combo",col:"col-12",aspect:"4/3",required:!0})}),t.jsxs("div",{className:"col-md-12 row",children:[t.jsx("h4",{className:"col-md-12",children:"Productos Seleccionados"}),t.jsx("ul",{className:"list-unstyled col-md-12 row",children:i.map(e=>t.jsxs("li",{className:"col-md-6",children:[t.jsxs("div",{className:"form-check mb-2",children:[t.jsx("input",{className:"form-check-input",type:"radio",name:"mainProduct",id:`mainProduct_${e.id}`,checked:(o==null?void 0:o.id)===e.id,onChange:()=>x(e)}),t.jsx("label",{className:"form-check-label",htmlFor:`mainProduct_${e.id}`,children:"Producto principal"})]}),t.jsx("div",{children:t.jsx("div",{className:"card mb-3",children:t.jsxs("div",{className:"row g-0",children:[t.jsx("div",{className:"col-md-4",children:t.jsx("img",{src:`/storage/images/item/${(e==null?void 0:e.image)??"undefined"}`,className:"img-thumbnail rounded-start",alt:e.name})}),t.jsx("div",{className:"col-md-8",children:t.jsxs("div",{className:"card-body",children:[t.jsxs("h5",{className:"card-title",children:[e==null?void 0:e.name," "]}),t.jsxs("p",{className:"card-text small line-clamp-2",children:[e==null?void 0:e.summary," "]}),t.jsx("p",{className:"card-text",children:t.jsxs("strong",{children:["Precio: S/.",e==null?void 0:e.final_price]})}),t.jsx("button",{className:"btn btn-sm btn-danger pull-left",type:"button",onClick:()=>V(e.id),children:"Eliminar"})]})})]})})})]},e.id))})]})]})})]})};ee((l,i)=>{U.createRoot(l).render(t.jsx(L,{...i,title:"Combos",children:t.jsx(re,{...i})}))});
