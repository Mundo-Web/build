import{j as x}from"./AboutSimple-Cf8x2fCZ.js";import"./index-BOnQTV8N.js";import{L as j}from"./loader-circle-CSFYLd5m.js";import{m as h}from"./main-B6F2O9-U.js";import{G as a}from"./Global-Bz6gVLc5.js";import{G as b}from"./General-CE1RDd44.js";import{t as p}from"./CardProductKatya-ncpmQ0JU.js";const le=({children:e,className:r="",loading:o=!1,disabled:n=!1,...s})=>x.jsxs("button",{type:"button",disabled:n||o,className:`w-full bg-primary font-bold  py-3 px-4 hover:opacity-90 hover:shadow-md transition-all duration-300 focus:outline-none active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed rounded-xl flex items-center justify-center gap-2 ${r}`,...s,children:[o&&x.jsx(j,{className:"w-4 h-4 animate-spin"}),e]});class de{static async validateCoupon(r){try{const{status:o,result:n}=await h.Fetch("./api/coupons/validate",{method:"POST",body:JSON.stringify(r)});if(!o)throw new Error((n==null?void 0:n.message)||"Error al validar cup√≥n");return n}catch(o){throw o}}static async generateCode(){try{const{status:r,result:o}=await h.Fetch("./api/coupons/generate-code",{method:"GET"});if(!r)throw new Error((o==null?void 0:o.message)||"Error al generar c√≥digo");return o}catch(r){throw r}}}const y={initialized:!1,deviceFingerPrint:null,isAvailable(){return typeof window.Culqi3DS<"u"},async init(e){if(!this.isAvailable())return console.warn("‚ö†Ô∏è Culqi3DS no est√° cargado"),!1;try{return window.Culqi3DS.publicKey=a.CULQI_PUBLIC_KEY,window.Culqi3DS.settings={charge:{totalAmount:e.amount,returnUrl:window.location.href,currency:e.currency||"PEN"},card:{email:e.email}},window.Culqi3DS.options={showModal:!0,showLoading:!0,showIcon:!0,closeModalAction:()=>{console.log("üîê Modal 3DS cerrado")},style:{btnColor:a.APP_COLOR_PRIMARY||"#000000",btnTextColor:"#FFFFFF"}},this.initialized=!0,console.log("‚úÖ Culqi3DS inicializado correctamente"),!0}catch(r){return console.error("‚ùå Error al inicializar Culqi3DS:",r),!1}},async generateDeviceFingerPrint(){if(!this.isAvailable())return console.warn("‚ö†Ô∏è Culqi3DS no disponible para generar device fingerprint"),null;try{return this.deviceFingerPrint=await window.Culqi3DS.generateDevice(),console.log("üîê Device Fingerprint generado:",this.deviceFingerPrint),this.deviceFingerPrint}catch(e){return console.error("‚ùå Error al generar device fingerprint:",e),null}},initAuthentication(e){return new Promise((r,o)=>{if(!this.isAvailable()){o(new Error("Culqi3DS no est√° disponible"));return}console.log("üîê Iniciando autenticaci√≥n 3DS para token:",e);const n=s=>{const l=s.data;!l||typeof l!="object"||(l.loading!==void 0&&console.log("üîê 3DS Loading:",l.loading),l.parameters3DS&&(console.log("‚úÖ Autenticaci√≥n 3DS exitosa:",l.parameters3DS),window.removeEventListener("message",n),r({success:!0,parameters3DS:l.parameters3DS})),l.error&&(console.error("‚ùå Error en autenticaci√≥n 3DS:",l.error),window.removeEventListener("message",n),o(new Error(l.error))))};window.addEventListener("message",n,!1);try{window.Culqi3DS.initAuthentication(e)}catch(s){window.removeEventListener("message",n),o(s)}})},reset(){this.isAvailable()&&typeof window.Culqi3DS.reset=="function"&&(window.Culqi3DS.reset(),this.deviceFingerPrint=null,this.initialized=!1,console.log("üîÑ Culqi3DS reseteado"))}},G={async createOrder(e,r){try{console.log("üîÑ Creando orden en Culqi API...");const{status:o,result:n}=await h.Fetch("/api/culqi/order",{method:"POST",body:JSON.stringify({sale:e,details:r})});if(!o)throw console.error("‚ùå Error al crear orden en Culqi:",n),new Error((n==null?void 0:n.message)||"Error al crear orden en Culqi");return console.log("‚úÖ Orden creada en Culqi:",n),n}catch(o){throw console.error("‚ùå Exception al crear orden:",o),o}},async createCheckoutOrder(e){try{console.log("üîÑ Creando orden de checkout en Culqi...",e);const{status:r,result:o}=await h.Fetch("/api/culqi/checkout-order",{method:"POST",body:JSON.stringify(e)});if(!r)throw console.error("‚ùå Error al crear orden de checkout:",o),new Error((o==null?void 0:o.message)||"Error al crear orden de checkout en Culqi");return console.log("‚úÖ Orden de checkout creada:",o),o}catch(r){throw console.error("‚ùå Exception al crear orden de checkout:",r),r}}};function z(){let e="";for(let r=0;r<12;r++){const o=Math.floor(Math.random()*10);e+=o}return e}function R(){return a.CULQI_SUPPORTS_USD===!0}function J(){const e=b.get("currency")||"pen";return R()&&e.toLowerCase()==="usd"?"USD":(e.toLowerCase()==="pen","PEN")}function V(){return J()==="USD"?"$":"S/"}function W(){const e=a.EXCHANGE_RATE||b.get("exchange_rate_usd_pen")||3.75;return parseFloat(e)}function H(e){const r=b.get("currency")||"pen";if(r.toLowerCase()==="pen")return{amount:e,currency:"PEN",wasConverted:!1,exchangeRate:1,originalAmount:e,originalCurrency:"PEN"};if(r.toLowerCase()==="usd"&&R())return console.log("üíµ Culqi soporta USD - procesando pago directamente en d√≥lares"),{amount:e,currency:"USD",wasConverted:!1,exchangeRate:1,originalAmount:e,originalCurrency:"USD"};if(r.toLowerCase()==="usd"&&!R()){const o=W(),n=e*o;return console.log("üí± Conversi√≥n de moneda (Culqi no soporta USD):"),console.log(`   - Monto original: USD ${e.toFixed(2)}`),console.log(`   - Tipo de cambio: 1 USD = ${o} PEN`),console.log(`   - Monto convertido: PEN ${n.toFixed(2)}`),{amount:n,currency:"PEN",wasConverted:!0,exchangeRate:o,originalAmount:e,originalCurrency:"USD"}}return{amount:e,currency:r.toUpperCase(),wasConverted:!1,exchangeRate:1,originalAmount:e,originalCurrency:r.toUpperCase()}}let t=null;function X(){const e=a.CULQI_RSA_ID,r=a.CULQI_RSA_PUBLIC_KEY;if(console.log("üîê Verificando configuraci√≥n RSA..."),console.log("   - RSA ID presente:",!!e),console.log("   - RSA Public Key presente:",!!r),!e||!r)return console.warn("‚ö†Ô∏è RSA no configurado - Usando encriptaci√≥n est√°ndar de Culqi"),{valid:!0,hasRSA:!1,warning:"RSA no configurado - Usando encriptaci√≥n est√°ndar de Culqi (segura)"};if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e))return console.warn("‚ö†Ô∏è RSA ID no tiene formato UUID v√°lido:",e),console.warn("‚ö†Ô∏è Deshabilitando RSA - Usando encriptaci√≥n est√°ndar"),{valid:!0,hasRSA:!1,warning:"RSA ID inv√°lido - Usando encriptaci√≥n est√°ndar de Culqi"};const n=r.includes("-----BEGIN PUBLIC KEY-----"),s=r.includes("-----END PUBLIC KEY-----");return!n||!s?(console.warn("‚ö†Ô∏è RSA Public Key no tiene formato PEM v√°lido"),console.warn("‚ö†Ô∏è Deshabilitando RSA - Usando encriptaci√≥n est√°ndar"),{valid:!0,hasRSA:!1,warning:"RSA Public Key formato inv√°lido - Usando encriptaci√≥n est√°ndar de Culqi"}):(console.log("   - RSA Key length:",r.length,"caracteres"),r.includes("MIGf")?console.log("   - Tipo de clave: RSA 1024-bit (formato MIGf)"):r.includes("MIIBIj")?console.log("   - Tipo de clave: RSA 2048-bit (formato MIIBIj)"):console.log("   - Tipo de clave: Formato RSA est√°ndar"),console.log("‚úÖ RSA configurado correctamente"),console.log("   - RSA ID:",e),console.log("   - RSA Key length:",r.length),{valid:!0,hasRSA:!0,info:"RSA configurado correctamente para encriptaci√≥n adicional"})}const ue=async(e,r={})=>{if(!r.orderId&&!r.skipOrderCreation)try{console.log("üîÑ Intentando crear orden de Culqi para habilitar todos los m√©todos de pago...");const o=await G.createCheckoutOrder({amount:e.amount,email:e.email,name:e.name,lastname:e.lastname,phone:e.phone});console.log("üì¶ Respuesta de createCheckoutOrder:",o);const n=(o==null?void 0:o.data)||o,s=n==null?void 0:n.order_id;s?(console.log("‚úÖ Orden de checkout creada con ID:",s),r.orderId=s,r.orderData=n):(console.warn("‚ö†Ô∏è No se pudo obtener order_id de la respuesta:",o),console.warn("‚ö†Ô∏è Continuando solo con tarjeta"))}catch(o){console.warn("‚ö†Ô∏è Error al crear orden de checkout, continuando solo con tarjeta:",o.message)}return new Promise((o,n)=>{var s,l,q,_;try{console.log("üîÑ Iniciando proceso de pago con Culqi Custom Checkout...",e),console.log("üìã Opciones recibidas:",r);const{orderId:C,orderData:Z}=r,D=!!C;if(D?(console.log("‚úÖ Flujo con Order ID - M√©todos adicionales habilitados (Yape, etc.)"),console.log("   - Order ID:",C)):console.log("‚ÑπÔ∏è Flujo sin Order - Solo pago con tarjeta disponible"),!a.CULQI_ENABLED){console.error("‚ùå Error: Culqi no est√° habilitado en la configuraci√≥n"),n("M√©todo de pago no disponible: Culqi est√° deshabilitado");return}if(typeof window.CulqiCheckout>"u"){console.error("‚ùå Error: CulqiCheckout no est√° definido. Verifique que el script de Culqi est√© cargado."),console.error("   Script esperado: https://js.culqi.com/checkout-js"),n("Error en la integraci√≥n con Culqi: Script no cargado");return}if(!a.CULQI_PUBLIC_KEY){console.error("‚ùå Error: CULQI_PUBLIC_KEY no est√° configurado"),n("Error de configuraci√≥n: Clave p√∫blica de Culqi no encontrada");return}const E=X();E.warning&&console.warn("‚ö†Ô∏è RSA:",E.warning),E.hasRSA?console.log("üîê RSA validado correctamente - Encriptaci√≥n adicional activada"):console.log("üîì RSA no disponible - Usando encriptaci√≥n est√°ndar de Culqi (segura)"),console.log("üîß Configuraci√≥n de Culqi:"),console.log("   - Public Key:",a.CULQI_PUBLIC_KEY),console.log("   - Public Key comienza con pk_:",(s=a.CULQI_PUBLIC_KEY)==null?void 0:s.startsWith("pk_")),console.log("   - RSA disponible:",E.hasRSA),E.hasRSA&&(console.log("   - RSA ID:",a.CULQI_RSA_ID),console.log("   - RSA ID length:",(l=a.CULQI_RSA_ID)==null?void 0:l.length));const T=(q=a.CULQI_PUBLIC_KEY)==null?void 0:q.startsWith("pk_test_"),B=(_=a.CULQI_PUBLIC_KEY)==null?void 0:_.startsWith("pk_live_");console.log("   - Modo de Culqi:",T?"PRUEBAS (test)":B?"PRODUCCI√ìN (live)":"DESCONOCIDO");const U=b.get("currency")||"pen";console.log("üí± Moneda del sistema:",U.toUpperCase()),console.log("üíµ Culqi soporta USD:",R());const d=H(e.amount);d.wasConverted?(console.log("üí± Se realizar√° conversi√≥n autom√°tica de moneda:"),console.log(`   - Monto original: ${d.originalCurrency} ${d.originalAmount.toFixed(2)}`),console.log(`   - Tipo de cambio: 1 ${d.originalCurrency} = ${d.exchangeRate} PEN`),console.log(`   - Monto a cobrar: PEN ${d.amount.toFixed(2)}`),p.info("Conversi√≥n de moneda",{description:`Tu pago de $${d.originalAmount.toFixed(2)} USD ser√° procesado como S/${d.amount.toFixed(2)} PEN (TC: ${d.exchangeRate})`,duration:5e3})):d.currency==="USD"&&console.log("üíµ Pago directo en USD - Sin conversi√≥n");const A=z();console.log("üìù N√∫mero de orden generado:",A);const w=d.currency,ee=V(),L=parseFloat(d.amount.toFixed(2)),P=Math.round(L*100),K=w==="USD"?100:300,O=w==="USD"?"$1.00":"S/ 3.00";if(P<K){console.error(`‚ùå Error: El monto m√≠nimo para Culqi es ${O}`),n(`El monto m√≠nimo para pago con tarjeta es ${O}`);return}console.log("üí∞ Configurando Culqi Custom Checkout:"),console.log("   - Monto original:",e.amount,U.toUpperCase()),console.log("   - Monto a procesar:",L,"PEN"),console.log("   - Moneda Culqi:",w),console.log("   - Monto en c√©ntimos:",P),console.log("   - Email:",e.email),console.log("   - CULQI_NAME:",a.CULQI_NAME),console.log("   - RSA configurado:",!!a.CULQI_RSA_ID);const k={title:a.CULQI_NAME||a.APP_NAME||"Pago",currency:w,amount:P};!!0&&E.hasRSA||console.log("üîì RSA deshabilitado - usando encriptaci√≥n est√°ndar de Culqi");const Y={email:e.email||""},F=D?{tarjeta:!0,yape:!0,bancaMovil:!0,agente:!0,billetera:!0,cuotealo:!1}:{tarjeta:!0,yape:!1,bancaMovil:!1,agente:!1,billetera:!1,cuotealo:!1};console.log("üí≥ M√©todos de pago habilitados:",F);const Q={lang:"auto",installments:!1,modal:!0,paymentMethods:F,paymentMethodsSort:D?["tarjeta","yape","bancaMovil","billetera","agente"]:["tarjeta"]},$={theme:"default",hiddenCulqiLogo:!1,hiddenBannerContent:!1,hiddenBanner:!1,hiddenToolBarAmount:!1,menuType:"sidebar",buttonCardPayText:"Pagar",logo:a.APP_URL+"/assets/resources/icon.png",defaultStyle:{bannerColor:a.APP_COLOR_PRIMARY||"#000000",buttonBackground:a.APP_COLOR_PRIMARY||"#000000",menuColor:a.APP_COLOR_PRIMARY||"#000000",linksColor:a.APP_COLOR_PRIMARY||"#000000",buttonTextColor:"#FFFFFF",priceColor:a.APP_COLOR_PRIMARY||"#000000"}};D&&(k.order=C,console.log("üì¶ Order ID agregado a settings:",C));const M={settings:k,client:Y,options:Q,appearance:$};console.log("üìã Configuraci√≥n de Culqi Custom Checkout:",M);try{t=new window.CulqiCheckout(a.CULQI_PUBLIC_KEY,M),console.log("‚úÖ Instancia de CulqiCheckout creada exitosamente")}catch(i){console.error("‚ùå Error al crear instancia de CulqiCheckout:",i),n("Error en la integraci√≥n con Culqi: "+i.message);return}let v=!1;t.culqi=async function(){try{if(console.log("üì• Callback de Culqi ejecutado"),console.log("   - culqiInstance.token:",t.token),console.log("   - culqiInstance.charge:",t.charge),console.log("   - culqiInstance.order:",t.order),console.log("   - culqiInstance.error:",t.error),t.error){console.error("‚ùå Error de Culqi:",t.error);const i=t.error.user_message||t.error.merchant_message||"Error al procesar el pago";p.error("Error en el pago",{description:i,duration:5e3,position:"top-right",richColors:!0}),n(i);return}if(t.charge){v=!0;const i=t.charge;console.log("‚úÖ Cargo completado por Culqi (3DS incluido):",i);const m={...e,chargeId:i.id,orderNumber:A,chargeData:i,paymentType:"charge_completed"};console.log("üì§ Enviando cargo completado al backend:",m);const{status:f,result:c}=await h.Fetch("./api/pago/charge-completed",{method:"POST",body:JSON.stringify(m)});try{t.close()}catch(S){console.warn("‚ö†Ô∏è No se pudo cerrar el modal de Culqi:",S)}if(!f){console.error("‚ùå Error en respuesta del servidor:",c),p.error("Error al registrar el pago",{description:(c==null?void 0:c.message)||"Error al registrar el pago",duration:5e3,position:"top-right",richColors:!0}),n((c==null?void 0:c.message)||"Error al registrar el pago");return}p.success("¬°Pago exitoso!",{description:"Tu pago se proces√≥ correctamente con autenticaci√≥n 3DS.",duration:3e3,position:"top-right",richColors:!0}),o(c);return}if(t.token){v=!0;const i=t.token.id,m=t.token;console.log("‚úÖ Token generado:",i),console.log("   - Token completo:",m);let f=null;y.isAvailable()&&(await y.init({amount:P,currency:w,email:e.email}),f=await y.generateDeviceFingerPrint(),console.log("üîê Device Fingerprint para 3DS:",f));const c={...e,token:i,orderNumber:A,tokenData:m,deviceFingerPrint:f};console.log("üì§ Enviando pago al backend:",c);let{status:S,result:u}=await h.Fetch("./api/pago",{method:"POST",body:JSON.stringify(c)});if(!S&&(u!=null&&u.requires_3ds)){console.log("üîê El pago requiere autenticaci√≥n 3DS");try{console.log("üîê Cerrando modal de Culqi para mostrar 3DS..."),t.close()}catch(g){console.warn("‚ö†Ô∏è No se pudo cerrar modal de Culqi:",g)}if(!y.isAvailable()){p.error("Error en autenticaci√≥n",{description:"El servicio de autenticaci√≥n 3DS no est√° disponible. Por favor recarga la p√°gina.",duration:5e3,position:"top-right",richColors:!0}),n("Servicio 3DS no disponible");return}try{p.info("Autenticaci√≥n requerida",{description:"Por favor completa la verificaci√≥n de seguridad de tu banco.",duration:5e3,position:"top-right",richColors:!0}),await new Promise(I=>setTimeout(I,300));const g=await y.initAuthentication(i);if(g.success&&g.parameters3DS){console.log("‚úÖ Autenticaci√≥n 3DS completada:",g.parameters3DS);const I={...c,authentication_3DS:g.parameters3DS};console.log("üì§ Enviando cargo con autenticaci√≥n 3DS:",I);const N=await h.Fetch("./api/pago/3ds",{method:"POST",body:JSON.stringify(I)});S=N.status,u=N.result,y.reset()}}catch(g){console.error("‚ùå Error en autenticaci√≥n 3DS:",g),y.reset(),p.error("Error en autenticaci√≥n",{description:g.message||"No se pudo completar la autenticaci√≥n 3DS",duration:5e3,position:"top-right",richColors:!0}),n(g.message||"Error en autenticaci√≥n 3DS");return}}if(!S){console.error("‚ùå Error en respuesta del servidor:",u),p.error("Error en el pago",{description:(u==null?void 0:u.message)||"Error al procesar el pago",duration:5e3,position:"top-right",richColors:!0}),n((u==null?void 0:u.message)||"Error en el pago");return}try{t.close()}catch(g){console.warn("‚ö†Ô∏è No se pudo cerrar el modal de Culqi:",g)}p.success("¬°Pago exitoso!",{description:"Tu pago se proces√≥ correctamente. Pronto recibir√°s la confirmaci√≥n.",duration:3e3,position:"top-right",richColors:!0}),o(u);return}if(t.order){v=!0,console.log("‚úÖ Orden creada:",t.order);const i=t.order,m={...e,orderId:i.id,orderNumber:A,orderData:i,paymentType:"order"};console.log("üì§ Enviando orden al backend:",m);const{status:f,result:c}=await h.Fetch("./api/pago/order",{method:"POST",body:JSON.stringify(m)});try{t.close()}catch(S){console.warn("‚ö†Ô∏è No se pudo cerrar el modal de Culqi:",S)}if(f)p.success("¬°Orden creada!",{description:"Tu orden ha sido registrada. Completa el pago seg√∫n las instrucciones.",duration:5e3,position:"top-right",richColors:!0}),o(c);else throw new Error((c==null?void 0:c.message)||"Error al procesar la orden");return}console.warn("‚ö†Ô∏è Callback ejecutado sin token, orden ni error"),n("No se recibi√≥ respuesta del procesador de pagos")}catch(i){console.error("‚ùå Error en callback de Culqi:",i),p.error("¬°Error en el Pago!",{description:i.message||"Error desconocido",duration:3e3,position:"top-right",richColors:!0}),n(i.message||"Error en el pago")}},console.log("üöÄ Abriendo Culqi Custom Checkout..."),t.open()}catch(C){console.error("‚ùå Error general en processCulqiPayment:",C),p.error("¬°Error en la integraci√≥n con Culqi!",{description:C.message||"Error desconocido",duration:3e3,position:"top-right",richColors:!0}),n("Error en la integraci√≥n con Culqi: "+C.message)}})};export{le as B,de as C,ue as p};
