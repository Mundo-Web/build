var J=Object.defineProperty;var K=(d,n,m)=>n in d?J(d,n,{enumerable:!0,configurable:!0,writable:!0,value:m}):d[n]=m;var y=(d,n,m)=>K(d,typeof n!="symbol"?n+"":n,m);import{j as r}from"./AboutSimple-Cf8x2fCZ.js";import{B as L}from"./Base-DKjYZsUF.js";import{S as Q}from"./SwitchFormGroup-B-vmnVqk.js";import{r as a}from"./index-BOnQTV8N.js";import{c as U}from"./ReactAppend-DTVVXReZ.js";import{s as T}from"./server.browser-Bf4gQIc7.js";import{S as D}from"./ProductCard-Lp5WfZrB.js";import{M as W}from"./Modal-BYL-UsqM.js";import{T as X}from"./Table-CCZDHBJ5.js";import{I as Y}from"./ImageFormGroup-Brimgjsn.js";import{I as P}from"./InputFormGroup-iZIO11ZN.js";import{S as Z}from"./SelectAPIFormGroup-1XgklNMJ.js";import{D as _}from"./DxButton-DV0H-ZcL.js";import{C as ee}from"./CreateReactScript-DlXLjWSJ.js";import{N as B}from"./Number2Currency-B5ZenVq9.js";import{R as k}from"./ReactAppend-D7S498fx.js";import"./main-DKOTUah5.js";import"./index-DRg3WPTA.js";import{B as te}from"./BasicRest-BCYKfs4R.js";import"./index-yBjzXJbu.js";import"./Global-DWbVqTT_.js";import"./tippy-react.esm-Ce0cOK54.js";import"./index-C0Swrixi.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./index-fNjTmf9T.js";/* empty css              */import"./Logout-W0zm0J8x.js";import"./MenuItemContainer-CEON2wjZ.js";import"./index.esm-BNsoPXs8.js";import"./index-NIGUFBhG.js";import"./___vite-browser-external_commonjs-proxy-DDYoOVPM.js";import"./CanAccess-DKJVq_mE.js";/* empty css               */import"./General-BmbBKdsB.js";import"./LaravelSession-Dz9cpV3l.js";class re extends te{constructor(){super(...arguments);y(this,"path","admin/combos");y(this,"hasFiles",!0)}}const v=new re,se=({items:d})=>{const[n,m]=a.useState([]),[u,x]=a.useState(null),[h,C]=a.useState(0),b=a.useRef(),S=a.useRef(),j=a.useRef(),w=a.useRef(),g=a.useRef(),p=a.useRef(),f=a.useRef(),R=a.useRef(),[G,N]=a.useState(!1),M=e=>e.reduce((t,s)=>{const o=parseFloat(s.final_price||0);return t+o},0);a.useEffect(()=>{const e=M(n);C(e)},[n]),a.useEffect(()=>{g.current&&(g.current.value=h.toFixed(2))},[h]);const V=e=>{const s=$(e.target).select2("data").map(o=>o.data);m(o=>{const c=o.map(l=>l.id),i=s.filter(l=>!c.includes(l.id));return[...o,...i]})},A=e=>{const t=n.filter(s=>s.id!==e);if(m(t),f.current){const s=t.map(o=>o.id.toString());$(f.current).val(s)}(u==null?void 0:u.id)===e&&x(null)},q=e=>{parseFloat(e.target.value||0)>h&&(D.fire("Error","El precio con descuento no puede ser mayor al precio acumulado.","error"),p.current.value="")},F=async e=>{if(e!=null&&e.id){N(!0);const t=await v.get(e.id,["items"]);if(!t)return;j.current.value=t.id||"",w.current.value=t.name||"",g.current.value=t.price||0,p.current.value=t.discount||0,R.current.value=null,R.image.src=`/storage/images/combo/${(t==null?void 0:t.image)??"undefined"}`;const s=t.items||[];console.log("Combo data items:",t.items),console.log("Products loaded:",s);const o=t.items.find(c=>{var I;const i=(I=c.pivot)==null?void 0:I.is_main_item,l=c.is_main_item,E=i===1||i==="1"||i===!0||i==="true"||l===1||l==="1"||l===!0||l==="true";return console.log(`Product ${c.id} (${c.name}):`,{pivotValue:i,directValue:l,isMainItem:E,rawPivot:c.pivot}),E});console.log("Main item found:",o),m(s),setTimeout(()=>{if(o){const c=s.find(i=>parseInt(i.id)===parseInt(o.id));console.log("Setting main product to:",c),x(c)}else console.log("No main product found, clearing mainProduct"),x(null)},50),setTimeout(()=>{if(f.current){const c=s.map(i=>i.id.toString());$(f.current).val(c)}},100)}else N(!1),m([]),x(null),C(0),j.current.value="",w.current.value="",g.current.value=0,p.current.value=0,f.current&&$(f.current).val([]);$(S.current).modal("show")},O=async e=>{e.preventDefault();const t={id:j.current.value||void 0,name:w.current.value,price:h,discount:p.current.value,final_price:p.current.value>0&&p.current.value<h?p.current.value:h,discount_percent:100-p.current.value/g.current.value*100},s=new FormData;for(const i in t)t[i]!==void 0&&s.append(i,t[i]);n.forEach((i,l)=>{s.append(`items[${l}][item_id]`,i.id),s.append(`items[${l}][is_main_item]`,(u==null?void 0:u.id)===i.id?1:0)});const o=R.current.files[0];o&&s.append("image",o),await v.save(s)&&($(b.current).dxDataGrid("instance").refresh(),$(S.current).modal("hide"),m([]),x(null),C(0),f.current&&$(f.current).val([]))},z=async({id:e,value:t})=>{await v.boolean({id:e,field:"visible",value:t})&&$(b.current).dxDataGrid("instance").refresh()},H=async e=>{const{isConfirmed:t}=await D.fire({title:"Eliminar combo",text:"¿Estás seguro de eliminar este combo?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});!t||!await v.delete(e)||$(b.current).dxDataGrid("instance").refresh()};return r.jsxs(r.Fragment,{children:[r.jsx(X,{gridRef:b,title:"Combos",rest:v,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(b.current).dxDataGrid("instance").refresh()}}),e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",text:"Nuevo combo",hint:"Nuevo combo",onClick:()=>F()}})},exportable:!0,exportableName:"Combos",columns:[{dataField:"id",caption:"ID",visible:!1},{dataField:"name",caption:"Nombre",cellTemplate:(e,{data:t})=>{e.html(T.renderToString(r.jsxs(r.Fragment,{children:[r.jsx("b",{children:t.name}),r.jsx("br",{}),r.jsx("span",{className:"truncate",children:t.summary})]})))}},{dataField:"image",caption:"Imagen",width:"80px",cellTemplate:(e,{data:t})=>{k(e,r.jsx("img",{src:`/storage/images/combo/${t.image}`,style:{width:"80px",height:"48px",objectFit:"cover",objectPosition:"center",borderRadius:"4px"},onError:s=>s.target.src="/api/cover/thumbnail/null"}))}},{dataField:"final_price",caption:"Precio",dataType:"number",width:"100px",cellTemplate:(e,{data:t})=>{e.html(T.renderToString(r.jsxs(r.Fragment,{children:[t.discount>0&&r.jsxs("small",{className:"d-block text-muted",style:{textDecoration:"line-through"},children:["S/.",B(t.price)]}),r.jsxs("span",{children:["S/.",B(t.discount>0?t.discount:t.price)]})]})))}},{dataField:"visible",caption:"Visible",dataType:"boolean",width:"80px",cellTemplate:(e,{data:t})=>{k(e,r.jsx(Q,{checked:t.visible,onChange:s=>z({id:t.id,value:s.target.checked})}))}},{caption:"Acciones",width:"100px",cellTemplate:(e,{data:t})=>{e.css("text-overflow","unset"),e.append(_({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>F(t)})),e.append(_({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash",onClick:()=>H(t.id)}))},allowFiltering:!1,allowExporting:!1}]}),r.jsx(W,{modalRef:S,title:G?"Editar combo":"Agregar combo",onSubmit:O,size:"lg",children:r.jsxs("div",{className:"row",id:"combo-container",children:[r.jsx("input",{ref:j,type:"hidden"}),r.jsxs("div",{className:"col-md-6",children:[r.jsx(P,{eRef:w,label:"Nombre",required:!0}),r.jsx(P,{label:"Precio",eRef:g,type:"number",readOnly:!0}),r.jsx(P,{eRef:p,label:"Descuento",type:"number",step:"0.01",onChange:q}),r.jsx(Z,{id:"items",eRef:f,searchAPI:"/api/admin/items/paginate",searchBy:"name",label:"Productos",dropdownParent:"#combo-container",multiple:!0,onChange:V})]}),r.jsx("div",{className:"col-md-6",children:r.jsx(Y,{eRef:R,label:"Imagen del Combo",col:"col-12",aspect:"4/3",required:!0})}),r.jsxs("div",{className:"col-md-12 row",children:[r.jsx("h4",{className:"col-md-12",children:"Productos Seleccionados"}),r.jsx("ul",{className:"list-unstyled col-md-12 row",children:n.map(e=>{const t=u&&(parseInt(u.id)===parseInt(e.id)||u.id===e.id);return r.jsxs("li",{className:"col-md-6",children:[r.jsx("input",{type:"radio",name:"mainProduct",checked:t,onChange:()=>{console.log("Setting main product to:",e),x(e)}}),r.jsx("div",{children:r.jsx("div",{class:"card mb-3",children:r.jsxs("div",{class:"row g-0",children:[r.jsx("div",{class:"col-md-4",children:r.jsx("img",{src:`/storage/images/item/${(e==null?void 0:e.image)??"undefined"}`,class:"img-thumbnail rounded-start",alt:e.name})}),r.jsx("div",{class:"col-md-8",children:r.jsxs("div",{class:"card-body",children:[r.jsxs("h5",{class:"card-title",children:[e==null?void 0:e.name," "]}),r.jsxs("p",{class:"card-text small line-clamp-2",children:[e==null?void 0:e.summary," "]}),r.jsx("p",{class:"card-text",children:r.jsxs("strong",{children:["Precio: S/.",e==null?void 0:e.final_price]})}),r.jsx("button",{className:"btn btn-sm btn-danger pull-left",type:"button",onClick:()=>A(e.id),children:"Eliminar"})]})})]})})})]},e.id)})})]})]})})]})};ee((d,n)=>{U.createRoot(d).render(r.jsx(L,{...n,title:"Combos",children:r.jsx(se,{...n})}))});
