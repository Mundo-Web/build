var L=Object.defineProperty;var z=(m,g,f)=>g in m?L(m,g,{enumerable:!0,configurable:!0,writable:!0,value:f}):m[g]=f;var A=(m,g,f)=>z(m,typeof g!="symbol"?g+"":g,f);import{j as t}from"./AboutSimple-Cf8x2fCZ.js";import{B as P}from"./Base-GfEhzAjp.js";import{S as M}from"./SwitchFormGroup-DXN0cwVk.js";import{T as q}from"./TextareaFormGroup-CliirJM1.js";import{r as b}from"./index-BOnQTV8N.js";import{c as H}from"./ReactAppend-QR5TrZfj.js";import{S as O}from"./CartKuchara-D9l7c7at.js";import{B as U}from"./BasicRest-BML1C-ua.js";import{I as _}from"./ImageFormGroup-40MuGzez.js";import{P as K}from"./plus-CTIomuuF.js";import{I as Q}from"./image-BPmHvEaV.js";import{M as W,a as X}from"./move-up-Gz4AiwKb.js";import{T as Y}from"./trash-2-DU7LB6-f.js";import{S as Z}from"./SelectAPIFormGroup-BZe8H0Ph.js";import{M as ee}from"./Modal-xDw9ufjg.js";import{T as te}from"./Table-Cv1BshIS.js";import{D as V}from"./DxButton-DV0H-ZcL.js";import{C as re,F,h as se}from"./CreateReactScript-Bqovr-Zn.js";import{R as k}from"./ReactAppend-Vm5G2nof.js";import{B as w}from"./BooleanLimit-D-OsQsek.js";import{I as G}from"./InputFormGroup-iZIO11ZN.js";import{S as ne}from"./SetSelectValue-UxyCmHse.js";import"./index-yBjzXJbu.js";import"./Global-CazroCzF.js";import"./tippy-react.esm-DmkRJDEW.js";import"./index-pSueRYGM.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./index-B6ujFmsw.js";/* empty css              */import"./Logout-BpuTJ_83.js";import"./main-B6F2O9-U.js";import"./___vite-browser-external_commonjs-proxy-DDYoOVPM.js";import"./MenuItemContainer-DcxtOi47.js";import"./index.esm-C48oHfFw.js";import"./index-ngrFHoWO.js";import"./CanAccess-BlvzCYjQ.js";import"./CardProductKatya-ncpmQ0JU.js";import"./createLucideIcon-DfjclApS.js";/* empty css               */import"./General-apRuNwp7.js";import"./LaravelSession-Dz9cpV3l.js";class oe extends U{constructor(){super(...arguments);A(this,"path","admin/categories");A(this,"hasFiles",!0)}}const J=b.forwardRef(({name:m="banners",label:g="Banners",initialValue:f=[],model:I="category"},E)=>{const[u,y]=b.useState([]),[i,p]=b.useState({}),l=b.useRef({});b.useImperativeHandle(E,()=>({getValue:()=>JSON.stringify(u),setValue:s=>{console.log("BannersJsonEditor.setValue called with:",s,"type:",typeof s);try{const n=typeof s=="string"?JSON.parse(s):s;if(console.log("Parsed value:",n,"is array:",Array.isArray(n)),y(Array.isArray(n)?n:[]),console.log("setBanners called, should trigger re-render"),Array.isArray(n)&&n.length>0){const a={};n.forEach((c,e)=>{a[e]=!0}),p(a)}}catch(n){console.error("Error setting banners:",n),y([])}},reset:()=>{y([]),l.current={}},getImageRefs:()=>l.current,getImageFiles:()=>{const s={};return console.log("getImageFiles - imageRefs.current:",l.current),Object.keys(l.current).forEach(n=>{var c,e;const a=l.current[n];console.log(`getImageFiles - index ${n}:`,a),(e=(c=a==null?void 0:a.current)==null?void 0:c.files)!=null&&e[0]&&(s[`banner_image_${n}`]=a.current.files[0],console.log(`getImageFiles - Added file for banner_image_${n}:`,a.current.files[0].name))}),console.log("getImageFiles - Final files object:",s),s}}));const C=()=>{const s={image:"",title:"",description:"",button_text:"",button_link:""},n=[...u,s];y(n),p({...i,[n.length-1]:!0}),l.current[n.length-1]={current:null}},S=async s=>{const{isConfirmed:n}=await O.fire({title:"¿Eliminar banner?",text:"Esta acción no se puede deshacer",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});if(n){const a=u.filter((r,o)=>o!==s);y(a),delete l.current[s];const c={};Object.keys(l.current).forEach(r=>{const o=parseInt(r);o>s?c[o-1]=l.current[r]:o<s&&(c[o]=l.current[r])}),l.current=c;const e={};Object.keys(i).forEach(r=>{const o=parseInt(r);o<s?e[o]=i[r]:o>s&&(e[o-1]=i[r])}),p(e)}},D=(s,n)=>{const a=n==="up"?s-1:s+1;if(a<0||a>=u.length)return;const c=[...u];[c[s],c[a]]=[c[a],c[s]],y(c);const e=l.current[s];l.current[s]=l.current[a],l.current[a]=e;const r=i[s],o=i[a];p({...i,[s]:o,[a]:r})},N=(s,n,a)=>{const c=[...u];c[s]={...c[s],[n]:a},y(c)},T=s=>{p({...i,[s]:!i[s]})};return t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"font-weight-bold mb-2",children:g}),t.jsxs("div",{className:"border rounded p-3 bg-light",children:[t.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[t.jsxs("small",{className:"text-muted",children:[u.length," banner",u.length!==1?"s":""," configurado",u.length!==1?"s":""]}),t.jsxs("button",{type:"button",className:"btn btn-sm btn-primary",onClick:C,children:[t.jsx(K,{size:16,className:"mr-1"}),"Agregar Banner"]})]}),u.length===0?t.jsxs("div",{className:"text-center py-4 text-muted",children:[t.jsx(Q,{size:48,className:"mb-2 opacity-50",style:{display:"block",margin:"0 auto"}}),t.jsx("p",{className:"mb-0",children:"No hay banners configurados"}),t.jsx("small",{children:'Haz clic en "Agregar Banner" para comenzar'})]}):t.jsx("div",{className:"space-y-2",children:u.map((s,n)=>t.jsxs("div",{className:"card mb-2 shadow-sm",children:[t.jsxs("div",{className:"card-header bg-white d-flex justify-content-between align-items-center p-2",children:[t.jsxs("button",{type:"button",className:"btn btn-link text-left flex-grow-1 text-decoration-none p-2",onClick:()=>T(n),children:[t.jsxs("strong",{children:["Banner ",n+1]}),s.title&&t.jsxs("small",{className:"text-muted ml-2",children:["- ",s.title]})]}),t.jsxs("div",{className:"d-flex gap-1",children:[n>0&&t.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>D(n,"up"),title:"Mover arriba",children:t.jsx(W,{size:14})}),n<u.length-1&&t.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>D(n,"down"),title:"Mover abajo",children:t.jsx(X,{size:14})}),t.jsx("button",{type:"button",className:"btn btn-sm btn-outline-danger",onClick:()=>S(n),title:"Eliminar",children:t.jsx(Y,{size:14})})]})]}),i[n]&&t.jsx("div",{className:"card-body p-3",children:t.jsxs("div",{className:"row",children:[t.jsxs("div",{className:"col-12 mb-3",children:[t.jsx(_,{eRef:(l.current[n]||(l.current[n]={current:null}),l.current[n]),name:`banner_image_${n}`,label:"Imagen del Banner",col:"col-12",aspect:16/9,onChange:a=>{if(a.target.files&&a.target.files[0]){const c=a.target.files[0];N(n,"image",c.name)}}}),s.image&&t.jsxs("small",{className:"text-muted d-block mt-2",children:["Archivo actual: ",t.jsx("strong",{children:s.image})]})]}),t.jsxs("div",{className:"col-12 mb-3",children:[t.jsx("label",{className:"font-weight-semibold small",children:"Título"}),t.jsx("input",{type:"text",className:"form-control form-control-sm",placeholder:"Título del banner",value:s.title||"",onChange:a=>N(n,"title",a.target.value)})]}),t.jsxs("div",{className:"col-12 mb-3",children:[t.jsx("label",{className:"font-weight-semibold small",children:"Descripción"}),t.jsx("textarea",{className:"form-control form-control-sm",rows:"3",placeholder:"Descripción del banner",value:s.description||"",onChange:a=>N(n,"description",a.target.value)})]}),t.jsxs("div",{className:"col-md-6 mb-3",children:[t.jsx("label",{className:"font-weight-semibold small",children:"Texto del Botón"}),t.jsx("input",{type:"text",className:"form-control form-control-sm",placeholder:"Ver más",value:s.button_text||"",onChange:a=>N(n,"button_text",a.target.value)})]}),t.jsxs("div",{className:"col-md-6 mb-3",children:[t.jsx("label",{className:"font-weight-semibold small",children:"Link del Botón"}),t.jsx("input",{type:"text",className:"form-control form-control-sm",placeholder:"/ruta-destino",value:s.button_link||"",onChange:a=>N(n,"button_link",a.target.value)})]})]})})]},`banner-${n}-${s.image||"new"}`))})]}),t.jsx("input",{type:"hidden",name:m,value:JSON.stringify(u)})]})});J.displayName="BannersJsonEditor";const B=new oe,ae=()=>{const m=b.useRef(),g=b.useRef(),f="categories",I=b.useRef(),E=b.useRef(),u=b.useRef(),y=b.useRef(),i=b.useRef(),p=b.useRef(),l=b.useRef(),C=b.useRef(),[S,D]=b.useState(!1),N=e=>{if(console.log("=== onModalOpen called ==="),console.log("Full data object:",e),console.log("data.banners specifically:",e==null?void 0:e.banners),console.log("typeof data.banners:",typeof(e==null?void 0:e.banners)),e!=null&&e.id?D(!0):D(!1),I.current.value=(e==null?void 0:e.id)??"",E.current.value=(e==null?void 0:e.name)??"",u.current.value=(e==null?void 0:e.alias)??"",y.current.value=(e==null?void 0:e.description)??"",i.image.src=e!=null&&e.banner?`/storage/images/category/${e.banner}`:"",i.current.value=null,p.image.src=e!=null&&e.image?`/storage/images/category/${e.image}`:"",p.current.value=null,l.current){let r=(e==null?void 0:e.banners)||[];if(console.log("Categories.onModalOpen - data.banners:",e==null?void 0:e.banners),console.log("Categories.onModalOpen - banners type:",typeof r),typeof r=="string")try{r=JSON.parse(r)}catch(h){console.error("Error parsing banners JSON:",h),r=[]}console.log("Categories.onModalOpen - calling setValue with:",r),l.current.setValue(r);const o=(h=1)=>{console.log(`Attempt ${h} to load banner images...`);const d=l.current.getImageRefs();console.log("imageRefs:",d);let v=!0;r.forEach((R,x)=>{if(R.image){const j=d[x];console.log(`Banner ${x} - Full ref:`,j),console.log(`Banner ${x} - imgRef.image:`,j==null?void 0:j.image),console.log(`Banner ${x} - All properties:`,Object.keys(j||{})),j!=null&&j.image?(j.image.src=`/storage/images/category/${R.image}`,console.log(`✓ Loaded image for banner ${x}:`,R.image)):(v=!1,console.log(`✗ Ref not ready for banner ${x}`))}}),!v&&h<5&&setTimeout(()=>o(h+1),300)};setTimeout(()=>o(),500)}ne(C.current,(e==null?void 0:e.stores)??[],"id","name"),i.resetDeleteFlag&&i.resetDeleteFlag(),p.resetDeleteFlag&&p.resetDeleteFlag(),$(g.current).modal("show")},T=async e=>{e.preventDefault();const r={id:I.current.value||void 0,name:E.current.value,alias:u.current.value,description:y.current.value},o=new FormData;for(const x in r)o.append(x,r[x]);const h=p.current.files[0];h&&o.append("image",h);const d=i.current.files[0];if(d&&o.append("banner",d),l.current){o.append("banners",l.current.getValue());const x=l.current.getImageFiles();Object.keys(x).forEach(j=>{o.append(j,x[j])})}const v=$(C.current).val();v&&v.length>0?o.append("stores",JSON.stringify(v)):o.append("stores",JSON.stringify([])),i.getDeleteFlag&&i.getDeleteFlag()&&o.append("banner_delete","DELETE"),p.getDeleteFlag&&p.getDeleteFlag()&&o.append("image_delete","DELETE");for(let[x,j]of o.entries());await B.save(o)&&(i.resetDeleteFlag&&i.resetDeleteFlag(),p.resetDeleteFlag&&p.resetDeleteFlag(),$(m.current).dxDataGrid("instance").refresh(),$(g.current).modal("hide"))},s=async({id:e,value:r,previous:o})=>{if(r&&w.shouldBlock(f,"featured",o)){const d=w.get(f,"featured");let R=(d==null?void 0:d.message)??"Se alcanzó el límite de categorías destacadas.";d&&(R+=` Actualmente hay ${d.active??0} de ${d.max??0} categorías activas.`,se("Root")&&d.general_key&&(R+=` Puedes ajustar el límite en Generales usando la clave ${d.general_key}.`)),O.fire({icon:"warning",title:"Límite alcanzado",text:R});return}const h=await B.boolean({id:e,field:"featured",value:r});h&&(w.has(f,"featured")&&(typeof h=="object"&&(h!=null&&h.limit)?w.updateFromServer(f,h):w.applyChange(f,"featured",{previous:o,next:r})),$(m.current).dxDataGrid("instance").refresh())},n=async({id:e,value:r})=>{await B.boolean({id:e,field:"visible",value:r})&&$(m.current).dxDataGrid("instance").refresh()},a=async e=>{const{isConfirmed:r}=await O.fire({title:"Eliminar registro",text:"¿Estas seguro de eliminar este registro?",icon:"warning",showCancelButton:!0,confirmButtonText:"Si, eliminar",cancelButtonText:"Cancelar"});!r||!await B.delete(e.id)||(w.has(f,"featured")&&e.featured&&w.applyChange(f,"featured",{previous:!0,next:!1}),$(m.current).dxDataGrid("instance").refresh())},c=async e=>{const r=e.toIndex;try{await B.reorder(e.itemData.id,r)&&await e.component.refresh()}catch(o){console.error("Error reordering category:",o)}};return t.jsxs(t.Fragment,{children:[t.jsx(te,{gridRef:m,title:"Categorías",rest:B,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(m.current).dxDataGrid("instance").refresh()}}),e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",text:"Nuevo registro",hint:"Nuevo registro",onClick:()=>N()}})},rowDragging:{allowReordering:!0,onReorder:c,dropFeedbackMode:"push"},sorting:{mode:"single"},columns:[{dataField:"id",caption:"ID",visible:!1},{dataField:"order_index",caption:"Orden",visible:!1,sortOrder:"asc",sortIndex:0},{dataField:"name",caption:"Categoría",width:"30%"},{dataField:"description",caption:"Descripción",width:"50%"},F.has("categories","image")&&{dataField:"image",caption:"Imagen",width:"90px",allowFiltering:!1,cellTemplate:(e,{data:r})=>{k(e,t.jsx("img",{src:`/storage/images/category/${r.image}`,style:{width:"80px",height:"48px",objectFit:"cover",objectPosition:"center",borderRadius:"4px"},onError:o=>o.target.src="/api/cover/thumbnail/null"}))}},F.has("categories","banner")&&{dataField:"banner",caption:"Banner",width:"90px",allowFiltering:!1,cellTemplate:(e,{data:r})=>{k(e,t.jsx("img",{src:`/storage/images/category/${r.banner}`,style:{width:"80px",height:"48px",objectFit:"cover",objectPosition:"center",borderRadius:"4px"},onError:o=>o.target.src="/api/cover/thumbnail/null"}))}},{dataField:"featured",caption:"Destacado",dataType:"boolean",cellTemplate:(e,{data:r})=>{$(e).empty();const o=r.featured==1,d=w.has(f,"featured")&&w.shouldBlock(f,"featured",o),v=d?w.getMessage(f,"featured"):null;v?$(e).attr("title",v):$(e).removeAttr("title"),k(e,t.jsx(M,{checked:o,disabled:d,onChange:()=>s({id:r.id,value:!o,previous:o})}))}},{dataField:"visible",caption:"Visible",dataType:"boolean",cellTemplate:(e,{data:r})=>{$(e).empty(),k(e,t.jsx(M,{checked:r.visible==1,onChange:()=>n({id:r.id,value:!r.visible})}))}},{caption:"Acciones",cellTemplate:(e,{data:r})=>{e.css("text-overflow","unset"),e.append(V({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>N(r)})),e.append(V({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash",onClick:()=>a(r)}))},allowFiltering:!1,allowExporting:!1}]}),t.jsxs(ee,{modalRef:g,title:S?"Editar categoría":"Agregar categoría",onSubmit:T,children:[t.jsx("input",{ref:I,type:"hidden"}),t.jsxs("div",{className:"row",id:"categories-container",children:[t.jsxs("div",{className:!F.has("categories","banner")&&!F.has("categories","image")?"hidden":"col-md-6",children:[t.jsx(_,{eRef:i,name:"banner",label:"Banner",col:"col-12",aspect:3/1,hidden:!F.has("categories","banner")}),t.jsx(_,{eRef:p,name:"image",label:"Imagen",col:"col-12",aspect:16/9,hidden:!F.has("categories","image")})]}),t.jsxs("div",{className:!F.has("categories","banner")&&!F.has("categories","image")?"col-md-12":"col-md-6",children:[t.jsx(G,{eRef:E,label:"Categoría",rows:2,required:!0}),t.jsx(G,{eRef:u,label:"Alias (Nombre para mostrar)",col:"col-12"}),t.jsx(q,{eRef:y,label:"Descripción",rows:3})]}),t.jsx("div",{className:"col-12 mt-3",children:t.jsx(J,{ref:l,name:"banners",label:"Banners del Catálogo",initialValue:[],model:"category"})}),t.jsx("div",{className:"col-12 mt-3",children:t.jsx(Z,{id:"stores",eRef:C,searchAPI:"/api/admin/stores/paginate",searchBy:"name",label:"Ubicaciones (Stores)",dropdownParent:"#categories-container",tags:!0,multiple:!0})})]})]})]})};re((m,g)=>{H.createRoot(m).render(t.jsx(P,{...g,title:"Categorías",children:t.jsx(ae,{...g})}))});
