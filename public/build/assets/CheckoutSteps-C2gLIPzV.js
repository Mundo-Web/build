import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as d}from"./index-BOnQTV8N.js";import{C as S,N as E}from"./Number2Currency-B5ZenVq9.js";import{D as Ae,C as pt,B as Me,a as Ue,P as ut,b as xt,A as ht,O as ft,I as Ze,c as gt}from"./OptionCard-7xw4M2tS.js";import{i as et}from"./tippy-react.esm-DmkRJDEW.js";import{m as yt}from"./main-B6F2O9-U.js";import{G as D}from"./Global-DWbVqTT_.js";import{t as J}from"./index-CeCfhSXL.js";import{I as je}from"./InputForm-Dmyom2PO.js";import{S as bt}from"./SelectForm-BvZde-dr.js";import{S as jt}from"./store-DCbpAdsr.js";import{l as vt}from"./ShippingStep-Orbto5WD.js";import{c as tt}from"./createLucideIcon-DfjclApS.js";import{C as be}from"./circle-x-5vreeYph.js";import{m as we}from"./proxy-B0QLMKEh.js";import"./ProductNavigation-EmGJkmbV.js";import"./ProductCard-CAS9Wz-U.js";/* empty css              */import"./BlogCarousel-Bde9hmkj.js";/* empty css               */import"./BlogCarrusel-D7F5uf-O.js";import{R as Nt}from"./PolicyModal-C80IvD61.js";import{H as wt}from"./HtmlContent-ghmllTyl.js";import{X as Ct}from"./x-fof_H3Vv.js";import"./index-yBjzXJbu.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./General-BmbBKdsB.js";import"./sparkles-DvmvZ6mJ.js";import"./package-DBFPPBi1.js";import"./CartItemRow-Ds6-hPyN.js";import"./trash-2-DU7LB6-f.js";import"./plus-CTIomuuF.js";import"./index-NIGUFBhG.js";import"./useStateManager-7e1e8489.esm-C1VwfUuG.js";import"./hoist-non-react-statics.cjs-Dk09vysS.js";import"./index-pSueRYGM.js";import"./index-B6ujFmsw.js";import"./floating-ui.dom-DKqDEs6p.js";import"./___vite-browser-external_commonjs-proxy-DDYoOVPM.js";import"./chevron-down-uIVDLcM-.js";import"./search-BQ59Robe.js";import"./check-D5vaIe6v.js";import"./ItemsRest-BK1bmGZY.js";import"./BasicRest-DBO1iUsn.js";import"./HeaderSearch-DAVhxjsI.js";import"./index-BZvh78jk.js";import"./eye-ScgfreHn.js";import"./index-Chjiymov.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=tt("OctagonX",[["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"M2.586 16.726A2 2 0 0 1 2 15.312V8.688a2 2 0 0 1 .586-1.414l4.688-4.688A2 2 0 0 1 8.688 2h6.624a2 2 0 0 1 1.414.586l4.688 4.688A2 2 0 0 1 22 8.688v6.624a2 2 0 0 1-.586 1.414l-4.688 4.688a2 2 0 0 1-1.414.586H8.688a2 2 0 0 1-1.414-.586z",key:"2d38gg"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kt=tt("UserRoundX",[["path",{d:"M2 21a8 8 0 0 1 11.873-7",key:"74fkxq"}],["circle",{cx:"10",cy:"8",r:"5",key:"o932ke"}],["path",{d:"m17 17 5 5",key:"p7ous7"}],["path",{d:"m22 17-5 5",key:"gqnmv0"}]]);function _t({data:l,cart:j,setCart:y,onContinue:F,subTotal:q,envio:_,igv:A,fleteTotal:B,seguroImportacionTotal:i,derechoArancelarioTotal:u,totalFinal:x,openModal:h,categorias:r,automaticDiscounts:b,setAutomaticDiscounts:o,automaticDiscountTotal:se,setAutomaticDiscountTotal:k,totalWithoutDiscounts:O,generals:v}){var fe,ge,ve,X,ye,ke;const[ne,V]=d.useState(b||[]),[H,M]=d.useState(se||0),[Y,Z]=d.useState(!1),[ce,oe]=d.useState([]),[ee,ae]=d.useState([]),[ue,a]=d.useState(!1),[$,K]=d.useState(null),[le,ie]=d.useState(null),Q=j.length===0;d.useEffect(()=>{const c=j.filter(n=>n.type==="combo");if(console.log("🔍 CartStep useEffect triggered:",{cartLength:j.length,subTotal:q,combosCount:c.length,combos:c}),j.length>0&&q>0)p();else{const n=[];V(n),M(0),oe([]),ae([]),o&&o(n),k&&k(0)}},[j,q]);const p=async()=>{Z(!0);try{const c=j.reduce((N,z)=>N+(z.quantity||0),0),n=j.filter(N=>N.type==="combo");console.log("🛒 CartStep applying discounts:",{cart:j,subTotal:q,totalWithoutDiscounts:O,totalQuantity:c,cartLength:j.length,combosInCart:n.length,combos:n,cartItems:j.map(N=>({id:N.id||N.item_id,name:N.name,quantity:N.quantity,price:N.price||N.final_price,category_id:N.category_id,type:N.type}))});const g=await Ae.applyToCart(j,O);if(console.log("📥 Server response:",{success:g.success,data:g.data,error:g.error,fullResult:g}),g.success&&g.data){console.log("✅ Discounts found:",g.data.applied_discounts);const N=Ae.formatDiscounts(g.data.applied_discounts),z=g.data.total_discount||0,de=Ae.getFreeItems(g.data.applied_discounts),me=[];g.data.applied_discounts.forEach(te=>{te.suggested_items&&Array.isArray(te.suggested_items)&&me.push(...te.suggested_items)}),V(N),M(z),oe(de),ae(me),o&&o(N),k&&k(z),console.log("🔒 Preserving original cart, not updating from server response")}else{console.error("❌ Discount application failed:",{error:g.error,success:g.success,data:g.data,fullResult:g});const N=[],z=0;V(N),M(z),oe([]),ae([]),o&&o(N),k&&k(z)}}catch(c){console.error("Error applying discount rules:",c);const n=[],g=0;V(n),M(g),oe([]),ae([]),o&&o(n),k&&k(g)}finally{Z(!1)}},G=c=>ee.some(n=>n.item_id===c||n.triggering_item_id===c),xe=c=>ee.find(n=>n.item_id===c||n.triggering_item_id===c),Ce=c=>{const n=xe(c.id);n&&(K(n),ie(c),a(!0))},he=async c=>{try{console.log("CartStep - handleAddPromotionalItem received:",c),console.log("CartStep - current cart:",j),y(n=>{console.log("CartStep - old cart before update:",n);const g=n.findIndex(N=>(N.item_id||N.id)===c.item_id);if(console.log("CartStep - existingItemIndex:",g),g!==-1){const N=[...n],z=c.quantity||c.suggested_quantity||1;return console.log("CartStep - adding quantity:",z),N[g].quantity+=z,console.log("CartStep - updated cart:",N),N}else{console.log("CartStep - item not found, creating new product");const N={id:c.item_id,name:c.item_name,quantity:c.quantity||c.suggested_quantity||1,price:c.value||0,final_price:c.value||0,image:c.item_image||"default.jpg",brand:{name:c.item_brand||"N/A"},sku:c.item_sku||"PROMO",stock:999};return[...n,N]}}),setTimeout(()=>{p()},100)}catch(n){console.error("Error adding promotional item:",n)}};return e.jsxs("div",{className:"grid lg:grid-cols-5 gap-4 md:gap-8",children:[e.jsx("div",{className:"lg:col-span-3 space-y-4 md:space-y-6",children:Q?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center animate-fade-in",children:[e.jsx("svg",{className:"w-24 h-24 text-gray-300 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"})}),e.jsx("h3",{className:"text-xl font-semibold text-gray-600 mb-2",children:"Tu carrito está vacío"}),e.jsx("p",{className:"text-gray-500",children:"¡Explora nuestros productos y encuentra algo especial!"})]}):j.map((c,n)=>e.jsx(pt,{...c,setCart:y,categorias:r,hasPromotion:G(c.id),onPromotionClick:Ce},n))}),e.jsxs("div",{className:"lg:col-span-2 bg-[#F7F9FB] rounded-xl shadow-lg p-4 md:p-6 h-max mt-4 md:mt-0",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-bold pb-4 md:pb-6",children:"Resumen"}),e.jsxs("div",{className:"space-y-3 md:space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"Subtotal"}),e.jsxs("span",{className:"font-semibold",children:[S(),E(q)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:["IGV (",Number(((fe=v==null?void 0:v.find(c=>c.correlative==="igv_checkout"))==null?void 0:fe.description)||18),"%)"]}),e.jsxs("span",{className:"font-semibold",children:[S(),E(A)]})]}),Number((ge=v==null?void 0:v.find(c=>c.correlative==="importation_seguro"))==null?void 0:ge.description)>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:["Seguro (",Number(((ve=v==null?void 0:v.find(c=>c.correlative==="importation_seguro"))==null?void 0:ve.description)||0).toFixed(2),"%)"]}),e.jsxs("span",{className:"font-semibold",children:[S(),E(i)]})]}),Number((X=v==null?void 0:v.find(c=>c.correlative==="importation_derecho_arancelario"))==null?void 0:X.description)>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:["Derecho arancelario",((ye=v==null?void 0:v.find(c=>c.correlative==="importation_derecho_arancelario_descripcion"))==null?void 0:ye.description)&&e.jsx(et,{content:e.jsx("p",{className:"whitespace-pre-line",children:(ke=v==null?void 0:v.find(c=>c.correlative==="importation_derecho_arancelario_descripcion"))==null?void 0:ke.description}),allowHTML:!0,children:e.jsx("i",{className:"mdi mdi-information ms-1"})})]}),e.jsxs("span",{className:"font-semibold",children:[S(),E(u)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"Envío"}),e.jsxs("span",{className:"font-semibold",children:[S(),E(_)]})]}),Y&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"Verificando descuentos..."}),e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary"})]}),!Y&&ne.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold pb-4 md:pb-6  customtext-neutral-dark mb-2",children:"🎉 Descuentos aplicados:"}),ne.map((c,n)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:[c.name,c.description&&e.jsx("span",{className:"text-xs font-semibold block",children:c.description})]}),e.jsxs("span",{className:"customtext-neutral-dark font-semibold",children:["-",S(),E(c.amount)]})]},n)),e.jsxs("div",{className:"flex justify-between text-sm font-semibold customtext-neutral-dark pt-1",children:[e.jsx("span",{children:"Total descuentos:"}),e.jsxs("span",{children:["-",S(),E(H)]})]})]}),e.jsxs("div",{className:"py-3 border-y-2 mt-4 md:mt-6",children:[e.jsxs("div",{className:"flex justify-between font-bold text-lg md:text-[20px] items-center",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:[S(),E(x)]})]}),H>0&&e.jsxs("div",{className:"text-sm text-gray-500 mt-1",children:[e.jsxs("span",{className:"line-through",children:[S(),E(O||x+H)]}),e.jsxs("span",{className:"ml-2 customtext-neutral-dark font-semibold",children:["Ahorras ",S(),E(H)]})]})]}),e.jsxs("div",{className:"space-y-2 pt-3 md:pt-4",children:[e.jsx(Me,{onClick:F,disabled:Q,className:`w-full ${(l==null?void 0:l.class_button)||"text-white"}`,children:Q?"Carrito Vacío":"Continuar Compra"}),e.jsx(Ue,{href:"/",className:"w-full",children:Q?"Ir a Comprar":"Cancelar"})]}),e.jsx("div",{children:e.jsxs("p",{className:"text-xs md:text-sm customtext-neutral-dark",children:["Al realizar tu pedido, aceptas los ",e.jsx("a",{href:"#",onClick:()=>h(1),className:"customtext-primary font-bold",children:"Términos y Condiciones"}),", y que nosotros usaremos sus datos personales de acuerdo con nuestra ",e.jsx("a",{href:"#",onClick:()=>h(0),className:"customtext-primary font-bold",children:"Política de Privacidad"}),"."]})})]})]}),e.jsx(ut,{isOpen:ue,onClose:()=>a(!1),suggestion:$,onAddToCart:he,productName:(le==null?void 0:le.name)||""})]})}function St(){let l="";for(let j=0;j<12;j++){const y=Math.floor(Math.random()*10);l+=y}return l}const Et=l=>new Promise((j,y)=>{var F;try{if(console.log("🔄 Iniciando proceso de pago con Culqi...",l),!D.CULQI_ENABLED){console.error("❌ Error: Culqi no está habilitado en la configuración"),y("Método de pago no disponible: Culqi está deshabilitado");return}if(typeof window.Culqi>"u"){console.error("❌ Error: Culqi no está definido. Verifique que el script de Culqi esté cargado."),y("Error en la integración con Culqi: Script no cargado");return}if(!D.CULQI_PUBLIC_KEY){console.error("❌ Error: CULQI_PUBLIC_KEY no está configurado"),y("Error de configuración: Clave pública de Culqi no encontrada");return}const q=St(l.email);console.log("📝 Número de orden generado:",q);let _=!1;try{window.Culqi.publicKey=D.CULQI_PUBLIC_KEY,console.log("✅ Clave pública configurada exitosamente")}catch(x){console.error("❌ Error al configurar la clave pública:",x),y("Error en la integración con Culqi: No se pudo configurar la clave pública");return}const A=parseFloat(l.amount.toFixed(2)),B=Math.round(A*100);console.log("💰 Configurando Culqi:"),console.log("   - Monto original:",l.amount),console.log("   - Monto redondeado (soles):",A),console.log("   - Monto en céntimos:",B),console.log("   - Email:",l.email),window.Culqi.settings({title:D.CULQI_NAME||D.APP_NAME,email:l.email,currency:"PEN",amount:B,order:`${q}`}),console.log(window.Culqi.settings),window.Culqi.options({lang:"es",installments:!1,paymentMethods:{tarjeta:!0,yape:!0,bancaMovil:!0,agente:!0,billetera:!0,cuotealo:!0},style:{logo:D.APP_URL+`/assets/resources/icon.png?v=${crypto.randomUUID()}`,bannerColor:D.APP_COLOR_PRIMARY,buttonBackground:D.APP_COLOR_PRIMARY}});const i=(F=window.Culqi)==null?void 0:F.close;i&&(window.Culqi.close=function(){return!window.Culqi.token&&!_&&(console.log("🚫 Modal de Culqi cerrado sin completar el pago"),y("Pago cancelado por el usuario")),i.apply(this,arguments)}),window.Culqi.open(),window.culqi=async function(){try{if(!window.Culqi.token){y("No se obtuvo un token de Culqi");return}_=!0;const x=window.Culqi.token.id;console.log("✅ Token generado:",x),l={...l,token:x,orderNumber:q},console.log("_request actualizado",l);const{status:h,result:r}=await yt.Fetch("./api/pago",{method:"POST",body:JSON.stringify(l)});h||console.log((r==null?void 0:r.message)||"Error en el pago"),window.Culqi.close(),J.success("¡Pago exitoso!",{description:"Tu pago se procesó correctamente. Pronto recibirás la confirmación de tu pedido.",duration:3e3,position:"top-right",richColors:!0}),j(r)}catch(x){J.error("¡Error en el Pago!",{description:x.message,duration:3e3,position:"top-right",richColors:!0}),y(x.message||"Error en el pago")}},window.addEventListener("message",function(x){x.data==="culqi_closed"&&y("Pago cancelado por el usuario")});const u=x=>{x.key==="Escape"&&!_&&(console.log("🚫 Modal de Culqi cerrado con Escape"),y("Pago cancelado por el usuario"))};document.addEventListener("keydown",u),setTimeout(()=>{document.removeEventListener("keydown",u)},3e5),document.addEventListener("culqi.error",function(x){var h,r;J.error("¡Error en Culqi!",{description:((h=x.detail)==null?void 0:h.message)||"Error desconocido",duration:3e3,position:"top-right",richColors:!0}),y(((r=x.detail)==null?void 0:r.message)||"Error desconocido")})}catch(q){J.error("¡Error en la integración con Culqi!",{description:q.message,duration:3e3,position:"top-right",richColors:!0}),y("Error en la integración con Culqi")}}),Pt=({ubigeoCode:l,onStoreSelect:j,selectedStore:y=null,className:F=""})=>{const[q,_]=d.useState([]),[A,B]=d.useState(!1),[i,u]=d.useState(null);d.useEffect(()=>{l&&x()},[l]);const x=async()=>{B(!0),u(null);try{const b=await(await fetch("/api/stores")).json();_(b.data||[])}catch{_([])}finally{B(!1)}},h=r=>{j(r)};return A?e.jsxs("div",{className:`text-center p-6 ${F}`,children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-primary/10 rounded-full mb-4",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}),e.jsx("h3",{className:"text-lg font-semibold customtext-neutral-dark mb-2",children:"Cargando tiendas..."}),e.jsx("p",{className:"customtext-neutral-light text-sm",children:"Buscando tiendas disponibles en tu ubicación"})]}):i?e.jsxs("div",{className:`bg-red-50 border border-red-200 rounded-xl p-4 md:p-6 ${F}`,children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-red-100 rounded-full mx-auto mb-4",children:e.jsx("svg",{className:"w-6 h-6 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsx("h3",{className:"text-lg font-semibold text-red-800 text-center mb-2",children:"Error al cargar tiendas"}),e.jsx("p",{className:"text-red-600 text-center text-sm",children:i})]}):q.length===0?e.jsxs("div",{className:`bg-secondary/30 border border-secondary rounded-xl p-4 md:p-6 ${F}`,children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-secondary rounded-full mx-auto mb-4",children:e.jsx("svg",{className:"w-6 h-6 customtext-primary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsx("h3",{className:"text-lg font-semibold customtext-neutral-dark text-center mb-2",children:"Sin tiendas disponibles"}),e.jsx("p",{className:"customtext-neutral-light text-center text-sm",children:"No hay tiendas disponibles para retiro en esta ubicación. Por favor, selecciona otra opción de envío."})]}):e.jsxs("div",{className:F,children:[e.jsxs("div",{className:"mb-4 md:mb-6",children:[e.jsx("h3",{className:"text-lg md:text-xl font-semibold customtext-neutral-dark mb-2",children:"Selecciona una tienda para retiro"}),e.jsx("p",{className:"customtext-neutral-light text-sm md:text-base",children:"Elige la tienda más conveniente para retirar tu pedido"})]}),e.jsx("div",{className:"space-y-3 md:space-y-4",children:q.map(r=>e.jsxs("div",{className:`relative border-2 rounded-xl p-3 md:p-4 cursor-pointer transition-all duration-200 hover:shadow-lg ${(y==null?void 0:y.id)===r.id?"border-primary bg-primary/5 shadow-md":"border-secondary bg-white hover:border-primary/50 hover:shadow-md"}`,onClick:()=>h(r),children:[e.jsx("div",{className:"absolute top-3 md:top-4 right-3 md:right-4",children:e.jsx("div",{className:`w-5 h-5 rounded-full border-2 flex items-center justify-center ${(y==null?void 0:y.id)===r.id?"border-primary bg-primary":"border-secondary bg-white"}`,children:(y==null?void 0:y.id)===r.id&&e.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-3 md:gap-4 pr-8",children:[e.jsx("div",{className:"flex-shrink-0 hidden lg:block md:mx-0",children:r.image?e.jsx("img",{src:`/storage/images/store/${r.image}`,alt:r.name,className:"w-16 h-16 md:w-20 md:h-20 object-cover rounded-lg border border-secondary"}):e.jsx("div",{className:"w-16 h-16 md:w-20 md:h-20 bg-secondary rounded-lg border border-secondary flex items-center justify-center",children:e.jsx(jt,{className:"customtext-primary"})})}),e.jsxs("div",{className:"flex-1 min-w-0 text-left md:text-left",children:[e.jsxs("div",{className:"flex flex-col md:flex-row items-center md:items-start gap-2 mb-2",children:[e.jsx("h4",{className:"font-semibold customtext-neutral-dark text-base md:text-lg truncate",children:r.name}),e.jsx("span",{className:`hidden lg:block px-2 py-1 rounded-full text-xs font-medium ${r.type==="tienda"?"bg-primary/10 customtext-primary":r.type==="oficina"||r.type==="almacen"?"bg-secondary customtext-neutral-dark":r.type==="showroom"?"bg-primary/10 customtext-primary":"bg-secondary customtext-neutral-dark"}`,children:r.type==="tienda"?"Tienda":r.type==="oficina"?"Oficina":r.type==="almacen"?"Almacén":r.type==="showroom"?"Showroom":r.type||"Otro"})]}),e.jsx("p",{className:"text-sm customtext-neutral-light mb-3 line-clamp-3",children:r.address}),e.jsxs("div",{className:"flex flex-col md:flex-row md:flex-wrap gap-2 md:gap-4 text-sm customtext-neutral-light mb-3",children:[r.phone&&e.jsxs("div",{className:"flex items-center justify-start md:justify-start gap-1",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"})}),e.jsx("span",{children:r.phone})]}),r.manager&&e.jsxs("div",{className:"flex items-center justify-start md:justify-start gap-1",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),e.jsxs("span",{className:"text-center md:text-left",children:["Encargado: ",r.manager]})]})]}),r.business_hours&&e.jsxs("div",{className:"bg-gray-100 rounded-lg p-3 mt-3",children:[e.jsx("div",{className:"text-xs font-medium customtext-neutral-dark mb-2",children:"Horarios de atención:"}),e.jsx("div",{className:"text-xs customtext-neutral-light",children:(()=>{try{const b=typeof r.business_hours=="string"?JSON.parse(r.business_hours):r.business_hours,o=new Date().toLocaleDateString("es-PE",{weekday:"long"}),k={lunes:"Lunes",martes:"Martes",miércoles:"Miércoles",jueves:"Jueves",viernes:"Viernes",sábado:"Sábado",domingo:"Domingo"}[o.toLowerCase()]||o,O=b.find(v=>v.day.toLowerCase()===k.toLowerCase());if(O){const v=O.closed?"Hoy: Cerrado":`Hoy: ${O.open} - ${O.close}`,ne=!O.closed&&(()=>{const V=new Date,H=V.getHours()*60+V.getMinutes(),[M,Y]=O.open.split(":").map(Number),[Z,ce]=O.close.split(":").map(Number),oe=M*60+Y,ee=Z*60+ce;return H>=oe&&H<=ee})();return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:v}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${ne?"bg-primary/10 customtext-primary":"bg-red-100 text-red-800"}`,children:ne?"Abierto":"Cerrado"})]})}return"Horarios disponibles"}catch{return"Horarios disponibles"}})()})]}),r.description&&e.jsx("div",{className:"hidden lg:block mt-3 pt-3 border-t border-secondary",children:e.jsx("p",{className:"text-sm customtext-neutral-light text-center md:text-left",children:r.description})})]})]})]},r.id))})]})};function qt({data:l,cart:j,setSale:y,setCode:F,setDelivery:q,setCart:_,onContinue:A,noContinue:B,subTotal:i,igv:u,fleteTotal:x,seguroImportacionTotal:h,derechoArancelarioTotal:r,totalFinal:b,user:o,setEnvio:se,envio:k,ubigeos:O=[],openModal:v,categorias:ne,setCouponDiscount:V,setCouponCode:H,automaticDiscounts:M=[],automaticDiscountTotal:Y=0,setAutomaticDiscounts:Z,setAutomaticDiscountTotal:ce,totalWithoutDiscounts:oe,conversionScripts:ee,setConversionScripts:ae,onPurchaseComplete:ue,generals:a}){var He,Qe,Ke,Ge,Ye,Xe,We;const[$,K]=d.useState(null),[le,ie]=d.useState(null);M.reduce((t,s)=>s.free_items&&Array.isArray(s.free_items)?[...t,...s.free_items]:t,[]);const Q=[{value:"dni",label:"DNI"},{value:"ruc",label:"RUC"},{value:"ce",label:"CE"},{value:"pasaporte",label:"Pasaporte"}],[p,G]=d.useState({name:(o==null?void 0:o.name)||"",lastname:(o==null?void 0:o.lastname)||"",email:(o==null?void 0:o.email)||"",phone:(o==null?void 0:o.phone)||"",documentType:((He=o==null?void 0:o.document_type)==null?void 0:He.toLowerCase())||"",document:(o==null?void 0:o.document_number)||"",department:(o==null?void 0:o.department)||"",province:(o==null?void 0:o.province)||"",district:(o==null?void 0:o.district)||"",address:(o==null?void 0:o.address)||"",number:(o==null?void 0:o.number)||"",comment:"",reference:(o==null?void 0:o.reference)||"",ubigeo:(o==null?void 0:o.ubigeo)||null});d.useEffect(()=>{if(o!=null&&o.ubigeo&&(o!=null&&o.district)&&(o!=null&&o.province)&&(o!=null&&o.department)){const t={value:o.ubigeo,label:`${o.district}, ${o.province}, ${o.department}`,data:{reniec:o.ubigeo,departamento:o.department,provincia:o.province,distrito:o.district}};ie(t),K(t),De(t)}},[o]),d.useEffect(()=>{o&&G(t=>{var s;return{...t,name:o.name||t.name,lastname:o.lastname||t.lastname,email:o.email||t.email,phone:o.phone||t.phone,documentType:((s=o.document_type)==null?void 0:s.toLowerCase())||t.documentType,document:o.document_number||t.document,department:o.department||t.department,province:o.province||t.province,district:o.district||t.district,address:o.address||t.address,number:o.number||t.number,reference:o.reference||t.reference,ubigeo:o.ubigeo||t.ubigeo}})},[o]);const[xe,Ce]=d.useState(!1),[he,fe]=d.useState(!1),[ge,ve]=d.useState([]),[X,ye]=d.useState(null),[ke,c]=d.useState(null),[n,g]=d.useState({}),[N,z]=d.useState(""),[de,me]=d.useState(!1),[te,_e]=d.useState(""),[m,L]=d.useState(null),[pe,Se]=d.useState(0),[Ne,qe]=d.useState(!1),[$e,Ee]=d.useState(""),[Le,Re]=d.useState(null),[st,Be]=d.useState(!1),[ot,Fe]=d.useState(!1),at=t=>{Re(t),g(s=>({...s,store:""}))},rt=t=>{var w,U,C;const s=["name","lastname","documentType","document","email","phone","ubigeo","address","shipping"];for(const R of s)if(t[R]){let T=null,P=!1;if(R==="ubigeo"?T=((U=(w=document.querySelector('[name="ubigeo"]'))==null?void 0:w.parentElement)==null?void 0:U.parentElement)||document.querySelector(".css-1s2u09g-control")||document.querySelector('[class*="react-select"]'):R==="shipping"?T=((C=document.querySelector('input[name="shipping"]'))==null?void 0:C.closest(".space-y-4"))||document.querySelector(".space-y-4 h3")||document.querySelector("h3"):(T=document.querySelector(`[name="${R}"]`),P=!0),T){T.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),P&&setTimeout(()=>{try{T.focus(),T.tagName==="INPUT"&&T.type==="text"&&T.select()}catch(f){console.warn("No se pudo enfocar el elemento:",f)}},600),nt(T);break}}},nt=t=>{if(!t)return;const s=document.createElement("div");if(s.style.cssText=`
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid #ef4444;
            border-radius: 8px;
            pointer-events: none;
            z-index: 1000;
            animation: pulse 0.6s ease-in-out;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
        `,!document.querySelector("#error-highlight-styles")){const U=document.createElement("style");U.id="error-highlight-styles",U.textContent=`
                @keyframes pulse {
                    0% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.02); opacity: 0.8; }
                    100% { transform: scale(1); opacity: 1; }
                }
            `,document.head.appendChild(U)}const w=t.style.position;(!w||w==="static")&&(t.style.position="relative"),t.appendChild(s),setTimeout(()=>{s.parentNode&&(s.parentNode.removeChild(s),(!w||w==="static")&&(t.style.position=w))},1200)},De=async t=>{var w,U,C,R,T;if(!t)return;g(P=>({...P,ubigeo:""}));const{data:s}=t;G(P=>({...P,department:s.departamento,province:s.provincia,district:s.distrito,ubigeo:s.reniec})),Ce(!0);try{const P=j.reduce((W,Te)=>W+Te.final_price*Te.quantity,0);console.log("🛒 ShippingStep - Cart total calculado:",P),console.log("🛒 ShippingStep - Cart items:",j.map(W=>({name:W.name,price:W.final_price,quantity:W.quantity,total:W.final_price*W.quantity}))),console.log("💰 ShippingStep - Comparación de totales:"),console.log("   - Cart total (solo productos):",P),console.log("   - SubTotal prop:",i),console.log("   - IGV prop:",u),console.log("   - Total con IGV:",i+u),console.log("   - Total final prop:",b);const f=await xt.getShippingCost({ubigeo:s.reniec,cart_total:P});console.log("📦 ShippingStep - Respuesta del backend:",f.data),console.log("✅ ShippingStep - Califica para envío gratis?",f.data.qualifies_free_shipping),console.log("💰 ShippingStep - Umbral requerido:",f.data.free_shipping_threshold),console.log("🔍 ShippingStep - is_free:",f.data.is_free),console.log("🔍 ShippingStep - Descripción standard:",(w=f.data.standard)==null?void 0:w.description),console.log("🔍 ShippingStep - Tipo standard:",(U=f.data.standard)==null?void 0:U.type);const re=[];let Je=!1;if(f.data.is_free&&f.data.qualifies_free_shipping&&(console.log("✅ ShippingStep - Es zona is_free=true Y califica por monto - Agregando envío GRATIS"),re.push({type:"free",price:0,description:f.data.standard.description,deliveryType:f.data.standard.type,characteristics:f.data.standard.characteristics})),f.data.standard&&(!f.data.is_free||f.data.is_free&&!f.data.qualifies_free_shipping)){console.log("📦 ShippingStep - Agregando envío NORMAL");let W=f.data.standard.description;f.data.is_free||(W=W.replace(/envío gratis.*?/gi,"").replace(/envio gratis.*?/gi,"").replace(/gratis.*?compras.*?/gi,"").replace(/mayor.*?200.*?/gi,"").replace(/200.*?mayor.*?/gi,"").replace(/\s+/g," ").trim(),W||(W="Delivery a domicilio")),re.push({type:"standard",price:f.data.standard.price,description:W,deliveryType:f.data.standard.type,characteristics:f.data.standard.characteristics})}f.data.express&&f.data.express.price>0&&(console.log("⚡ ShippingStep - Agregando envío EXPRESS"),re.push({type:"express",price:f.data.express.price,description:f.data.express.description,deliveryType:f.data.express.type,characteristics:f.data.express.characteristics})),f.data.is_agency&&f.data.agency&&(console.log("🏢 ShippingStep - Agregando envío por AGENCIA"),re.push({type:"agency",price:f.data.agency.price||0,description:f.data.agency.description,deliveryType:f.data.agency.type,characteristics:f.data.agency.characteristics})),f.data.is_store_pickup&&(console.log("🏪 ShippingStep - Retiro en tienda disponible"),Je=!0),Je||f.data.is_store_pickup?(re.some(Te=>Te.type==="store_pickup")||(f.data.store_pickup?re.push({type:"store_pickup",price:f.data.store_pickup.price,description:f.data.store_pickup.description,deliveryType:f.data.store_pickup.type,characteristics:f.data.store_pickup.characteristics}):re.push({type:"store_pickup",price:0,description:"Retira tu pedido en una de nuestras tiendas",deliveryType:"Retiro en Tienda",characteristics:["Sin costo de envío","Horarios flexibles","Atención personalizada"]})),Be(!0)):(Be(!1),Re(null)),ve(re),ye(((C=re[0])==null?void 0:C.type)||null),se(((R=re[0])==null?void 0:R.price)||0),me(!1),console.log("📋 ShippingStep - Opciones finales de envío:",re),console.log("🚚 ShippingStep - Precio de envío seleccionado:",((T=re[0])==null?void 0:T.price)||0)}catch{J.error("Sin cobertura",{description:"No realizamos envíos a esta ubicación.",icon:e.jsx(Oe,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"bottom-center"}),ve([]),ye(null),se(0),me(!1)}Ce(!1)},Ve=async t=>{var C,R;if(t.preventDefault(),he)return;if(!o){Fe(!0);return}const s={},w=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,U=/^[0-9]{9}$/;if(p.name.trim()||(s.name="Nombre es requerido"),p.lastname.trim()||(s.lastname="Apellido es requerido"),p.documentType.trim()||(s.documentType="Tipo de documento es requerido"),p.document.trim()||(s.document="Número de documento es requerido"),p.email.trim()?w.test(p.email)||(s.email="Email inválido"):s.email="Email es requerido",p.phone.trim()?U.test(p.phone.trim())||(s.phone="Teléfono debe tener exactamente 9 dígitos"):s.phone="Teléfono es requerido",p.ubigeo||(s.ubigeo="Ubicación es requerida"),p.address||(s.address="Dirección es requerida"),X||(s.shipping="Seleccione un método de envío"),Object.keys(s).length>0){g(s);const T=Object.keys(s)[0],P={name:"Por favor ingrese su nombre",lastname:"Por favor ingrese su apellido",documentType:"Por favor seleccione el tipo de documento",document:"Por favor ingrese su número de documento",email:(C=s.email)!=null&&C.includes("inválido")?"Por favor ingrese un correo electrónico válido":"Por favor ingrese su correo electrónico",phone:(R=s.phone)!=null&&R.includes("9 dígitos")?"El teléfono debe tener exactamente 9 dígitos":"Por favor ingrese su número de teléfono",ubigeo:"Por favor seleccione su ubicación de entrega",address:"Por favor ingrese su dirección de entrega",shipping:"Por favor seleccione un método de envío"};J.error("Complete el campo requerido",{description:P[T],icon:e.jsx(be,{className:"h-5 w-5 text-red-500"}),duration:4e3,position:"top-center"}),rt(s);return}fe(!0);try{if(!D.CULQI_ENABLED){J.error("Método de pago no disponible",{description:"El procesamiento de pagos con tarjeta está temporalmente deshabilitado",icon:e.jsx(be,{className:"h-5 w-5 text-red-500"}),duration:4e3,position:"top-center"}),fe(!1);return}if(!D.CULQI_PUBLIC_KEY){J.error("Error de configuración",{description:"El sistema de pagos no está configurado correctamente",icon:e.jsx(be,{className:"h-5 w-5 text-red-500"}),duration:4e3,position:"top-center"}),fe(!1);return}const T={user_id:o.id,...p,fullname:`${p.name} ${p.lastname}`,country:"Perú",document_type:p.documentType,amount:I(Ie),delivery:I(k),seguro_importacion_total:I(h||0),derecho_arancelario_total:I(r||0),flete_total:I(x||0),delivery_type:X,store_id:X==="store_pickup"?Le==null?void 0:Le.id:null,cart:j,coupon_id:(m==null?void 0:m.id)||null,coupon_code:(m==null?void 0:m.code)||null,coupon_discount:I(pe||0),applied_promotions:M||[],promotion_discount:I(Y||0)};console.log("📦 Request completo a enviar:",T),console.log("💰 Monto final con cupón:",Ie),console.log("🎟️ Descuento del cupón:",pe),console.log("🚚 Costo de envío:",k);const P=await Et(T);if(console.log("📋 Respuesta completa del procesamiento:",P),P.status){if(console.log("✅ Pago exitoso, procesando respuesta..."),y(P.sale),q(P.delivery),F(P.code),P.conversion_scripts&&(console.log("Scripts de conversión recibidos:",P.conversion_scripts),ae(P.conversion_scripts),ue)){console.log("🎯 Ejecutando callback onPurchaseComplete...");try{await ue(P.sale_id,P.conversion_scripts),console.log("✅ Callback onPurchaseComplete ejecutado exitosamente")}catch(f){console.error("❌ Error en callback onPurchaseComplete:",f)}}console.log("🛒 Limpiando carrito y continuando..."),_([]),A()}else console.log("❌ Pago rechazado:",P),J.error("Error en el pago",{description:P.message||"Pago rechazado",icon:e.jsx(Oe,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"bottom-center"})}catch(T){console.error("💥 Error completo en handlePayment:",T),console.error("💥 Stack trace:",T.stack),console.error("💥 Error name:",T.name),console.error("💥 Error message:",T.message),J.error("Lo sentimos, no puede continuar con la compra",{description:`Ocurrió un error al procesar el pedido: ${T.message}`,icon:e.jsx(Oe,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"bottom-center"})}finally{fe(!1)}},it=d.useCallback(vt.debounce((t,s)=>{if(t.length<3){s([]);return}fetch(`/api/ubigeo/search?q=${encodeURIComponent(t)}`).then(w=>{if(!w.ok)throw new Error("Error en la respuesta");return w.json()}).then(w=>{const U=w.map(C=>({value:C.reniec,label:`${C.distrito}, ${C.provincia}, ${C.departamento}`,data:{inei:C.inei,reniec:C.reniec,departamento:C.departamento,provincia:C.provincia,distrito:C.distrito}}));s(U)}).catch(w=>{s([])})},300),[]);d.useEffect(()=>{g(t=>{const s={...t};return p.name.trim()&&delete s.name,p.lastname.trim()&&delete s.lastname,p.documentType.trim()&&delete s.documentType,p.document.trim()&&delete s.document,p.email.trim()&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p.email)&&delete s.email,p.phone.trim()&&/^[0-9]{9}$/.test(p.phone.trim())&&delete s.phone,p.address.trim()&&delete s.address,p.ubigeo&&delete s.ubigeo,X&&delete s.shipping,s})},[p,X]);const ct=t=>({control:s=>({...s,border:`1px solid ${t?"#ef4444":"#e5e7eb"}`,boxShadow:"none",minHeight:"50px","&:hover":{borderColor:t?"#ef4444":"#6b7280"},borderRadius:"0.75rem",padding:"2px 8px"}),menu:s=>({...s,zIndex:9999,marginTop:"4px",borderRadius:"8px"}),option:s=>({...s,color:"#1f2937",backgroundColor:"white","&:hover":{backgroundColor:"#f3f4f6"},padding:"12px 16px"})}),lt=async()=>{var t;if(!te.trim()){Ee("Ingrese un código de cupón");return}qe(!0),Ee("");try{const s=[...new Set(j.map(R=>R.category_id).filter(Boolean))],w=j.map(R=>R.id);console.log("Validando cupón:",{code:te.trim(),cart_total:i,category_ids:s,product_ids:w});const U=await gt.validateCoupon({code:te.trim(),cart_total:i,category_ids:s,product_ids:w});console.log("Respuesta del cupón:",U);const C=U.data||U;if(C&&C.valid){L(C.coupon);const R=Math.round(C.discount*100)/100;Se(R),V&&V(R),H&&H(((t=C.coupon)==null?void 0:t.code)||te.trim()),J.success("Cupón aplicado",{description:C.message||"Cupón aplicado correctamente",duration:3e3,position:"top-center"})}else{const R=(C==null?void 0:C.message)||"Cupón no válido";Ee(R),J.error("Cupón no válido",{description:R,icon:e.jsx(be,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"top-center"})}}catch(s){console.error("Error al validar cupón:",s),Ee("Error al validar el cupón"),J.error("Error",{description:s.message||"No se pudo validar el cupón. Intente nuevamente.",icon:e.jsx(be,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"top-center"})}finally{qe(!1)}},dt=()=>{L(null),Se(0),_e(""),Ee(""),V&&V(0),H&&H(""),J.success("Cupón removido",{description:"El cupón ha sido removido de su pedido",duration:2e3,position:"top-center"})},I=t=>{const s=typeof t=="string"?parseFloat(t):t;return parseFloat(s.toFixed(2))},ze=I(i)+I(u)+I(k)+I(h)+I(r)-I(Y);let Pe=0;m&&(m.type==="percentage"||m.type==="percent"?Pe=ze*Number(m.value)/100:m.type==="fixed"&&(Pe=Number(m.value))),d.useEffect(()=>{Se(I(Pe)),V&&V(I(Pe))},[m,i,u,k,Y]);const Ie=Math.max(0,I(ze-Pe)),mt=()=>{if(!ot)return null;const t=s=>{s.target===s.currentTarget&&Fe(!1)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:t,children:e.jsx("div",{className:"bg-white rounded-xl p-6 max-w-md w-full shadow-2xl transform transition-all",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4",children:e.jsx(kt,{className:"h-8 w-8 customtext-primary"})}),e.jsx("h2",{className:"text-2xl font-bold customtext-neutral-dark mb-3",children:"Acceso requerido"}),e.jsx("p",{className:"customtext-neutral-light text-sm leading-relaxed",children:"Para continuar con su compra necesita iniciar sesión o crear una cuenta nueva."})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{window.location.href="/iniciar-sesion"},className:"w-full py-3 px-6 bg-primary text-white font-semibold rounded-lg  focus:outline-none focus:ring-2  focus:ring-offset-2 transition duration-200 transform hover:scale-[1.02]",children:"Iniciar sesión"}),e.jsx("button",{onClick:()=>{window.location.href="/crear-cuenta"},className:"w-full py-3 px-6 bg-accent text-white font-semibold rounded-lg  focus:outline-none focus:ring-2  focus:ring-offset-2 transition duration-200 transform hover:scale-[1.02]",children:"Crear cuenta nueva"}),e.jsx("button",{onClick:()=>Fe(!1),className:"w-full py-3 px-6 customtext-neutral-light hover:customtext-neutral-dark border border-secondary rounded-lg hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200",children:"Cancelar"})]})]})})})};return e.jsxs(e.Fragment,{children:[e.jsx(mt,{}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-5 md:gap-8",children:[e.jsx("div",{className:"lg:col-span-3",children:e.jsxs("form",{className:"space-y-4 md:space-y-6 bg-white p-4 md:p-6 rounded-xl shadow-sm",onSubmit:Ve,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(je,{name:"name",label:"Nombres",value:p.name,error:n.name,onChange:t=>{G(s=>({...s,name:t.target.value})),t.target.value.trim()&&n.name&&g(s=>({...s,name:""}))},required:!0,className:`border-gray-200 ${n.name?"border-red-500 bg-red-50":""}`}),e.jsx(je,{name:"lastname",label:"Apellidos",value:p.lastname,error:n.lastname,onChange:t=>{G(s=>({...s,lastname:t.target.value})),t.target.value.trim()&&n.lastname&&g(s=>({...s,lastname:""}))},required:!0,className:`border-gray-200 ${n.lastname?"border-red-500 bg-red-50":""}`})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"space-y-2",children:e.jsx(bt,{label:"Tipo de documento",options:Q,placeholder:"Selecciona tu documento",labelClass:"block text-sm 2xl:!text-base mb-1 customtext-neutral-dark",value:p.documentType,error:n.documentType,onChange:t=>{G(s=>({...s,documentType:t})),t&&n.documentType&&g(s=>({...s,documentType:""}))},required:!0})}),e.jsx(je,{name:"document",label:"Número de documento",value:p.document,error:n.document,onChange:t=>{G(s=>({...s,document:t.target.value})),t.target.value.trim()&&n.document&&g(s=>({...s,document:""}))},placeholder:"Ej: 12345678",required:!0,className:`border-gray-200 ${n.document?"border-red-500 bg-red-50":""}`})]}),e.jsx(je,{name:"email",label:"Correo electrónico",type:"email",value:p.email,error:n.email,onChange:t=>{G(s=>({...s,email:t.target.value})),t.target.value.trim()&&n.email&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.target.value)&&g(w=>({...w,email:""}))},required:!0,className:`border-gray-200 ${n.email?"border-red-500 bg-red-50":""}`}),e.jsx(je,{name:"phone",label:"Teléfono",type:"tel",value:p.phone,error:n.phone,onChange:t=>{const s=t.target.value.replace(/\D/g,"");G(w=>({...w,phone:s})),s.length===9&&n.phone&&g(w=>({...w,phone:""}))},maxLength:"9",placeholder:"Ej: 987654321",required:!0,className:`border-gray-200 ${n.phone?"border-red-500 bg-red-50":""}`}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"block text-sm 2xl:text-base mb-2 font-medium customtext-neutral-dark",children:["Distrito / Provincia / Departamento (Ubicación de entrega)",e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),e.jsx(ht,{name:"ubigeo",cacheOptions:!0,value:$,loadOptions:it,onChange:t=>{K(t),De(t),z("")},inputValue:N,onInputChange:(t,{action:s})=>{s==="input-change"&&z(t)},onFocus:()=>{K(null),z("")},onMenuOpen:()=>{$&&(K(null),z(""))},placeholder:"Buscar por Distrito ...",loadingMessage:()=>"Buscando ubicaciones...",noOptionsMessage:({inputValue:t})=>t.length<3?"Buscar por Distrito ...":"No se encontraron resultados",isLoading:xe,styles:ct(!!n.ubigeo),formatOptionLabel:({data:t})=>e.jsxs("div",{className:"text-sm py-1",children:[e.jsx("div",{className:"font-medium",children:t.distrito}),e.jsxs("div",{className:"text-gray-500",children:[t.provincia,", ",t.departamento]})]}),className:"w-full rounded-xl transition-all duration-300",menuPortalTarget:document.body,isClearable:!0}),n.ubigeo&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:n.ubigeo})]}),e.jsx(je,{name:"address",label:"Dirección ",value:p.address,error:n.address,onChange:t=>{G(s=>({...s,address:t.target.value})),t.target.value.trim()&&n.address&&g(s=>({...s,address:""}))},required:!0,className:`border-gray-200 ${n.address?"border-red-500 bg-red-50":""}`}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(je,{label:"Número",value:p.number,onChange:t=>G(s=>({...s,number:t.target.value})),className:"border-gray-200"}),e.jsx(je,{label:"Referencia",value:p.reference,onChange:t=>G(s=>({...s,reference:t.target.value})),className:"border-gray-200"})]}),ge.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Método de envío"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:ge.map(t=>e.jsx(ft,{title:t.deliveryType,price:t.price,description:t.description,selected:X===t.type,onSelect:()=>{ye(t.type),se(t.price),g(s=>({...s,shipping:"",store:""})),me(!1),t.type!=="store_pickup"&&Re(null)}},t.type))}),X&&ge.length>0&&e.jsx("div",{className:"space-y-3 mt-4",children:(()=>{var U;const t=((U=ge.find(C=>C.type===X))==null?void 0:U.characteristics)||[],s=t.length>1,w=s&&!de?t.slice(0,1):t;return e.jsxs(e.Fragment,{children:[w.map((C,R)=>e.jsxs("div",{className:"flex items-start gap-3 bg-gray-50 p-4 rounded-xl",children:[e.jsx("div",{className:"w-5 flex-shrink-0",children:e.jsx(Ze,{className:"customtext-primary"})}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"text-sm font-medium customtext-neutral-dark",children:C})})]},`char-${R}`)),s&&e.jsx("div",{className:"flex justify-center mt-3",children:e.jsxs("button",{type:"button",onClick:()=>me(!de),className:"flex items-center gap-2 px-4 py-2 text-sm font-medium customtext-primary hover:bg-blue-50 rounded-lg transition-colors duration-200",children:[e.jsx("span",{children:de?"Ver menos información":`Ver más información (${t.length-1} más)`}),e.jsx("svg",{className:`w-4 h-4 transition-transform duration-200 ${de?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})})]})})()})]}),X==="store_pickup"&&st&&e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsx(Pt,{ubigeoCode:p.ubigeo,onStoreSelect:at,selectedStore:Le,className:"border border-gray-200 rounded-xl p-4"}),n.store&&e.jsxs("div",{className:"text-red-500 text-sm mt-2 flex items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4"}),n.store]})]}),!B&&e.jsxs("div",{className:"flex flex-col md:flex-row justify-end gap-3 md:gap-4 mt-6",children:[e.jsx(Ue,{type:"button",onClick:()=>window.history.back(),className:"w-full md:w-auto",children:"Regresar"}),e.jsx(Me,{type:"submit",loading:xe,className:"w-full md:w-auto",children:"Continuar"})]})]})}),e.jsxs("div",{className:"bg-[#F7F9FB] rounded-xl shadow-lg p-6 col-span-2 h-max",children:[e.jsx("h3",{className:"text-2xl font-bold pb-6",children:"Resumen"}),e.jsx("div",{className:"space-y-4 border-b-2 pb-6",children:j.map(t=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("img",{src:t.type==="combo"?`/storage/images/combo/${t.image}`:`/storage/images/item/${t.image}`,alt:t.name,className:"w-16 h-16 object-cover rounded-lg",onError:s=>s.target.src="/api/cover/thumbnail/null"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:t.name}),e.jsxs("p",{className:"text-sm customtext-neutral-dark",children:["Cantidad: ",t.quantity]}),e.jsxs("p",{className:"text-sm customtext-neutral-dark",children:[S(),E(t.final_price)]})]})]},t.id))}),e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:[S(),E(I(i))]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["IGV (",Number(((Qe=a==null?void 0:a.find(t=>t.correlative==="igv_checkout"))==null?void 0:Qe.description)||18),"%):"]}),e.jsxs("span",{children:[S(),E(I(u))]})]}),Number((Ke=a==null?void 0:a.find(t=>t.correlative==="importation_seguro"))==null?void 0:Ke.description)>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["Seguro (",Number(((Ge=a==null?void 0:a.find(t=>t.correlative==="importation_seguro"))==null?void 0:Ge.description)||0).toFixed(2),"%):"]}),e.jsxs("span",{children:[S(),E(I(h))]})]}),Number((Ye=a==null?void 0:a.find(t=>t.correlative==="importation_derecho_arancelario"))==null?void 0:Ye.description)>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["Derecho arancelario",((Xe=a==null?void 0:a.find(t=>t.correlative==="importation_derecho_arancelario_descripcion"))==null?void 0:Xe.description)&&e.jsx(et,{content:e.jsx("p",{className:"whitespace-pre-line",children:(We=a==null?void 0:a.find(t=>t.correlative==="importation_derecho_arancelario_descripcion"))==null?void 0:We.description}),allowHTML:!0,children:e.jsx("i",{className:"mdi mdi-information ms-1"})})]}),e.jsxs("span",{children:[S(),E(I(r))]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Envío:"}),e.jsxs("span",{children:[S(),E(I(k))]})]}),e.jsx("div",{className:"space-y-4 border-t pt-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"block text-sm font-medium customtext-neutral-dark",children:"¿Tienes un cupón de descuento?"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("input",{type:"text",placeholder:"Ingresa tu código de cupón",value:te,onChange:t=>_e(t.target.value.toUpperCase()),className:`w-full px-4 py-3 border customtext-neutral-dark  border-gray-100 rounded-xl focus:ring-0 focus:outline-0   transition-all duration-300 ${$e?"border-red-300 bg-red-50 text-red-900 focus:border-red-500 focus:ring-red-200":m?"border-gray-200 bg-white customtext-neutral-dark focus:ring-blue-200":" bg-white border-neutral-light focus:ring-0 focus:outline-0"} `,disabled:!!m||Ne}),Ne&&e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:e.jsx("div",{className:"w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"})})]}),m?e.jsx("button",{type:"button",onClick:dt,className:"px-4 py-3 bg-gray-200 customtext-neutral-dark text-sm rounded-xl hover:bg-gray-300 transition-colors duration-200",title:"Remover cupón",children:e.jsx(be,{className:"h-4 w-4"})}):e.jsx("button",{type:"button",onClick:lt,disabled:Ne||!te.trim(),className:"px-6 py-3 bg-primary text-white text-sm font-medium rounded-xl hover:opacity-90 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all duration-200 whitespace-nowrap",children:Ne?"Validando...":"Aplicar"})]}),$e&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(be,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{children:$e})]}),m&&e.jsx("div",{className:"bg-gray-50 border-2  rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 w-8/12",children:[e.jsx("div",{className:"w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})}),e.jsxs("div",{children:[e.jsxs("p",{className:"customtext-primary font-semibold text-sm",children:["Descto. ",m.type==="percentage"?`${m.value}%`:`${S()}${E(m.value)}`]}),e.jsx("p",{className:"customtext-primary text-xs mt-1",children:m.code})]})]}),e.jsx("div",{className:"text-right w-4/12",children:e.jsxs("span",{className:"customtext-primary font-bold text-base",children:["-",S(),E(I(pe))]})})]})})]})}),M&&M.length>0&&e.jsx("div",{className:"space-y-4 border-t pt-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium customtext-neutral-dark mb-2",children:"🎉 Descuentos automáticos aplicados:"}),M.map((t,s)=>e.jsx("div",{className:" border-2  rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 w-8/12",children:[e.jsx("div",{className:"w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})}),e.jsxs("div",{children:[e.jsx("p",{className:"customtext-neutral-dark font-semibold text-sm",children:t.name}),t.description&&e.jsx("p",{className:"customtext-neutral-dark text-xs mt-1",children:t.description})]})]}),e.jsx("div",{className:"text-right w-4/12",children:e.jsxs("span",{className:"customtext-neutral-dark font-bold text-base",children:["-",S(),E(t.amount)]})})]})},s)),Y>0&&e.jsx("div",{className:"l p-3",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"customtext-neutral-dark font-semibold",children:"Total descuentos automáticos:"}),e.jsxs("span",{className:"customtext-neutral-dark font-bold text-lg",children:["-",S(),E(Y)]})]})})]})}),e.jsx("div",{className:"pt-4 border-t-2",children:e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{children:[S(),E(I(Ie))]})]})}),!D.CULQI_ENABLED&&e.jsx("div",{className:"mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ze,{className:"h-5 w-5 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800",children:"El procesamiento de pagos con tarjeta está temporalmente deshabilitado"})]})}),D.CULQI_ENABLED&&!D.CULQI_PUBLIC_KEY&&e.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(be,{className:"h-5 w-5 text-red-600 mr-2"}),e.jsx("span",{className:"text-sm text-red-800",children:"Error de configuración: Sistema de pagos no configurado"})]})}),e.jsx(Me,{onClick:Ve,disabled:he||!D.CULQI_ENABLED||!D.CULQI_PUBLIC_KEY,loading:he,className:`w-full mt-6 ${(l==null?void 0:l.class_button)||"text-white"} ${!D.CULQI_ENABLED||!D.CULQI_PUBLIC_KEY?"opacity-50 cursor-not-allowed":""}`,children:he?"Procesando...":D.CULQI_ENABLED?D.CULQI_PUBLIC_KEY?`Pagar ${S()}${E(I(Ie))}`:"Configuración pendiente":"Pago no disponible"}),e.jsx(Ue,{onClick:B,className:"w-full mt-3",disabled:he,children:"Regresar al carrito"}),e.jsxs("p",{className:"text-xs md:text-sm customtext-neutral-dark",children:["Al realizar tu pedido, aceptas los ",e.jsx("a",{href:"#",onClick:()=>v(1),className:"customtext-primary font-bold",children:"Términos y Condiciones"}),", y que nosotros usaremos sus datos personales de acuerdo con nuestra ",e.jsx("a",{href:"#",onClick:()=>v(0),className:"customtext-primary font-bold",children:"Política de Privacidad"}),"."]})]})]})]})]})}function Lt({cart:l,code:j,delivery:y,subTotal:F,igv:q,fleteTotal:_=0,seguroImportacionTotal:A=0,derechoArancelarioTotal:B=0,totalFinal:i,couponDiscount:u=0,couponCode:x=null,conversionScripts:h=null,automaticDiscounts:r=[],automaticDiscountTotal:b=0,generals:o}){var ee,ae,ue;console.log("ConfirmationStep - Props received:",{cart:l,cartLength:l==null?void 0:l.length,subTotal:F,igv:q,totalFinal:i,delivery:y,couponDiscount:u,automaticDiscountTotal:b,seguroImportacionTotal:A,derechoArancelarioTotal:B,fleteTotal:_});const se=l.reduce((a,$)=>a+($.type==="combo"?$.final_price||$.price:$.final_price)*$.quantity,0),k=F>0?F:parseFloat((se/1.18).toFixed(2)),O=F>0?q:parseFloat((se-k).toFixed(2)),v=l.reduce((a,$)=>{const K=parseFloat($.weight)||0;return a+K*$.quantity},0),ne=Number((ee=o==null?void 0:o.find(a=>a.correlative==="importation_flete"))==null?void 0:ee.description)||0,V=_>0?_:ne>0?v*ne:0,H=(Number((ae=o==null?void 0:o.find(a=>a.correlative==="importation_seguro"))==null?void 0:ae.description)||0)/100,M=A>0?A:k*H,Y=parseFloat(k)+parseFloat(V)+parseFloat(M),Z=(Number((ue=o==null?void 0:o.find(a=>a.correlative==="importation_derecho_arancelario"))==null?void 0:ue.description)||0)/100,ce=B>0?B:Y*Z,oe=k+O+(y||0)+M+ce-(u||0)-(b||0);return console.log("ConfirmationStep - Debug totals:",{recalculatedTotal:se,passedSubTotal:F,passedIgv:q,actualSubTotal:k,actualIgv:O,passedSeguro:A,actualSeguro:M,passedDerecho:B,actualDerecho:ce,passedTotalFinal:i,actualTotalFinal:oe,cart:l.map(a=>({name:a.name,type:a.type,price:a.price,final_price:a.final_price,quantity:a.quantity,weight:a.weight}))}),d.useEffect(()=>{if(h){console.log("Executing conversion scripts...");try{if(h.head){const a=document.createElement("script");a.innerHTML=h.head,document.head.appendChild(a)}if(h.body){const a=document.createElement("script");a.innerHTML=h.body,document.body.appendChild(a)}console.log("Conversion scripts executed successfully")}catch(a){console.error("Error executing conversion scripts:",a)}}},[h]),e.jsx(we.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6},className:"mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-12",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl p-6 md:p-10",children:e.jsxs(we.div,{initial:{scale:.9},animate:{scale:1},transition:{delay:.3},className:"text-center space-y-6",children:[e.jsx(we.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",delay:.5},className:"w-20 h-20 bg-secondary rounded-full mx-auto flex items-center justify-center",children:e.jsx("span",{className:"text-4xl",children:"✓"})}),e.jsx("h2",{className:"text-2xl md:text-3xl customtext-neutral-light animate-bounce",children:"¡Gracias por tu compra! 🎉"}),e.jsx("p",{className:"customtext-neutral-dark text-3xl md:text-5xl font-bold",children:"Tu orden ha sido recibida"}),e.jsxs(we.div,{whileHover:{scale:1.05},className:"py-6 px-4 bg-secondary rounded-xl inline-block",children:[e.jsx("div",{className:"customtext-neutral-light",children:"Código de pedido"}),e.jsx("div",{className:"customtext-neutral-dark text-xl font-bold",children:`#${j}`})]}),e.jsxs("div",{className:"space-y-6 bg-[#F7F9FB] p-6 md:p-8 rounded-xl shadow-inner",children:[e.jsx("div",{className:"space-y-6 border-b-2 pb-6",children:l.map((a,$)=>{var le,ie;const K=()=>a.type==="combo"?a.final_price||a.price:a.final_price;return e.jsx(we.div,{initial:{x:-20,opacity:0},animate:{x:0,opacity:1},transition:{delay:$*.2},className:"bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow duration-300",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-6 items-center sm:items-start",children:[e.jsx("div",{className:"bg-gray-50 p-3 rounded-xl",children:e.jsx("img",{src:(a==null?void 0:a.type)==="combo"?`/storage/images/combo/${a==null?void 0:a.image}`:`/storage/images/item/${a==null?void 0:a.image}`,alt:a==null?void 0:a.name,className:"w-24 h-24 object-cover rounded-lg",onError:Q=>Q.target.src="/api/cover/thumbnail/null",loading:"lazy"})}),e.jsxs("div",{className:"text-center sm:text-left flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between mb-3",children:[e.jsxs("div",{className:"lg:w-8/12",children:[e.jsx("h3",{className:"font-semibold text-xl line-clamp-3 mb-2",children:a==null?void 0:a.name}),a.type==="combo"&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"mb-2",children:e.jsx("span",{className:"inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full",children:"COMBO"})}),e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Contiene:"}),e.jsx("div",{className:"mt-1",children:a.combo_items&&a.combo_items.length>0?a.combo_items.map((Q,p)=>e.jsxs("div",{className:"text-xs text-gray-500",children:["• ",Q.quantity||1,"x ",Q.name]},p)):a.items&&a.items.length>0?a.items.map((Q,p)=>e.jsxs("div",{className:"text-xs text-gray-500",children:["• ",Q.quantity||1,"x ",Q.name]},p)):e.jsx("span",{className:"text-xs text-gray-400",children:"Información de combo no disponible"})})]})]})]}),e.jsx("div",{className:"mt-2 sm:mt-0 text-center lg:text-right lg:w-4/12",children:e.jsxs("div",{className:"font-bold text-lg customtext-primary",children:[S(),E(K()*(a==null?void 0:a.quantity))]})})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[((le=a==null?void 0:a.brand)==null?void 0:le.name)&&e.jsxs("p",{className:"text-sm customtext-neutral-dark",children:["Marca: ",e.jsx("span",{className:"customtext-neutral-dark font-medium",children:((ie=a==null?void 0:a.brand)==null?void 0:ie.name)||"N/A"})]}),e.jsxs("p",{className:"text-sm customtext-neutral-dark",children:["Cantidad: ",e.jsx("span",{className:"customtext-neutral-dark font-medium",children:a==null?void 0:a.quantity})]}),(a==null?void 0:a.sku)&&e.jsxs("p",{className:"text-sm customtext-neutral-dark",children:["SKU: ",e.jsx("span",{className:"customtext-neutral-dark font-medium",children:(a==null?void 0:a.sku)||"N/A"})]})]})]})]})},$)})}),e.jsxs(we.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.8},className:"space-y-4 mt-6",children:[[{label:"Subtotal",value:k},{label:"IGV",value:O},...M>0?[{label:"Seguro de Importación",value:M}]:[],...ce>0?[{label:"Derecho Arancelario",value:ce}]:[],{label:"Envío",value:y}].map((a,$)=>e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsx("span",{className:"customtext-neutral-dark",children:a.label}),e.jsxs("span",{className:"font-semibold",children:[S(),E(a.value)]})]},$)),u>0&&x&&e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsxs("span",{className:"customtext-neutral-dark text-start",children:["Cupón: ",e.jsx("br",{className:"lg:hidden"}),e.jsxs("span",{className:"font-semibold text-xs lg:text-base",children:["(",x,")"]})]}),e.jsxs("span",{className:"font-semibold",children:["-",S(),E(u)]})]}),b>0&&r.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold pb-4 md:pb-6 customtext-neutral-dark mb-2",children:"🎉 Descuentos aplicados:"}),r.map((a,$)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:[a.name,a.description&&e.jsx("span",{className:"text-xs font-semibold block",children:a.description})]}),e.jsxs("span",{className:"customtext-neutral-dark font-semibold",children:["-",S(),E(a.amount)]})]},$)),e.jsxs("div",{className:"flex justify-between text-sm font-semibold customtext-neutral-dark pt-1",children:[e.jsx("span",{children:"Total descuentos:"}),e.jsxs("span",{children:["-",S(),E(b)]})]})]}),e.jsx("div",{className:"py-4 border-y-2 mt-6",children:e.jsxs("div",{className:"flex justify-between font-bold text-xl md:text-2xl items-center",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:[S(),E(oe)]})]})})]}),e.jsx(we.div,{className:"pt-6",whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsx(Me,{href:"/catalogo",className:"w-full mx-auto md:w-auto text-white",children:"Seguir Comprando"})})]})]})})})}const It=()=>{const l=d.useRef({hasTrackedPageView:!1,hasTrackedInitiateCheckout:!1}),j=(i,u={})=>{typeof window>"u"||(typeof window.fbq<"u"&&window.fbq("track","ViewContent",{content_ids:[i],content_type:"product",content_name:u.name||"",value:u.price||0,currency:"PEN"}),typeof window.gtag<"u"&&window.gtag("event","view_item",{currency:"PEN",value:u.price||0,items:[{item_id:i,item_name:u.name||"",category:u.category||"",price:u.price||0}]}),typeof window.ttq<"u"&&window.ttq.track("ViewContent",{content_id:i,content_type:"product",content_name:u.name||"",value:u.price||0,currency:"PEN"}),console.log("✅ ProductView tracked for product:",i))},y=async(i,u=1,x={})=>{var h;if(!(typeof window>"u"))try{const b=await(await fetch("/api/tracking/add-to-cart",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((h=document.querySelector('meta[name="csrf-token"]'))==null?void 0:h.content)||""},body:JSON.stringify({product_id:i,quantity:u,...x})})).json();b.success&&b.tracking_scripts&&(A(b.tracking_scripts),console.log("✅ AddToCart tracked successfully"))}catch(r){console.error("❌ Error tracking AddToCart:",r)}},F=async(i,u)=>{var x;if(!(typeof window>"u"||l.current.hasTrackedInitiateCheckout))try{l.current.hasTrackedInitiateCheckout=!0;const r=await(await fetch("/api/tracking/initiate-checkout",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((x=document.querySelector('meta[name="csrf-token"]'))==null?void 0:x.content)||""},body:JSON.stringify({cart_items:i.map(b=>({product_id:b.id,name:b.name,price:b.final_price||b.price,quantity:b.quantity,subtotal:(b.final_price||b.price)*b.quantity}))})})).json();r.success&&r.tracking_scripts&&(A(r.tracking_scripts),console.log("✅ InitiateCheckout tracked successfully"))}catch(h){console.error("❌ Error tracking InitiateCheckout:",h),l.current.hasTrackedInitiateCheckout=!1}},q=(i,u)=>{if(!(typeof window>"u")){console.log("🎯 Iniciando tracking de compra:",{orderId:i,conversionScripts:u});try{u?(console.log("📊 Usando scripts de conversión del servidor"),A(u)):(console.log("🔄 Obteniendo scripts de conversión del API"),fetch(`/api/tracking/purchase/${i}`).then(x=>x.text()).then(x=>{x&&(A(x),console.log("✅ Purchase tracked successfully"))}).catch(x=>{console.error("❌ Error tracking Purchase:",x)}))}catch(x){console.error("❌ Error general en trackPurchase:",x)}}},_=(i,u=[])=>{if(typeof window>"u"||l.current.hasTrackedPageView)return;l.current.hasTrackedPageView=!0;const x=u.reduce((h,r)=>h+(r.final_price||r.price)*r.quantity,0);typeof window.fbq<"u"&&(window.fbq("track","PageView"),i===1&&u.length>0&&window.fbq("track","AddToCart",{content_ids:u.map(h=>h.id),content_type:"product",value:x,currency:"PEN",num_items:u.length})),typeof window.gtag<"u"&&(window.gtag("event","page_view",{page_title:`Checkout - Paso ${i}`,page_location:window.location.href}),i===1&&u.length>0&&window.gtag("event","view_cart",{currency:"PEN",value:x,items:u.map(h=>{var r;return{item_id:h.id,item_name:h.name,category:((r=h.category)==null?void 0:r.name)||"Sin categoría",quantity:h.quantity,price:h.final_price||h.price}})})),console.log(`✅ Checkout PageView tracked - Step ${i}`)},A=i=>{if(typeof window>"u"||!i)return;console.log("🎯 Ejecutando scripts de tracking:",i);const u=document.createElement("div");u.innerHTML=i,u.querySelectorAll("script").forEach((h,r)=>{try{const b=document.createElement("script");b.textContent=h.textContent,console.log(`📊 Ejecutando script de tracking ${r+1}:`,h.textContent.trim()),document.head.appendChild(b),setTimeout(()=>{b.parentNode&&b.parentNode.removeChild(b)},100),console.log(`✅ Script de tracking ${r+1} ejecutado exitosamente`)}catch(b){console.error(`❌ Error ejecutando script de tracking ${r+1}:`,b),console.error("Script content:",h.textContent)}}),console.log("🎯 Todos los scripts de tracking procesados")};return{trackProductView:j,trackAddToCart:y,trackInitiateCheckout:F,trackPurchase:q,trackCheckoutPageView:_,resetTracking:()=>{l.current={hasTrackedPageView:!1,hasTrackedInitiateCheckout:!1}}}};function Ss({cart:l,setCart:j,user:y,ubigeos:F=[],items:q,generals:_,data:A,categorias:B}){var me,te,_e;const[i,u]=d.useState(1);d.useEffect(()=>{const m=l.filter(L=>L.type==="combo");console.log("🔍 CheckoutSteps cart changed:",{totalItems:l.length,combos:m.length,currentStep:i,cart:l.map(L=>({id:L.id,name:L.name,type:L.type,quantity:L.quantity,final_price:L.final_price,price:L.price}))}),m.length===0&&l.length===0&&console.warn("🚨 ALERT: Cart is empty - this might indicate combos were removed")},[l,i]);const x=m=>m.type==="combo"?m.final_price||m.price:m.final_price,h=l.reduce((m,L)=>{const pe=x(L);return m+pe*L.quantity},0);console.log(B,"eeeeeeeeeeee");const{trackCheckoutPageView:r,trackInitiateCheckout:b,trackPurchase:o,resetTracking:se}=It(),k=parseFloat((h/1.18).toFixed(2)),O=parseFloat((h-k).toFixed(2)),[v,ne]=d.useState(0),V=l.reduce((m,L)=>{const pe=Number(L.weight)||0;return m+pe*L.quantity},0),H=Number((me=_==null?void 0:_.find(m=>m.correlative==="importation_flete"))==null?void 0:me.description)||0,M=H>0?V*H:0,Y=(Number((te=_==null?void 0:_.find(m=>m.correlative==="importation_seguro"))==null?void 0:te.description)||0)/100,Z=k*Y,ce=parseFloat(k)+parseFloat(M)+parseFloat(Z),oe=(Number((_e=_==null?void 0:_.find(m=>m.correlative==="importation_derecho_arancelario"))==null?void 0:_e.description)||0)/100,ee=ce*oe,[ae,ue]=d.useState(0),[a,$]=d.useState(null),[K,le]=d.useState([]),[ie,Q]=d.useState(0),p=k+O+parseFloat(v)+parseFloat(Z)+parseFloat(ee),G=ae+ie,xe=Math.max(0,p-G),[Ce,he]=d.useState([]),[fe,ge]=d.useState([]),[ve,X]=d.useState([]),[ye,ke]=d.useState(null);d.useEffect(()=>(r(i,l),()=>se()),[]),d.useEffect(()=>{r(i,l),i===2&&b(l,xe)},[i]);const c=m=>{u(m),window.scrollTo({top:0,behavior:"smooth"})},n={privacy_policy:"Políticas de privacidad",terms_conditions:"Términos y condiciones",saleback_policy:"Políticas de devolucion y cambio"},[g,N]=d.useState(null),z=m=>N(m),de=()=>N(null);return e.jsxs("div",{className:"min-h-screen bg-[#F7F9FB] py-4 md:py-12 px-2 sm:px-primary 2xl:px-0 2xl:max-w-7xl mx-auto",children:[e.jsxs("div",{className:"bg-white p-3 md:p-8 rounded-lg md:rounded-xl shadow-sm",children:[e.jsx("div",{className:"mb-4 md:mb-8",children:e.jsxs("div",{className:"flex items-center justify-between gap-1 md:gap-4 max-w-3xl mx-auto",children:[e.jsxs("div",{className:`flex flex-col items-center md:flex-row md:items-center gap-1 md:gap-2 ${i===1?"customtext-primary font-medium":"customtext-neutral-dark"}`,children:[e.jsx("span",{className:" bg-primary text-white w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs md:text-sm",children:"1"}),e.jsx("span",{className:"text-[10px] md:text-sm text-center",children:"Carrito"})]}),e.jsx("div",{className:"mb-4 lg:mb-0  flex-1 h-[2px] bg-gray-200 relative",children:e.jsx("div",{className:"absolute inset-0 bg-primary transition-all duration-500",style:{width:i>1?"100%":"0%"}})}),e.jsxs("div",{className:`flex flex-col items-center md:flex-row md:items-center gap-1 md:gap-2 ${i>1?"customtext-primary font-medium":"customtext-neutral-dark"}`,children:[e.jsx("span",{className:`w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs md:text-sm ${i>1?"bg-primary text-white":"bg-white customtext-primary"}`,children:"2"}),e.jsx("span",{className:"text-[10px] md:text-sm text-center",children:"Envío"})]}),e.jsx("div",{className:"mb-4 lg:mb-0  flex-1 h-[2px] bg-gray-200 relative",children:e.jsx("div",{className:"absolute inset-0 bg-primary transition-all duration-500",style:{width:i>2?"100%":"0%"}})}),e.jsxs("div",{className:`flex flex-col items-center md:flex-row md:items-center gap-1 md:gap-2 ${i===3?"customtext-primary  font-medium":"customtext-neutral-dark"}`,children:[e.jsx("span",{className:`w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs md:text-sm ${i===3?"bg-primary text-white":"bg-white customtext-primary"}`,children:"3"}),e.jsx("span",{className:"text-[10px] md:text-sm text-center",children:"Confirmación"})]})]})}),i===1&&e.jsx(_t,{data:A,cart:l,setCart:j,onContinue:()=>c(2),subTotal:k,envio:v,igv:O,fleteTotal:M,seguroImportacionTotal:Z,derechoArancelarioTotal:ee,totalFinal:xe,openModal:z,categorias:B,automaticDiscounts:K,setAutomaticDiscounts:le,automaticDiscountTotal:ie,setAutomaticDiscountTotal:Q,totalWithoutDiscounts:p,generals:_}),i===2&&e.jsx(qt,{data:A,items:q,setCode:ge,setDelivery:X,cart:l,setSale:he,setCart:j,onContinue:()=>c(3),noContinue:()=>c(1),subTotal:k,envio:v,setEnvio:ne,igv:O,fleteTotal:M,seguroImportacionTotal:Z,derechoArancelarioTotal:ee,totalFinal:xe,user:y,ubigeos:F,categorias:B,openModal:z,setCouponDiscount:ue,setCouponCode:$,automaticDiscounts:K,setAutomaticDiscounts:le,automaticDiscountTotal:ie,setAutomaticDiscountTotal:Q,totalWithoutDiscounts:p,conversionScripts:ye,setConversionScripts:ke,onPurchaseComplete:(m,L)=>{o(m,L)},generals:_}),i===3&&e.jsx(Lt,{code:fe,delivery:ve,cart:Ce,subTotal:k,envio:v,igv:O,fleteTotal:M,seguroImportacionTotal:Z,derechoArancelarioTotal:ee,totalFinal:xe,couponDiscount:ae,couponCode:a,automaticDiscounts:K,automaticDiscountTotal:ie,totalWithoutDiscounts:p,conversionScripts:ye,setConversionScripts:ke,onPurchaseComplete:(m,L)=>{o(m,L)},generals:_})]}),Object.keys(n).map((m,L)=>{var Ne;const pe=n[m],Se=((Ne=_.find(qe=>qe.correlative==m))==null?void 0:Ne.description)??"";return e.jsx(Nt,{isOpen:g===L,onRequestClose:de,contentLabel:pe,className:"fixed top-0 left-0 right-0 bottom-0 flex items-center justify-center p-4 z-50",overlayClassName:"fixed inset-0 bg-black bg-opacity-50 z-[999]",ariaHideApp:!1,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 pr-4",children:pe}),e.jsx("button",{onClick:de,className:"flex-shrink-0 text-gray-400 hover:text-red-500 transition-colors duration-200 p-1 hover:bg-gray-100 rounded-full","aria-label":"Cerrar modal",children:e.jsx(Ct,{size:24,strokeWidth:2})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:e.jsx("div",{className:"prose prose-gray max-w-none",children:e.jsx(wt,{html:Se})})}),e.jsx("div",{className:"flex justify-end p-6 border-t border-gray-200",children:e.jsx("button",{onClick:de,className:"px-6 py-2 bg-primary text-white rounded-lg  transition-colors duration-200 font-medium",children:"Cerrar"})})]})},L)})]})}export{Ss as default};
