var G=Object.defineProperty;var L=(m,g,f)=>g in m?G(m,g,{enumerable:!0,configurable:!0,writable:!0,value:f}):m[g]=f;var T=(m,g,f)=>L(m,typeof g!="symbol"?g+"":g,f);import{j as t}from"./AboutSimple-Cf8x2fCZ.js";import{B as z}from"./Base-CM9wJyDx.js";import{S as _}from"./SwitchFormGroup-DXN0cwVk.js";import{T as J}from"./TextareaFormGroup-CliirJM1.js";import{r as p}from"./index-BOnQTV8N.js";import{c as P}from"./ReactAppend-QR5TrZfj.js";import{S}from"./ProductCard-D9l7c7at.js";import{B as q}from"./BasicRest-BML1C-ua.js";import{I as A}from"./ImageFormGroup-40MuGzez.js";import{P as H}from"./plus-CTIomuuF.js";import{I as K}from"./image-BPmHvEaV.js";import{M as U,a as Q}from"./move-up-Gz4AiwKb.js";import{T as W}from"./trash-2-DU7LB6-f.js";import{M as X}from"./Modal-xDw9ufjg.js";import{T as Y}from"./Table-CjKaEY3W.js";import{D as M}from"./DxButton-DV0H-ZcL.js";import{C as Z,F as v,h as ee}from"./CreateReactScript-ddpUFpqR.js";import{R as D}from"./ReactAppend-Vm5G2nof.js";import{B as j}from"./BooleanLimit-D-OsQsek.js";import{I as O}from"./InputFormGroup-iZIO11ZN.js";import"./index-yBjzXJbu.js";import"./Global-CazroCzF.js";import"./tippy-react.esm-DmkRJDEW.js";import"./index-pSueRYGM.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./index-B6ujFmsw.js";/* empty css              */import"./Logout-BpuTJ_83.js";import"./main-B6F2O9-U.js";import"./___vite-browser-external_commonjs-proxy-DDYoOVPM.js";import"./MenuItemContainer-DcxtOi47.js";import"./index.esm-C48oHfFw.js";import"./index-ngrFHoWO.js";import"./CanAccess-CvMo-oCB.js";import"./CardProductKatya-ncpmQ0JU.js";import"./createLucideIcon-DfjclApS.js";/* empty css               */import"./General-apRuNwp7.js";import"./LaravelSession-Dz9cpV3l.js";class te extends q{constructor(){super(...arguments);T(this,"path","admin/categories");T(this,"hasFiles",!0)}}const V=p.forwardRef(({name:m="banners",label:g="Banners",initialValue:f=[],model:C="category"},B)=>{const[u,b]=p.useState([]),[c,d]=p.useState({}),i=p.useRef({});p.useImperativeHandle(B,()=>({getValue:()=>JSON.stringify(u),setValue:r=>{console.log("BannersJsonEditor.setValue called with:",r,"type:",typeof r);try{const n=typeof r=="string"?JSON.parse(r):r;if(console.log("Parsed value:",n,"is array:",Array.isArray(n)),b(Array.isArray(n)?n:[]),console.log("setBanners called, should trigger re-render"),Array.isArray(n)&&n.length>0){const e={};n.forEach((s,a)=>{e[a]=!0}),d(e)}}catch(n){console.error("Error setting banners:",n),b([])}},reset:()=>{b([]),i.current={}},getImageRefs:()=>i.current,getImageFiles:()=>{const r={};return console.log("getImageFiles - imageRefs.current:",i.current),Object.keys(i.current).forEach(n=>{var s;const e=i.current[n];console.log(`getImageFiles - index ${n}:`,e),(s=e==null?void 0:e.files)!=null&&s[0]&&(r[`banner_image_${n}`]=e.files[0],console.log(`getImageFiles - Added file for banner_image_${n}:`,e.files[0].name))}),console.log("getImageFiles - Final files object:",r),r}}));const k=()=>{const r={image:"",title:"",description:"",button_text:"",button_link:""},n=[...u,r];b(n),d({...c,[n.length-1]:!0}),i.current[n.length-1]={current:null}},E=async r=>{const{isConfirmed:n}=await S.fire({title:"¿Eliminar banner?",text:"Esta acción no se puede deshacer",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});if(n){const e=u.filter((l,o)=>o!==r);b(e),delete i.current[r];const s={};Object.keys(i.current).forEach(l=>{const o=parseInt(l);o>r?s[o-1]=i.current[l]:o<r&&(s[o]=i.current[l])}),i.current=s;const a={};Object.keys(c).forEach(l=>{const o=parseInt(l);o<r?a[o]=c[l]:o>r&&(a[o-1]=c[l])}),d(a)}},F=(r,n)=>{const e=n==="up"?r-1:r+1;if(e<0||e>=u.length)return;const s=[...u];[s[r],s[e]]=[s[e],s[r]],b(s);const a=i.current[r];i.current[r]=i.current[e],i.current[e]=a;const l=c[r],o=c[e];d({...c,[r]:o,[e]:l})},w=(r,n,e)=>{const s=[...u];s[r]={...s[r],[n]:e},b(s)},I=r=>{d({...c,[r]:!c[r]})};return t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"font-weight-bold mb-2",children:g}),t.jsxs("div",{className:"border rounded p-3 bg-light",children:[t.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[t.jsxs("small",{className:"text-muted",children:[u.length," banner",u.length!==1?"s":""," configurado",u.length!==1?"s":""]}),t.jsxs("button",{type:"button",className:"btn btn-sm btn-primary",onClick:k,children:[t.jsx(H,{size:16,className:"mr-1"}),"Agregar Banner"]})]}),u.length===0?t.jsxs("div",{className:"text-center py-4 text-muted",children:[t.jsx(K,{size:48,className:"mb-2 opacity-50",style:{display:"block",margin:"0 auto"}}),t.jsx("p",{className:"mb-0",children:"No hay banners configurados"}),t.jsx("small",{children:'Haz clic en "Agregar Banner" para comenzar'})]}):t.jsx("div",{className:"space-y-2",children:u.map((r,n)=>t.jsxs("div",{className:"card mb-2 shadow-sm",children:[t.jsxs("div",{className:"card-header bg-white d-flex justify-content-between align-items-center p-2",children:[t.jsxs("button",{type:"button",className:"btn btn-link text-left flex-grow-1 text-decoration-none p-2",onClick:()=>I(n),children:[t.jsxs("strong",{children:["Banner ",n+1]}),r.title&&t.jsxs("small",{className:"text-muted ml-2",children:["- ",r.title]})]}),t.jsxs("div",{className:"d-flex gap-1",children:[n>0&&t.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>F(n,"up"),title:"Mover arriba",children:t.jsx(U,{size:14})}),n<u.length-1&&t.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>F(n,"down"),title:"Mover abajo",children:t.jsx(Q,{size:14})}),t.jsx("button",{type:"button",className:"btn btn-sm btn-outline-danger",onClick:()=>E(n),title:"Eliminar",children:t.jsx(W,{size:14})})]})]}),c[n]&&t.jsx("div",{className:"card-body p-3",children:t.jsxs("div",{className:"row",children:[t.jsxs("div",{className:"col-12 mb-3",children:[t.jsx(A,{eRef:(i.current[n]||(i.current[n]={current:null}),i.current[n]),name:`banner_image_${n}`,label:"Imagen del Banner",col:"col-12",aspect:16/9,onChange:e=>{if(e.target.files&&e.target.files[0]){const s=e.target.files[0];w(n,"image",s.name)}}}),r.image&&t.jsxs("small",{className:"text-muted d-block mt-2",children:["Archivo actual: ",t.jsx("strong",{children:r.image})]})]}),t.jsxs("div",{className:"col-12 mb-3",children:[t.jsx("label",{className:"font-weight-semibold small",children:"Título"}),t.jsx("input",{type:"text",className:"form-control form-control-sm",placeholder:"Título del banner",value:r.title||"",onChange:e=>w(n,"title",e.target.value)})]}),t.jsxs("div",{className:"col-12 mb-3",children:[t.jsx("label",{className:"font-weight-semibold small",children:"Descripción"}),t.jsx("textarea",{className:"form-control form-control-sm",rows:"3",placeholder:"Descripción del banner",value:r.description||"",onChange:e=>w(n,"description",e.target.value)})]}),t.jsxs("div",{className:"col-md-6 mb-3",children:[t.jsx("label",{className:"font-weight-semibold small",children:"Texto del Botón"}),t.jsx("input",{type:"text",className:"form-control form-control-sm",placeholder:"Ver más",value:r.button_text||"",onChange:e=>w(n,"button_text",e.target.value)})]}),t.jsxs("div",{className:"col-md-6 mb-3",children:[t.jsx("label",{className:"font-weight-semibold small",children:"Link del Botón"}),t.jsx("input",{type:"text",className:"form-control form-control-sm",placeholder:"/ruta-destino",value:r.button_link||"",onChange:e=>w(n,"button_link",e.target.value)})]})]})})]},`banner-${n}-${r.image||"new"}`))})]}),t.jsx("input",{type:"hidden",name:m,value:JSON.stringify(u)})]})});V.displayName="BannersJsonEditor";const R=new te,se=()=>{const m=p.useRef(),g=p.useRef(),f="categories",C=p.useRef(),B=p.useRef(),u=p.useRef(),b=p.useRef(),c=p.useRef(),d=p.useRef(),i=p.useRef(),[k,E]=p.useState(!1),F=e=>{if(console.log("=== onModalOpen called ==="),console.log("Full data object:",e),console.log("data.banners specifically:",e==null?void 0:e.banners),console.log("typeof data.banners:",typeof(e==null?void 0:e.banners)),e!=null&&e.id?E(!0):E(!1),C.current.value=(e==null?void 0:e.id)??"",B.current.value=(e==null?void 0:e.name)??"",u.current.value=(e==null?void 0:e.alias)??"",b.current.value=(e==null?void 0:e.description)??"",c.image.src=e!=null&&e.banner?`/storage/images/category/${e.banner}`:"",c.current.value=null,d.image.src=e!=null&&e.image?`/storage/images/category/${e.image}`:"",d.current.value=null,i.current){let s=(e==null?void 0:e.banners)||[];if(console.log("Categories.onModalOpen - data.banners:",e==null?void 0:e.banners),console.log("Categories.onModalOpen - banners type:",typeof s),typeof s=="string")try{s=JSON.parse(s)}catch(l){console.error("Error parsing banners JSON:",l),s=[]}console.log("Categories.onModalOpen - calling setValue with:",s),i.current.setValue(s);const a=(l=1)=>{console.log(`Attempt ${l} to load banner images...`);const o=i.current.getImageRefs();console.log("imageRefs:",o);let N=!0;s.forEach((h,x)=>{if(h.image){const y=o[x];console.log(`Banner ${x} - Full ref:`,y),console.log(`Banner ${x} - imgRef.image:`,y==null?void 0:y.image),console.log(`Banner ${x} - All properties:`,Object.keys(y||{})),y!=null&&y.image?(y.image.src=`/storage/images/category/${h.image}`,console.log(`✓ Loaded image for banner ${x}:`,h.image)):(N=!1,console.log(`✗ Ref not ready for banner ${x}`))}}),!N&&l<5&&setTimeout(()=>a(l+1),300)};setTimeout(()=>a(),500)}c.resetDeleteFlag&&c.resetDeleteFlag(),d.resetDeleteFlag&&d.resetDeleteFlag(),$(g.current).modal("show")},w=async e=>{e.preventDefault();const s={id:C.current.value||void 0,name:B.current.value,alias:u.current.value,description:b.current.value},a=new FormData;for(const h in s)a.append(h,s[h]);const l=d.current.files[0];l&&a.append("image",l);const o=c.current.files[0];if(o&&a.append("banner",o),i.current){a.append("banners",i.current.getValue());const h=i.current.getImageFiles();Object.keys(h).forEach(x=>{a.append(x,h[x])})}c.getDeleteFlag&&c.getDeleteFlag()&&a.append("banner_delete","DELETE"),d.getDeleteFlag&&d.getDeleteFlag()&&a.append("image_delete","DELETE");for(let[h,x]of a.entries());await R.save(a)&&(c.resetDeleteFlag&&c.resetDeleteFlag(),d.resetDeleteFlag&&d.resetDeleteFlag(),$(m.current).dxDataGrid("instance").refresh(),$(g.current).modal("hide"))},I=async({id:e,value:s,previous:a})=>{if(s&&j.shouldBlock(f,"featured",a)){const o=j.get(f,"featured");let h=(o==null?void 0:o.message)??"Se alcanzó el límite de categorías destacadas.";o&&(h+=` Actualmente hay ${o.active??0} de ${o.max??0} categorías activas.`,ee("Root")&&o.general_key&&(h+=` Puedes ajustar el límite en Generales usando la clave ${o.general_key}.`)),S.fire({icon:"warning",title:"Límite alcanzado",text:h});return}const l=await R.boolean({id:e,field:"featured",value:s});l&&(j.has(f,"featured")&&(typeof l=="object"&&(l!=null&&l.limit)?j.updateFromServer(f,l):j.applyChange(f,"featured",{previous:a,next:s})),$(m.current).dxDataGrid("instance").refresh())},r=async({id:e,value:s})=>{await R.boolean({id:e,field:"visible",value:s})&&$(m.current).dxDataGrid("instance").refresh()},n=async e=>{const{isConfirmed:s}=await S.fire({title:"Eliminar registro",text:"¿Estas seguro de eliminar este registro?",icon:"warning",showCancelButton:!0,confirmButtonText:"Si, eliminar",cancelButtonText:"Cancelar"});!s||!await R.delete(e.id)||(j.has(f,"featured")&&e.featured&&j.applyChange(f,"featured",{previous:!0,next:!1}),$(m.current).dxDataGrid("instance").refresh())};return t.jsxs(t.Fragment,{children:[t.jsx(Y,{gridRef:m,title:"Categorías",rest:R,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(m.current).dxDataGrid("instance").refresh()}}),e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",text:"Nuevo registro",hint:"Nuevo registro",onClick:()=>F()}})},columns:[{dataField:"id",caption:"ID",visible:!1},{dataField:"name",caption:"Categoría",width:"30%"},{dataField:"description",caption:"Descripción",width:"50%"},v.has("categories","image")&&{dataField:"image",caption:"Imagen",width:"90px",allowFiltering:!1,cellTemplate:(e,{data:s})=>{D(e,t.jsx("img",{src:`/storage/images/category/${s.image}`,style:{width:"80px",height:"48px",objectFit:"cover",objectPosition:"center",borderRadius:"4px"},onError:a=>a.target.src="/api/cover/thumbnail/null"}))}},v.has("categories","banner")&&{dataField:"banner",caption:"Banner",width:"90px",allowFiltering:!1,cellTemplate:(e,{data:s})=>{D(e,t.jsx("img",{src:`/storage/images/category/${s.banner}`,style:{width:"80px",height:"48px",objectFit:"cover",objectPosition:"center",borderRadius:"4px"},onError:a=>a.target.src="/api/cover/thumbnail/null"}))}},{dataField:"featured",caption:"Destacado",dataType:"boolean",cellTemplate:(e,{data:s})=>{$(e).empty();const a=s.featured==1,o=j.has(f,"featured")&&j.shouldBlock(f,"featured",a),N=o?j.getMessage(f,"featured"):null;N?$(e).attr("title",N):$(e).removeAttr("title"),D(e,t.jsx(_,{checked:a,disabled:o,onChange:()=>I({id:s.id,value:!a,previous:a})}))}},{dataField:"visible",caption:"Visible",dataType:"boolean",cellTemplate:(e,{data:s})=>{$(e).empty(),D(e,t.jsx(_,{checked:s.visible==1,onChange:()=>r({id:s.id,value:!s.visible})}))}},{caption:"Acciones",cellTemplate:(e,{data:s})=>{e.css("text-overflow","unset"),e.append(M({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>F(s)})),e.append(M({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash",onClick:()=>n(s)}))},allowFiltering:!1,allowExporting:!1}]}),t.jsxs(X,{modalRef:g,title:k?"Editar categoría":"Agregar categoría",onSubmit:w,children:[t.jsx("input",{ref:C,type:"hidden"}),t.jsxs("div",{className:"row",id:"categories-container",children:[t.jsxs("div",{className:!v.has("categories","banner")&&!v.has("categories","image")?"hidden":"col-md-6",children:[t.jsx(A,{eRef:c,name:"banner",label:"Banner",col:"col-12",aspect:3/1,hidden:!v.has("categories","banner")}),t.jsx(A,{eRef:d,name:"image",label:"Imagen",col:"col-12",aspect:16/9,hidden:!v.has("categories","image")})]}),t.jsxs("div",{className:!v.has("categories","banner")&&!v.has("categories","image")?"col-md-12":"col-md-6",children:[t.jsx(O,{eRef:B,label:"Categoría",rows:2,required:!0}),t.jsx(O,{eRef:u,label:"Alias (Nombre para mostrar)",col:"col-12"}),t.jsx(J,{eRef:b,label:"Descripción",rows:3})]}),t.jsx("div",{className:"col-12 mt-3",children:t.jsx(V,{ref:i,name:"banners",label:"Banners del Catálogo",initialValue:[],model:"category"})})]})]})]})};Z((m,g)=>{P.createRoot(m).render(t.jsx(z,{...g,title:"Categorías",children:t.jsx(se,{...g})}))});
