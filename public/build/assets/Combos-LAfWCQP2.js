var L=Object.defineProperty;var H=(m,s,c)=>s in m?L(m,s,{enumerable:!0,configurable:!0,writable:!0,value:c}):m[s]=c;var D=(m,s,c)=>H(m,typeof s!="symbol"?s+"":s,c);import{j as r}from"./AboutSimple-Cf8x2fCZ.js";import{B as J}from"./Base-BtKyxfJk.js";import{S as K}from"./SwitchFormGroup-DXN0cwVk.js";import{r as a}from"./index-BOnQTV8N.js";import{c as Q}from"./ReactAppend-QR5TrZfj.js";import{s as T}from"./server.browser-Bf4gQIc7.js";import{S as F}from"./CartKuchara-D9l7c7at.js";import{M as U}from"./Modal-xDw9ufjg.js";import{T as W}from"./Table-BkLpM5NU.js";import{I as X}from"./ImageFormGroup-40MuGzez.js";import{I as E}from"./InputFormGroup-iZIO11ZN.js";import{S as Y}from"./SelectAPIFormGroup-BZe8H0Ph.js";import{D as B}from"./DxButton-DV0H-ZcL.js";import{C as Z}from"./CreateReactScript-HF4HuQek.js";import{C as P,N as I}from"./Number2Currency-ld0bFawA.js";import{R as _}from"./ReactAppend-Vm5G2nof.js";import"./main-B6F2O9-U.js";import"./CardProductKatya-ncpmQ0JU.js";import{B as ee}from"./BasicRest-BML1C-ua.js";import"./index-yBjzXJbu.js";import"./Global-Bz6gVLc5.js";import"./tippy-react.esm-DmkRJDEW.js";import"./index-pSueRYGM.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./index-B6ujFmsw.js";/* empty css              */import"./Logout-BpuTJ_83.js";import"./MenuItemContainer-DcxtOi47.js";import"./index.esm-C48oHfFw.js";import"./index-ngrFHoWO.js";import"./___vite-browser-external_commonjs-proxy-DDYoOVPM.js";import"./CanAccess-BOTQKW2g.js";import"./BooleanLimit-D-OsQsek.js";/* empty css               */import"./General-CE1RDd44.js";import"./LaravelSession-Dz9cpV3l.js";class te extends ee{constructor(){super(...arguments);D(this,"path","admin/combos");D(this,"hasFiles",!0)}}const j=new te,re=({items:m})=>{const[s,c]=a.useState([]),[u,b]=a.useState(null),[x,C]=a.useState(0),v=a.useRef(),y=a.useRef(),w=a.useRef(),R=a.useRef(),h=a.useRef(),d=a.useRef(),p=a.useRef(),l=a.useRef(),[k,S]=a.useState(!1),G=e=>e.reduce((t,i)=>{const o=parseFloat(i.final_price||0);return t+o},0);a.useEffect(()=>{const e=G(s);C(e)},[s]),a.useEffect(()=>{h.current&&(h.current.value=x.toFixed(2))},[x]);const M=e=>{const i=$(e.target).select2("data").map(o=>o.data);c(o=>{const g=o.map(f=>f.id),n=i.filter(f=>!g.includes(f.id));return[...o,...n]})},A=e=>{const t=s.filter(i=>i.id!==e);if(c(t),p.current){const i=t.map(o=>o.id.toString());$(p.current).val(i)}(u==null?void 0:u.id)===e&&b(null)},V=e=>{parseFloat(e.target.value||0)>x&&(F.fire("Error","El precio con descuento no puede ser mayor al precio acumulado.","error"),d.current.value="")},N=async e=>{if(e!=null&&e.id){S(!0);const t=await j.get(e.id,["items"]);if(!t)return;w.current.value=t.id||"",R.current.value=t.name||"",h.current.value=t.price||0,d.current.value=t.discount||0,l.current.value=null,l.image.src=t!=null&&t.image?`/storage/images/combo/${t.image}`:"",l.resetDeleteFlag&&l.resetDeleteFlag();const i=t.items||[],o=i.find(g=>{var f;const n=(f=g.pivot)==null?void 0:f.is_main_item;return n===1||n==="1"||n===!0||n==="true"});b(o||null),c(i),setTimeout(()=>{if(p.current){const g=i.map(n=>n.id.toString());$(p.current).val(g)}},100)}else S(!1),c([]),b(null),C(0),w.current.value="",R.current.value="",h.current.value=0,d.current.value=0,l.resetDeleteFlag&&l.resetDeleteFlag(),p.current&&$(p.current).val([]);$(y.current).modal("show")},q=async e=>{if(e.preventDefault(),s.length===0){F.fire({title:"Error",text:"Debes seleccionar al menos un producto para crear el combo.",icon:"error"});return}if(!u){F.fire({title:"Error",text:"Debes marcar un producto como principal antes de guardar el combo.",icon:"error"});return}const t={id:w.current.value||void 0,name:R.current.value,price:x,discount:d.current.value,final_price:d.current.value>0&&d.current.value<x?d.current.value:x,discount_percent:100-d.current.value/h.current.value*100},i=new FormData;for(const n in t)t[n]!==void 0&&i.append(n,t[n]);s.forEach((n,f)=>{i.append(`items[${f}][item_id]`,n.id),i.append(`items[${f}][is_main_item]`,(u==null?void 0:u.id)===n.id?1:0)});const o=l.current.files[0];o&&i.append("image",o),l.getDeleteFlag&&l.getDeleteFlag()&&i.append("image_delete","DELETE"),await j.save(i)&&(l.resetDeleteFlag&&l.resetDeleteFlag(),$(v.current).dxDataGrid("instance").refresh(),$(y.current).modal("hide"),c([]),b(null),C(0),p.current&&$(p.current).val([]))},O=async({id:e,value:t})=>{await j.boolean({id:e,field:"visible",value:t})&&$(v.current).dxDataGrid("instance").refresh()},z=async e=>{const{isConfirmed:t}=await F.fire({title:"Eliminar combo",text:"¿Estás seguro de eliminar este combo?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});!t||!await j.delete(e)||$(v.current).dxDataGrid("instance").refresh()};return r.jsxs(r.Fragment,{children:[r.jsx(W,{gridRef:v,title:"Combos",rest:j,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(v.current).dxDataGrid("instance").refresh()}}),e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",text:"Nuevo combo",hint:"Nuevo combo",onClick:()=>N()}})},exportable:!0,exportableName:"Combos",columns:[{dataField:"id",caption:"ID",visible:!1},{dataField:"name",caption:"Nombre",cellTemplate:(e,{data:t})=>{e.html(T.renderToString(r.jsxs(r.Fragment,{children:[r.jsx("b",{children:t.name}),r.jsx("br",{}),r.jsx("span",{className:"truncate",children:t.summary})]})))}},{dataField:"image",caption:"Imagen",width:"80px",cellTemplate:(e,{data:t})=>{_(e,r.jsx("img",{src:`/storage/images/combo/${t.image}`,style:{width:"80px",height:"48px",objectFit:"cover",objectPosition:"center",borderRadius:"4px"},onError:i=>i.target.src="/api/cover/thumbnail/null"}))}},{dataField:"final_price",caption:"Precio",dataType:"number",width:"100px",cellTemplate:(e,{data:t})=>{e.html(T.renderToString(r.jsxs(r.Fragment,{children:[t.discount>0&&r.jsxs("small",{className:"d-block text-muted",style:{textDecoration:"line-through"},children:[P()," ",I(t.price)]}),r.jsxs("span",{children:[P()," ",I(t.discount>0?t.discount:t.price)]})]})))}},{dataField:"visible",caption:"Visible",dataType:"boolean",width:"80px",cellTemplate:(e,{data:t})=>{_(e,r.jsx(K,{checked:t.visible,onChange:i=>O({id:t.id,value:i.target.checked})}))}},{caption:"Acciones",width:"100px",cellTemplate:(e,{data:t})=>{e.css("text-overflow","unset"),e.append(B({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>N(t)})),e.append(B({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash",onClick:()=>z(t.id)}))},allowFiltering:!1,allowExporting:!1}]}),r.jsx(U,{modalRef:y,title:k?"Editar combo":"Agregar combo",onSubmit:q,size:"lg",children:r.jsxs("div",{className:"row",id:"combo-container",children:[r.jsx("input",{ref:w,type:"hidden"}),r.jsxs("div",{className:"col-md-6",children:[r.jsx(E,{eRef:R,label:"Nombre",required:!0}),r.jsx(E,{label:"Precio",eRef:h,type:"number",readOnly:!0}),r.jsx(E,{eRef:d,label:"Precio con Descuento",type:"number",step:"0.01",onChange:V}),r.jsx(Y,{id:"items",eRef:p,searchAPI:"/api/admin/items/paginate",searchBy:"name",label:"Productos",dropdownParent:"#combo-container",multiple:!0,onChange:M})]}),r.jsx("div",{className:"col-md-6",children:r.jsx(X,{eRef:l,name:"image",label:"Imagen del Combo",col:"col-12",aspect:"4/3",required:!0})}),r.jsxs("div",{className:"col-md-12 row",children:[r.jsx("h4",{className:"col-md-12",children:"Productos Seleccionados"}),r.jsx("ul",{className:"list-unstyled col-md-12 row",children:s.map(e=>{const t=u&&`${u.id}`==`${e.id}`;return r.jsxs("li",{className:"col-md-6",children:[r.jsx("input",{type:"radio",name:"mainProduct",checked:t,onChange:()=>{b(e)}}),r.jsx("div",{children:r.jsx("div",{class:"card mb-3",children:r.jsxs("div",{class:"row g-0",children:[r.jsx("div",{class:"col-md-4",children:r.jsx("img",{src:`/storage/images/item/${(e==null?void 0:e.image)??"undefined"}`,class:"img-thumbnail rounded-start",alt:e.name})}),r.jsx("div",{class:"col-md-8",children:r.jsxs("div",{class:"card-body",children:[r.jsxs("h5",{class:"card-title",children:[e==null?void 0:e.name," "]}),r.jsxs("p",{class:"card-text small line-clamp-2",children:[e==null?void 0:e.summary," "]}),r.jsx("p",{class:"card-text",children:r.jsxs("strong",{children:["Precio: ",P()," ",e==null?void 0:e.final_price]})}),r.jsx("button",{className:"btn btn-sm btn-danger pull-left",type:"button",onClick:()=>A(e.id),children:"Eliminar"})]})})]})})})]},e.id)})})]})]})})]})};Z((m,s)=>{Q.createRoot(m).render(r.jsx(J,{...s,title:"Combos",children:r.jsx(re,{...s})}))});
