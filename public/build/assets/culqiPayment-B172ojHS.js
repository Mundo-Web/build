import{m as e}from"./vendor-react-SBvaUJTK.js";import{G as r}from"./Footer-BligNWSa.js";import{G as o}from"./General-ClVW7qxN.js";import{t}from"./OpenPayCardModal-C0HhlOHJ.js";class i{static async validateCoupon(r){try{const{status:o,result:t}=await e.Fetch("./api/coupons/validate",{method:"POST",body:JSON.stringify(r)});if(!o)throw new Error(t?.message||"Error al validar cupón");return t}catch(o){throw o}}static async generateCode(){try{const{status:r,result:o}=await e.Fetch("./api/coupons/generate-code",{method:"GET"});if(!r)throw new Error(o?.message||"Error al generar código");return o}catch(r){throw r}}}const a={initialized:!1,deviceFingerPrint:null,isAvailable:()=>void 0!==window.Culqi3DS,async init(e){if(!this.isAvailable())return!1;try{return window.Culqi3DS.publicKey=r.CULQI_PUBLIC_KEY,window.Culqi3DS.settings={charge:{totalAmount:e.amount,returnUrl:window.location.href,currency:e.currency||"PEN"},card:{email:e.email}},window.Culqi3DS.options={showModal:!0,showLoading:!0,showIcon:!0,closeModalAction:()=>{},style:{btnColor:r.APP_COLOR_PRIMARY||"#000000",btnTextColor:"#FFFFFF"}},this.initialized=!0,!0}catch(o){return!1}},async generateDeviceFingerPrint(){if(!this.isAvailable())return null;try{return this.deviceFingerPrint=await window.Culqi3DS.generateDevice(),this.deviceFingerPrint}catch(e){return null}},initAuthentication(e){return new Promise((r,o)=>{if(!this.isAvailable())return void o(new Error("Culqi3DS no está disponible"));const t=e=>{const i=e.data;i&&"object"==typeof i&&(i.loading,i.parameters3DS&&(window.removeEventListener("message",t),r({success:!0,parameters3DS:i.parameters3DS})),i.error&&(window.removeEventListener("message",t),o(new Error(i.error))))};window.addEventListener("message",t,!1);try{window.Culqi3DS.initAuthentication(e)}catch(i){window.removeEventListener("message",t),o(i)}})},reset(){this.isAvailable()&&"function"==typeof window.Culqi3DS.reset&&(window.Culqi3DS.reset(),this.deviceFingerPrint=null,this.initialized=!1)}},n={async createOrder(r,o){try{const{status:t,result:i}=await e.Fetch("/api/culqi/order",{method:"POST",body:JSON.stringify({sale:r,details:o})});if(!t)throw new Error(i?.message||"Error al crear orden en Culqi");return i}catch(t){throw t}},async createCheckoutOrder(r){try{const{status:o,result:t}=await e.Fetch("/api/culqi/checkout-order",{method:"POST",body:JSON.stringify(r)});if(!o)throw new Error(t?.message||"Error al crear orden de checkout en Culqi");return t}catch(o){throw o}}};function s(){return!0===r.CULQI_SUPPORTS_USD}function c(){return"USD"===function(){const e=o.get("currency")||"pen";return s()&&"usd"===e.toLowerCase()?"USD":(e.toLowerCase(),"PEN")}()?"$":"S/"}function l(e){const t=o.get("currency")||"pen";if("pen"===t.toLowerCase())return{amount:e,currency:"PEN",wasConverted:!1,exchangeRate:1,originalAmount:e,originalCurrency:"PEN"};if("usd"===t.toLowerCase()&&s())return{amount:e,currency:"USD",wasConverted:!1,exchangeRate:1,originalAmount:e,originalCurrency:"USD"};if("usd"===t.toLowerCase()&&!s()){const t=function(){const e=r.EXCHANGE_RATE||o.get("exchange_rate_usd_pen")||3.75;return parseFloat(e)}();return{amount:e*t,currency:"PEN",wasConverted:!0,exchangeRate:t,originalAmount:e,originalCurrency:"USD"}}return{amount:e,currency:t.toUpperCase(),wasConverted:!1,exchangeRate:1,originalAmount:e,originalCurrency:t.toUpperCase()}}let d=null;const u=async(i,s={})=>{if(!s.orderId&&!s.skipOrderCreation)try{const e=await n.createCheckoutOrder({amount:i.amount,email:i.email,name:i.name,lastname:i.lastname,phone:i.phone}),r=e?.data||e,o=r?.order_id;o&&(s.orderId=o,s.orderData=r)}catch(u){}return new Promise((n,u)=>{try{const{orderId:p,orderData:h}=s,m=!!p;if(!r.CULQI_ENABLED)return void u("Método de pago no disponible: Culqi está deshabilitado");if(void 0===window.CulqiCheckout)return void u("Error en la integración con Culqi: Script no cargado");if(!r.CULQI_PUBLIC_KEY)return void u("Error de configuración: Clave pública de Culqi no encontrada");const C=function(){const e=r.CULQI_RSA_ID,o=r.CULQI_RSA_PUBLIC_KEY;if(!e||!o)return{valid:!0,hasRSA:!1,warning:"RSA no configurado - Usando encriptación estándar de Culqi (segura)"};if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e))return{valid:!0,hasRSA:!1,warning:"RSA ID inválido - Usando encriptación estándar de Culqi"};const t=o.includes("-----BEGIN PUBLIC KEY-----"),i=o.includes("-----END PUBLIC KEY-----");return t&&i?(o.includes("MIGf")||o.includes("MIIBIj"),{valid:!0,hasRSA:!0,info:"RSA configurado correctamente para encriptación adicional"}):{valid:!0,hasRSA:!1,warning:"RSA Public Key formato inválido - Usando encriptación estándar de Culqi"}}();C.warning,C.hasRSA,C.hasRSA;r.CULQI_PUBLIC_KEY?.startsWith("pk_test_"),r.CULQI_PUBLIC_KEY?.startsWith("pk_live_"),o.get("currency");const w=l(i.amount);w.wasConverted?t.info("Conversión de moneda",{description:`Tu pago de $${w.originalAmount.toFixed(2)} USD será procesado como S/${w.amount.toFixed(2)} PEN (TC: ${w.exchangeRate})`,duration:5e3}):w.currency;const y=function(){let e="";for(let r=0;r<12;r++)e+=Math.floor(10*Math.random());return e}(),f=w.currency,P=(c(),parseFloat(w.amount.toFixed(2))),v=Math.round(100*P);if(v<("USD"===f?100:300))return void u(`El monto mínimo para pago con tarjeta es ${"USD"===f?"$1.00":"S/ 3.00"}`);const S={title:r.CULQI_NAME||r.APP_NAME||"Pago",currency:f,amount:v};!!0&&C.hasRSA;const E={email:i.email||""},A={lang:"auto",installments:!1,modal:!0,paymentMethods:m?{tarjeta:!0,yape:!0,bancaMovil:!0,agente:!0,billetera:!0,cuotealo:!1}:{tarjeta:!0,yape:!1,bancaMovil:!1,agente:!1,billetera:!1,cuotealo:!1},paymentMethodsSort:m?["tarjeta","yape","bancaMovil","billetera","agente"]:["tarjeta"]},_=r.APP_URL||window.APP_URL||window.location.origin,b={theme:"default",hiddenCulqiLogo:!1,hiddenBannerContent:!1,hiddenBanner:!1,hiddenToolBarAmount:!1,menuType:"sidebar",buttonCardPayText:"Pagar",logo:`${_}/assets/resources/icon.png`,defaultStyle:{bannerColor:r.APP_COLOR_PRIMARY||"#000000",buttonBackground:r.APP_COLOR_PRIMARY||"#000000",menuColor:r.APP_COLOR_PRIMARY||"#000000",linksColor:r.APP_COLOR_PRIMARY||"#000000",buttonTextColor:"#FFFFFF",priceColor:r.APP_COLOR_PRIMARY||"#000000"}};m&&(S.order=p);const D={settings:S,client:E,options:A,appearance:b};try{d=new window.CulqiCheckout(r.CULQI_PUBLIC_KEY,D)}catch(g){return void u("Error en la integración con Culqi: "+g.message)}let I=!1;d.culqi=async function(){try{if(d.error){const e=d.error.user_message||d.error.merchant_message||"Error al procesar el pago";return t.error("Error en el pago",{description:e,duration:5e3,position:"top-right",richColors:!0}),void u(e)}if(d.charge){I=!0;const o=d.charge,a={...i,chargeId:o.id,orderNumber:y,chargeData:o,paymentType:"charge_completed"},{status:s,result:c}=await e.Fetch("./api/pago/charge-completed",{method:"POST",body:JSON.stringify(a)});try{d.close()}catch(r){}return s?(t.success("¡Pago exitoso!",{description:"Tu pago se procesó correctamente con autenticación 3DS.",duration:3e3,position:"top-right",richColors:!0}),void n(c)):(t.error("Error al registrar el pago",{description:c?.message||"Error al registrar el pago",duration:5e3,position:"top-right",richColors:!0}),void u(c?.message||"Error al registrar el pago"))}if(d.token){I=!0;const s=d.token.id,c=d.token;let l=null;a.isAvailable()&&(await a.init({amount:v,currency:f,email:i.email}),l=await a.generateDeviceFingerPrint());const g={...i,token:s,orderNumber:y,tokenData:c,deviceFingerPrint:l};let{status:p,result:h}=await e.Fetch("./api/pago",{method:"POST",body:JSON.stringify(g)});if(!p&&h?.requires_3ds){try{d.close()}catch(r){}if(!a.isAvailable())return t.error("Error en autenticación",{description:"El servicio de autenticación 3DS no está disponible. Por favor recarga la página.",duration:5e3,position:"top-right",richColors:!0}),void u("Servicio 3DS no disponible");try{t.info("Autenticación requerida",{description:"Por favor completa la verificación de seguridad de tu banco.",duration:5e3,position:"top-right",richColors:!0}),await new Promise(e=>setTimeout(e,300));const r=await a.initAuthentication(s);if(r.success&&r.parameters3DS){const o={...g,authentication_3DS:r.parameters3DS},t=await e.Fetch("./api/pago/3ds",{method:"POST",body:JSON.stringify(o)});p=t.status,h=t.result,a.reset()}}catch(o){return a.reset(),t.error("Error en autenticación",{description:o.message||"No se pudo completar la autenticación 3DS",duration:5e3,position:"top-right",richColors:!0}),void u(o.message||"Error en autenticación 3DS")}}if(!p)return t.error("Error en el pago",{description:h?.message||"Error al procesar el pago",duration:5e3,position:"top-right",richColors:!0}),void u(h?.message||"Error en el pago");try{d.close()}catch(r){}return t.success("¡Pago exitoso!",{description:"Tu pago se procesó correctamente. Pronto recibirás la confirmación.",duration:3e3,position:"top-right",richColors:!0}),void n(h)}if(d.order){I=!0;const o=d.order,a={...i,orderId:o.id,orderNumber:y,orderData:o,paymentType:"order"},{status:s,result:c}=await e.Fetch("./api/pago/order",{method:"POST",body:JSON.stringify(a)});try{d.close()}catch(r){}if(!s)throw new Error(c?.message||"Error al procesar la orden");return t.success("¡Orden creada!",{description:"Tu orden ha sido registrada. Completa el pago según las instrucciones.",duration:5e3,position:"top-right",richColors:!0}),void n(c)}u("No se recibió respuesta del procesador de pagos")}catch(g){t.error("¡Error en el Pago!",{description:g.message||"Error desconocido",duration:3e3,position:"top-right",richColors:!0}),u(g.message||"Error en el pago")}},d.handleClose=function(){I||u({cancelled:!0,message:"Pago cancelado por el usuario"})};let R=null,L=null;(()=>{const e=()=>document.querySelector('[id*="culqi"]')||document.querySelector(".culqi-checkout")||document.querySelector('iframe[src*="culqi"]')||document.querySelector('[class*="culqi"]');let r=!1;L=setInterval(()=>{e()&&!r&&(r=!0,R=new MutationObserver(o=>{e()||!r||I||(R.disconnect(),clearInterval(L),u({cancelled:!0,message:"Pago cancelado por el usuario"}))}),R.observe(document.body,{childList:!0,subtree:!0}))},100),setTimeout(()=>{L&&clearInterval(L)},1e4)})(),d.open()}catch(g){t.error("¡Error en la integración con Culqi!",{description:g.message||"Error desconocido",duration:3e3,position:"top-right",richColors:!0}),u("Error en la integración con Culqi: "+g.message)}})};export{i as C,u as p};
