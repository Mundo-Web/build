import{j as t}from"./AboutSimple-Cf8x2fCZ.js";import{r as c}from"./index-BOnQTV8N.js";import{c as Oe}from"./ReactAppend-QR5TrZfj.js";import{B as ze}from"./Base-CyjIzfyX.js";import{C as Qe}from"./CreateReactScript-VGUj2QOR.js";import{T as Je}from"./Table-Ccf-_54m.js";import{I as d}from"./InputFormGroup-iZIO11ZN.js";import{R as je}from"./ReactAppend-Vm5G2nof.js";import{D as ie}from"./DxButton-DV0H-ZcL.js";import{S as V}from"./SwitchFormGroup-DXN0cwVk.js";import{S as ce}from"./SelectFormGroup-X8WqJHHl.js";import{S as C}from"./SelectAPIFormGroup-BZe8H0Ph.js";import{T as He}from"./TextareaFormGroup-CliirJM1.js";import{M as Re}from"./Modal-xDw9ufjg.js";import{S as p}from"./CartKuchara-D9l7c7at.js";import{B as Ye}from"./BasicRest-BML1C-ua.js";import{m as oe}from"./main-B6F2O9-U.js";import{s as O}from"./server.browser-Bf4gQIc7.js";import{S as z}from"./SetSelectValue-UxyCmHse.js";import{C as _}from"./Number2Currency-jIsa99f9.js";import"./index-yBjzXJbu.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./index-B6ujFmsw.js";import"./Global-Bz6gVLc5.js";import"./tippy-react.esm-DmkRJDEW.js";import"./index-pSueRYGM.js";/* empty css              */import"./Logout-BpuTJ_83.js";import"./MenuItemContainer-DcxtOi47.js";import"./index.esm-C48oHfFw.js";import"./index-ngrFHoWO.js";import"./___vite-browser-external_commonjs-proxy-DDYoOVPM.js";import"./CanAccess-BlvzCYjQ.js";/* empty css               */import"./General-apRuNwp7.js";import"./LaravelSession-Dz9cpV3l.js";import"./BooleanLimit-D-OsQsek.js";import"./CardProductKatya-ncpmQ0JU.js";class Ue extends Ye{constructor(){super(),this.path="admin/discount-rules"}async duplicate(n){try{const{status:l,result:a}=await oe.Fetch(`/api/${this.path}/${n}/duplicate`,{method:"POST"});if(!l)throw new Error((a==null?void 0:a.message)||"Error duplicating rule");return a}catch(l){return console.error("Error duplicating rule:",l),!1}}async getProducts(){try{const n=await this.simpleGet(`/api/${this.path}/products`);return(n==null?void 0:n.data)||n||[]}catch(n){return console.error("Error fetching products:",n),[]}}async getCategories(){try{const n=await this.simpleGet(`/api/${this.path}/categories`);return(n==null?void 0:n.data)||n||[]}catch(n){return console.error("Error fetching categories:",n),[]}}async getProductsByIds(n){try{if(!n||n.length===0)return[];console.log("Fetching products by IDs:",n);const{status:l,result:a}=await oe.Fetch(`/api/${this.path}/products/by-ids`,{method:"POST",body:JSON.stringify({ids:n})});if(!l)throw new Error((a==null?void 0:a.message)||"Error fetching products by IDs");return console.log("Products fetched by IDs result:",a),(a==null?void 0:a.data)||a||[]}catch(l){return console.error("Error fetching products by ids:",l),[]}}async getCategoriesByIds(n){try{if(!n||n.length===0)return[];console.log("Fetching categories by IDs:",n);const{status:l,result:a}=await oe.Fetch(`/api/${this.path}/categories/by-ids`,{method:"POST",body:JSON.stringify({ids:n})});if(!l)throw new Error((a==null?void 0:a.message)||"Error fetching categories by IDs");return console.log("Categories fetched by IDs result:",a),(a==null?void 0:a.data)||a||[]}catch(l){return console.error("Error fetching categories by ids:",l),[]}}async getRuleTypes(){try{const n=await this.simpleGet(`/api/${this.path}/rule-types`);return(n==null?void 0:n.data)||n||{}}catch(n){return console.error("Error fetching rule types:",n),{}}}async getUsageStats(n){try{return await this.simpleGet(`/api/${this.path}/${n}/usage-stats`)}catch(l){return console.error("Error fetching usage stats:",l),null}}}const g=new Ue,Xe=({})=>{var he,ye,_e;const y=c.useRef(),n=c.useRef(),l=c.useRef(),a=c.useRef(),Q=c.useRef(),J=c.useRef(),S=c.useRef(),G=c.useRef(),H=c.useRef(),Y=c.useRef(),U=c.useRef(),X=c.useRef(),K=c.useRef(),W=c.useRef(),Z=c.useRef(),j=c.useRef(),T=c.useRef(),E=c.useRef(),P=c.useRef(),F=c.useRef(),R=c.useRef(),w=c.useRef(),q=c.useRef(),N=c.useRef(),I=c.useRef(),A=c.useRef(),D=c.useRef(),[ae,le]=c.useState(!1),[Ke,ue]=c.useState(null),[k,$e]=c.useState({}),[We,we]=c.useState([]),[Ze,qe]=c.useState([]),[h,x]=c.useState({}),[u,b]=c.useState({}),[f,de]=c.useState(""),me=e=>{const r=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),o=String(e.getHours()).padStart(2,"0"),m=String(e.getMinutes()).padStart(2,"0");return`${r}-${s}-${i}T${o}:${m}`},pe=e=>{const r=new Date(e),s=String(r.getDate()).padStart(2,"0"),i=String(r.getMonth()+1).padStart(2,"0"),o=String(r.getFullYear()).slice(-2),m=String(r.getHours()).padStart(2,"0"),v=String(r.getMinutes()).padStart(2,"0");return`${s}/${i}/${o} ${m}:${v}`},fe=e=>({quantity_discount:{conditions:{min_quantity:2,product_ids:[],category_ids:[]},actions:{discount_type:"percentage",discount_value:10}},cart_discount:{conditions:{min_amount:100,currency:"PEN"},actions:{discount_type:"percentage",discount_value:10}},buy_x_get_y:{conditions:{buy_quantity:2,product_ids:[]},actions:{get_quantity:1,discount_type:"fixed",discount_value:0}},category_discount:{conditions:{category_ids:[],min_quantity:1},actions:{discount_type:"percentage",discount_value:15}},tiered_discount:{conditions:{tiers:[{min_quantity:3,max_quantity:5},{min_quantity:6,max_quantity:10},{min_quantity:11,max_quantity:null}]},actions:{tier_discounts:[{discount_type:"percentage",discount_value:5},{discount_type:"percentage",discount_value:10},{discount_type:"percentage",discount_value:15}]}},bundle_discount:{conditions:{required_products:[],min_quantity_each:1},actions:{discount_type:"percentage",discount_value:25}}})[e]||{conditions:{min_quantity:1},actions:{discount_type:"percentage",discount_value:10}},Ne=e=>{if(de(e),e){const r=fe(e);x(r.conditions),b(r.actions)}else x({}),b({})};c.useEffect(()=>{Ce()},[]);const Ce=async()=>{const[e,r,s]=await Promise.all([g.getRuleTypes(),g.getProducts(),g.getCategories()]);$e(e),we(r),qe(s)},ge=e=>{e!=null&&e.id?(le(!0),ue(e)):(le(!1),ue(null)),a.current.value=(e==null?void 0:e.id)??"",Q.current.value=(e==null?void 0:e.name)??"",J.current.value=(e==null?void 0:e.description)??"";const r=(e==null?void 0:e.rule_type)??"";if(de(r),S.current&&($(S.current).val(r).trigger("change"),$(S.current).off("change.ruleType").on("change.ruleType",function(){const s=$(this).val();Ne(s)})),H.current.value=(e==null?void 0:e.priority)??0,Y.current.value=e!=null&&e.starts_at?me(new Date(e.starts_at)):"",U.current.value=e!=null&&e.ends_at?me(new Date(e.ends_at)):"",X.current.value=(e==null?void 0:e.usage_limit)??"",K.current.value=(e==null?void 0:e.usage_limit_per_customer)??"",(e==null?void 0:e.active)!==void 0?$(G.current).prop("checked",e.active).trigger("change"):$(G.current).prop("checked",!0).trigger("change"),$(W.current).prop("checked",(e==null?void 0:e.combinable)??!1).trigger("change"),$(Z.current).prop("checked",(e==null?void 0:e.stop_further_rules)??!1).trigger("change"),e!=null&&e.conditions||e!=null&&e.actions){const s=typeof e.conditions=="string"?JSON.parse(e.conditions):e.conditions||{},i=typeof e.actions=="string"?JSON.parse(e.actions):e.actions||{};x(s),b(i)}else if(r){const s=fe(r);x(s.conditions),b(s.actions)}else x({}),b({});$(n.current).modal("show")},Se=async e=>{if(e.preventDefault(),!re())return;const r={id:a.current.value||void 0,name:Q.current.value,description:J.current.value,rule_type:$(S.current).val(),active:G.current.checked,priority:parseInt(H.current.value)||0,starts_at:Y.current.value||null,ends_at:U.current.value||null,usage_limit:parseInt(X.current.value)||null,usage_limit_per_customer:parseInt(K.current.value)||null,combinable:W.current.checked,stop_further_rules:Z.current.checked,conditions:h,actions:u};await g.save(r)&&($(y.current).dxDataGrid("instance").refresh(),$(n.current).modal("hide"),p.fire({icon:"success",title:"¡Guardado!",text:ae?"La regla ha sido actualizada correctamente":"La nueva regla ha sido creada correctamente",timer:2e3,showConfirmButton:!1}))},Te=async({id:e,field:r,value:s})=>{await g.boolean({id:e,field:r,value:s})&&$(y.current).dxDataGrid("instance").refresh()},Ee=async e=>{await g.duplicate(e)&&$(y.current).dxDataGrid("instance").refresh()},Pe=async e=>{const{isConfirmed:r}=await p.fire({title:"Eliminar regla de descuento",text:"¿Estás seguro de eliminar esta regla?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});!r||!await g.delete(e)||$(y.current).dxDataGrid("instance").refresh()},Fe=()=>{$(l.current).modal("show"),(Object.keys(h).length>0||Object.keys(u).length>0)&&$(l.current).one("shown.bs.modal",()=>{setTimeout(()=>{De({conditions:h,actions:u})},500)})},Ie=e=>{const r=e.status||"Activa";return`<span class="badge badge-${{Activa:"success",Inactiva:"secondary",Programada:"info",Expirada:"warning",Agotada:"danger"}[r]||"secondary"}">${r}</span>`},Ae=e=>{const r=e.conditions||{},s=e.actions||{};let i=e.description||"";return e.rule_type==="quantity_discount"&&r.min_quantity&&s.discount_value?i=`Compra ${r.min_quantity}+ items → ${s.discount_value}${s.discount_type==="percentage"?"%":" soles"} desc.`:e.rule_type==="cart_discount"&&r.min_amount&&s.discount_value?i=`Compras desde ${_()} ${r.min_amount} → ${s.discount_value}${s.discount_type==="percentage"?"%":" soles"} desc.`:e.rule_type==="buy_x_get_y"&&r.buy_quantity&&s.get_quantity&&(i=`Compra ${r.buy_quantity} lleva ${s.get_quantity} gratis`),i},L=(e,r)=>{x(s=>({...s,[e]:r}))},ee=(e,r)=>{b(s=>({...s,[e]:r}))},te=()=>{const e={conditions:{},actions:{}};if(j.current&&(e.conditions.min_quantity=parseInt(j.current.value)||1),T.current&&(e.conditions.min_amount=parseFloat(T.current.value)||0),E.current&&(e.conditions.buy_quantity=parseInt(E.current.value)||1),F.current&&(e.conditions.min_quantity_each=parseInt(F.current.value)||1),q.current){const r=$(q.current).val();e.conditions.product_ids=r||[]}if(N.current){const r=$(N.current).val();e.conditions.category_ids=r||[]}if(I.current){const r=$(I.current).val();e.conditions.required_products=r||[]}if(R.current&&(e.actions.discount_type=R.current.value),w.current&&(e.actions.discount_value=parseFloat(w.current.value)||0),A.current&&(e.actions.max_discount=parseFloat(A.current.value)||null),P.current&&(e.actions.get_quantity=parseInt(P.current.value)||1),D.current){const r=$(D.current).val();e.actions.free_product_ids=r||[]}return e},De=e=>{const r=e.conditions||{},s=e.actions||{};j.current&&(j.current.value=r.min_quantity||""),T.current&&(T.current.value=r.min_amount||""),E.current&&(E.current.value=r.buy_quantity||""),F.current&&(F.current.value=r.min_quantity_each||""),R.current&&(R.current.value=s.discount_type||"percentage"),w.current&&(w.current.value=s.discount_value||""),A.current&&(A.current.value=s.max_discount||""),P.current&&(P.current.value=s.get_quantity||"");const i=async()=>{try{if(q.current&&r.product_ids&&Array.isArray(r.product_ids)&&r.product_ids.length>0){const o=await g.getProductsByIds(r.product_ids);z(q.current,o,"id","name")}if(N.current&&r.category_ids&&Array.isArray(r.category_ids)&&r.category_ids.length>0){const o=await g.getCategoriesByIds(r.category_ids);z(N.current,o,"id","name")}if(I.current&&r.required_products&&Array.isArray(r.required_products)&&r.required_products.length>0){const o=await g.getProductsByIds(r.required_products);z(I.current,o,"id","name")}if(D.current&&s.free_product_ids&&Array.isArray(s.free_product_ids)&&s.free_product_ids.length>0){const o=await g.getProductsByIds(s.free_product_ids);z(D.current,o,"id","name")}}catch(o){console.error("Error cargando datos para selects:",o)}};setTimeout(()=>i(),300),setTimeout(()=>i(),700),setTimeout(()=>i(),1200)},ke=()=>{switch(f){case"quantity_discount":return t.jsxs(t.Fragment,{children:[t.jsx(d,{eRef:j,label:"Cantidad mínima requerida",type:"number",min:"1",required:!0,specification:"El cliente debe comprar al menos esta cantidad"}),t.jsx(C,{eRef:q,label:"Productos específicos (opcional)",searchAPI:"/api/admin/items/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,specification:"Si no selecciona ninguno, aplicará a todos los productos"}),t.jsx(C,{eRef:N,label:"Categorías específicas (opcional)",searchAPI:"/api/admin/categories/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,specification:"Si no selecciona ninguna, aplicará a todas las categorías"})]});case"cart_discount":return t.jsx(t.Fragment,{children:t.jsx(d,{eRef:T,label:"Monto mínimo del carrito",type:"number",min:"0",step:"0.01",required:!0,prefix:_(),specification:"El carrito debe alcanzar este monto mínimo"})});case"buy_x_get_y":return t.jsxs(t.Fragment,{children:[t.jsx(d,{eRef:E,label:"Cantidad a comprar",type:"number",min:"1",required:!0,specification:"Cuántos productos debe comprar el cliente"}),t.jsx(C,{eRef:q,label:"Productos aplicables",searchAPI:"/api/admin/items/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,required:!0,specification:"Debe seleccionar al menos un producto"})]});case"category_discount":return t.jsxs(t.Fragment,{children:["            ",t.jsx(C,{eRef:N,label:"Categorías",searchAPI:"/api/admin/categories/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,required:!0,specification:"Seleccione las categorías que tendrán descuento"}),t.jsx(d,{eRef:j,label:"Cantidad mínima por categoría",type:"number",min:"1",specification:"Cantidad mínima de productos de la categoría seleccionada"})]});case"bundle_discount":return t.jsxs(t.Fragment,{children:["            ",t.jsx(C,{eRef:I,label:"Productos requeridos",searchAPI:"/api/admin/items/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,required:!0,specification:"El cliente debe comprar TODOS estos productos para obtener el descuento"}),t.jsx(d,{eRef:F,label:"Cantidad mínima de cada producto",type:"number",min:"1",specification:"Cantidad mínima que debe comprar de cada producto"})]});case"tiered_discount":return t.jsxs("div",{children:[t.jsx("div",{className:"alert alert-info",children:t.jsxs("small",{children:[t.jsx("strong",{children:"Descuento escalonado:"})," Diferentes descuentos según la cantidad comprada"]})}),t.jsx("label",{className:"form-label",children:"Configuración de niveles:"}),(h.tiers||[]).map((e,r)=>{var s,i;return t.jsx("div",{className:"card mb-2",children:t.jsx("div",{className:"card-body p-3",children:t.jsxs("div",{className:"row",children:[t.jsx("div",{className:"col-4",children:t.jsx(d,{label:"Cantidad mínima",type:"number",min:"1",value:e.min_quantity||1,onChange:o=>{const m=[...h.tiers||[]];m[r]={...e,min_quantity:parseInt(o.target.value)||1},L("tiers",m)}})}),t.jsx("div",{className:"col-4",children:t.jsx(d,{label:"Cantidad máxima",type:"number",placeholder:"Sin límite",value:e.max_quantity||"",onChange:o=>{const m=[...h.tiers||[]];m[r]={...e,max_quantity:o.target.value?parseInt(o.target.value):null},L("tiers",m)}})}),t.jsx("div",{className:"col-3",children:t.jsx(d,{label:"Descuento (%)",type:"number",min:"0",max:"100",value:((i=(s=u.tier_discounts)==null?void 0:s[r])==null?void 0:i.discount_value)||0,onChange:o=>{const m=[...u.tier_discounts||[]];m[r]={discount_type:"percentage",discount_value:parseInt(o.target.value)||0},ee("tier_discounts",m)}})}),t.jsx("div",{className:"col-1 d-flex align-items-end",children:t.jsx("button",{type:"button",className:"btn btn-sm btn-danger mb-3",onClick:()=>{var v,B;const o=((v=h.tiers)==null?void 0:v.filter((se,M)=>M!==r))||[],m=((B=u.tier_discounts)==null?void 0:B.filter((se,M)=>M!==r))||[];L("tiers",o),ee("tier_discounts",m)},title:"Eliminar nivel",children:t.jsx("i",{className:"fa fa-trash"})})})]})})},r)}),t.jsxs("button",{type:"button",className:"btn btn-sm btn-success",onClick:()=>{const e=[...h.tiers||[],{min_quantity:1,max_quantity:null}],r=[...u.tier_discounts||[],{discount_type:"percentage",discount_value:5}];L("tiers",e),ee("tier_discounts",r)},children:[t.jsx("i",{className:"fa fa-plus mr-1"})," Agregar nivel"]})]});default:return t.jsx("div",{className:"alert alert-warning",children:t.jsx("p",{className:"mb-0",children:"Seleccione un tipo de regla para configurar las condiciones."})})}},Be=()=>{switch(f){case"quantity_discount":case"cart_discount":case"category_discount":return t.jsxs(t.Fragment,{children:[t.jsxs(ce,{eRef:R,label:"Tipo de descuento",dropdownParent:"#conditions-actions-form",required:!0,specification:"Seleccione si el descuento es porcentaje o monto fijo",children:[t.jsx("option",{value:"percentage",children:"Porcentaje (%)"}),t.jsxs("option",{value:"fixed",children:["Monto fijo (",_(),")"]})]}),t.jsx(d,{eRef:w,label:"Valor del descuento",type:"number",min:"0",step:u.discount_type==="percentage"?"1":"0.01",max:u.discount_type==="percentage"?"100":void 0,required:!0,prefix:u.discount_type==="fixed"?_():"",suffix:u.discount_type==="percentage"?"%":"",specification:u.discount_type==="percentage"?"Porcentaje de descuento (1-100%)":"Monto fijo en soles"}),t.jsx(d,{eRef:A,label:"Descuento máximo (opcional)",type:"number",min:"0",step:"0.01",prefix:_(),specification:"Límite máximo del descuento aplicado"})]});case"buy_x_get_y":return t.jsxs(t.Fragment,{children:[t.jsx(d,{eRef:P,label:"Cantidad gratis a obtener",type:"number",min:"1",required:!0,specification:"Cuántos productos gratis obtendrá el cliente"}),t.jsx(C,{eRef:D,label:"Productos gratis (opcional)",searchAPI:"/api/admin/items/paginate",searchBy:"name",dropdownParent:"#conditions-actions-form",multiple:!0,tags:!0,specification:"Si no selecciona, los productos gratis serán los mismos que debe comprar"})]});case"bundle_discount":return t.jsxs(t.Fragment,{children:[t.jsxs(ce,{eRef:R,label:"Tipo de descuento del bundle",required:!0,specification:"Tipo de descuento para el conjunto de productos",dropdownParent:"#conditions-actions-form",children:[t.jsx("option",{value:"percentage",children:"Porcentaje (%)"}),t.jsxs("option",{value:"fixed",children:["Monto fijo (",_(),")"]})]}),t.jsx(d,{eRef:w,label:"Valor del descuento",type:"number",min:"0",step:u.discount_type==="percentage"?"1":"0.01",max:u.discount_type==="percentage"?"100":void 0,required:!0,prefix:u.discount_type==="fixed"?_():"",suffix:u.discount_type==="percentage"?"%":"",specification:"Descuento aplicado al conjunto completo de productos"})]});case"tiered_discount":return t.jsx("div",{className:"alert alert-info",children:t.jsxs("p",{className:"mb-0",children:[t.jsx("i",{className:"fa fa-info-circle mr-1"}),"Los descuentos escalonados se configuran en la sección de condiciones arriba."]})});default:return t.jsx("div",{className:"alert alert-warning",children:t.jsx("p",{className:"mb-0",children:"Seleccione un tipo de regla para configurar las acciones."})})}},Me=()=>{var o,m,v,B;if(!f)return"Seleccione un tipo de regla";const e=te(),r={...h,...e.conditions},s={...u,...e.actions},i=s.discount_type==="percentage"?`${s.discount_value||0}% de descuento`:s.discount_type==="fixed"?`${_()} ${s.discount_value||0} de descuento`:`${s.get_quantity||1} producto(s) gratis`;switch(f){case"quantity_discount":const se=(o=r.product_ids)!=null&&o.length?"en productos seleccionados":"en cualquier producto",M=(m=r.category_ids)!=null&&m.length?" de las categorías seleccionadas":"";return`Al comprar ${r.min_quantity||2} o más productos${M}, obtén ${i} ${se}`;case"cart_discount":return`En compras desde ${_()} ${r.min_amount||100}, obtén ${i}`;case"buy_x_get_y":return`Compra ${r.buy_quantity||2} productos de los seleccionados y lleva ${s.get_quantity||1} gratis`;case"category_discount":return`En productos de categorías${(v=r.category_ids)!=null&&v.length?" (categorías seleccionadas)":" (debe seleccionar categorías)"}, obtén ${i}`;case"bundle_discount":return`Al comprar ${((B=r.required_products)==null?void 0:B.length)||0} productos específicos juntos (${r.min_quantity_each||1} de cada uno), obtén ${i}`;case"tiered_discount":const xe=r.tiers||[];return xe.length===0?"Configurar niveles de descuento escalonado":`Descuentos escalonados: ${xe.map((ne,Ge)=>{var be,ve;const Le=((ve=(be=s.tier_discounts)==null?void 0:be[Ge])==null?void 0:ve.discount_value)||0,Ve=ne.max_quantity?` a ${ne.max_quantity}`:"+";return`${ne.min_quantity}${Ve} productos: ${Le}%`}).join(" | ")}`;default:return"Configuración por defecto aplicada"}};c.useEffect(()=>{const e=()=>{$(l.current).on("shown.bs.modal",function(){$('[data-toggle="select2"]',this).each(function(){$(this).hasClass("select2-hidden-accessible")||$(this).select2({dropdownParent:$("#conditions-actions-form"),width:"100%",placeholder:$(this).attr("placeholder")||"Seleccionar...",allowClear:!0,ajax:$(this).data("ajax")?{url:$(this).data("ajax"),dataType:"json",delay:250,data:function(r){return{search:r.term,page:r.page||1}},processResults:function(r,s){return s.page=s.page||1,{results:r.data.map(i=>({id:i.id,text:i.name||i.title})),pagination:{more:s.page*10<r.total}}}}:void 0})})}),$(l.current).on("hidden.bs.modal",function(){$('[data-toggle="select2"]',this).each(function(){$(this).hasClass("select2-hidden-accessible")&&$(this).select2("destroy")})})};return l.current&&e(),()=>{l.current&&$(l.current).off("shown.bs.modal hidden.bs.modal")}},[]);const re=(e=null,r=null)=>{if(!f)return p.fire("Error","Debe seleccionar un tipo de regla","error"),!1;if(!e||!r){const s=te();e={...h,...s.conditions},r={...u,...s.actions}}switch(f){case"quantity_discount":if(!e.min_quantity||e.min_quantity<1)return p.fire("Error","La cantidad mínima debe ser mayor a 0","error"),!1;break;case"cart_discount":if(!e.min_amount||e.min_amount<=0)return p.fire("Error","El monto mínimo debe ser mayor a 0","error"),!1;break;case"buy_x_get_y":if(!e.buy_quantity||e.buy_quantity<1)return p.fire("Error","La cantidad a comprar debe ser mayor a 0","error"),!1;if(!e.product_ids||e.product_ids.length===0)return p.fire("Error",'Debe seleccionar al menos un producto para la regla "Compra X lleva Y"',"error"),!1;if(!r.get_quantity||r.get_quantity<1)return p.fire("Error","La cantidad gratis debe ser mayor a 0","error"),!1;break;case"category_discount":if(!e.category_ids||e.category_ids.length===0)return p.fire("Error","Debe seleccionar al menos una categoría","error"),!1;break;case"bundle_discount":if(!e.required_products||e.required_products.length<2)return p.fire("Error","Debe seleccionar al menos 2 productos para el paquete","error"),!1;break;case"tiered_discount":if(!e.tiers||e.tiers.length===0)return p.fire("Error","Debe configurar al menos un nivel de descuento","error"),!1;for(let s=0;s<e.tiers.length-1;s++){const i=e.tiers[s],o=e.tiers[s+1];if(i.max_quantity&&o.min_quantity<=i.max_quantity)return p.fire("Error",`Los niveles ${s+1} y ${s+2} se superponen. Revise las cantidades.`,"error"),!1}break}if(f!=="tiered_discount"&&f!=="buy_x_get_y"){if(!r.discount_value||r.discount_value<=0)return p.fire("Error","El valor del descuento debe ser mayor a 0","error"),!1;if(r.discount_type==="percentage"&&r.discount_value>100)return p.fire("Error","El porcentaje de descuento no puede ser mayor a 100%","error"),!1}return!0};return t.jsxs(t.Fragment,{children:[t.jsx(Je,{gridRef:y,title:"Reglas de Descuento",rest:g,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(y.current).dxDataGrid("instance").refresh()}}),e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",text:"Nueva regla",hint:"Crear nueva regla de descuento",onClick:()=>ge()}})},columns:[{dataField:"id",caption:"ID",width:"60px",visible:!1},{dataField:"name",caption:"Nombre",width:"25%",cellTemplate:(e,{data:r})=>{je(e,t.jsxs("div",{children:[t.jsx("strong",{className:"d-block",children:r.name}),t.jsx("small",{className:"text-muted",children:Ae(r)})]}))}},{dataField:"rule_type",caption:"Tipo",width:"15%",cellTemplate:(e,{data:r})=>{var i;const s=((i=k[r.rule_type])==null?void 0:i.name)||r.rule_type;e.html(O.renderToString(t.jsx("span",{className:"badge badge-info",children:s})))}},{dataField:"priority",caption:"Prioridad",width:"80px",cellTemplate:(e,{data:r})=>{e.html(O.renderToString(t.jsx("span",{className:"badge badge-primary",children:r.priority})))}},{dataField:"dates",caption:"Vigencia",width:"15%",allowFiltering:!1,cellTemplate:(e,{data:r})=>{const s=r.starts_at||r.ends_at?t.jsxs(t.Fragment,{children:["                  ",r.starts_at&&t.jsx("div",{children:t.jsxs("small",{children:[t.jsx("strong",{children:"Desde:"})," ",pe(r.starts_at)]})}),r.ends_at&&t.jsx("div",{children:t.jsxs("small",{children:[t.jsx("strong",{children:"Hasta:"})," ",pe(r.ends_at)]})})]}):t.jsx("small",{className:"text-muted",children:"Sin límite de tiempo"});e.html(O.renderToString(s))}},{dataField:"usage",caption:"Uso",width:"10%",allowFiltering:!1,cellTemplate:(e,{data:r})=>{const s=r.used_count||0,i=r.usage_limit,o=i?`${s}/${i}`:`${s}`;e.html(O.renderToString(t.jsxs("div",{className:"text-center",children:[t.jsx("strong",{children:o}),i&&t.jsx("div",{className:"progress progress-sm mt-1",children:t.jsx("div",{className:"progress-bar",style:{width:`${Math.min(s/i*100,100)}%`}})})]})))}},{dataField:"status",caption:"Estado",width:"10%",cellTemplate:(e,{data:r})=>{e.html(Ie(r))}},{dataField:"active",caption:"Activa",width:"80px",cellTemplate:(e,{data:r})=>{const s=r.active===1||r.active==="1"||r.active===!0;je(e,t.jsx(V,{checked:s,onChange:i=>Te({id:r.id,field:"active",value:i.target.checked?1:0})}))}},{caption:"Acciones",width:"120px",cellTemplate:(e,{data:r})=>{e.css("text-overflow","unset"),e.append(ie({className:"btn btn-xs btn-soft-info mr-1",title:"Duplicar",icon:"fa fa-copy",onClick:()=>Ee(r.id)})),e.append(ie({className:"btn btn-xs btn-soft-primary mr-1",title:"Editar",icon:"fa fa-pen",onClick:()=>ge(r)})),e.append(ie({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash",onClick:()=>Pe(r.id)}))},allowFiltering:!1,allowExporting:!1}]}),t.jsx(Re,{modalRef:n,title:ae?"Editar regla de descuento":"Nueva regla de descuento",onSubmit:Se,size:"lg",children:t.jsxs("div",{className:"row",id:"discount-rule-form",children:[t.jsx("input",{ref:a,type:"hidden"}),t.jsxs("div",{className:"col-md-8",children:[t.jsx(d,{eRef:Q,label:"Nombre de la regla",required:!0}),t.jsx(He,{eRef:J,label:"Descripción",rows:2})]}),t.jsxs("div",{className:"col-md-4",children:[t.jsx(V,{eRef:G,label:"Regla activa"}),t.jsx(d,{eRef:H,label:"Prioridad",type:"number",min:0,specification:"Mayor número = mayor prioridad"})]}),t.jsx("div",{className:"col-md-6",children:t.jsxs(ce,{eRef:S,label:"Tipo de regla",dropdownParent:"#discount-rule-form",required:!0,children:[t.jsx("option",{value:"",children:"Seleccione un tipo"}),Object.entries(k).map(([e,r])=>t.jsx("option",{value:e,children:r.name},e))]})}),t.jsx("div",{className:"col-md-3",children:t.jsx(d,{eRef:Y,label:"Inicia",type:"datetime-local"})}),t.jsx("div",{className:"col-md-3",children:t.jsx(d,{eRef:U,label:"Termina",type:"datetime-local"})}),t.jsx("div",{className:"col-md-6",children:t.jsx(d,{eRef:X,label:"Límite total de usos",type:"number",min:1})}),t.jsx("div",{className:"col-md-6",children:t.jsx(d,{eRef:K,label:"Límite por cliente",type:"number",min:1})}),t.jsx("div",{className:"col-md-6",children:t.jsx(V,{eRef:W,label:"Combinable con otras reglas"})}),t.jsx("div",{className:"col-md-6",children:t.jsx(V,{eRef:Z,label:"Detener evaluación de otras reglas"})}),t.jsxs("div",{className:"col-12",children:[t.jsx("hr",{}),t.jsxs("button",{type:"button",className:"btn btn-info btn-block",onClick:Fe,children:[t.jsx("i",{className:"fa fa-cogs mr-2"}),"Configurar Condiciones y Acciones"]}),"          ",t.jsx("small",{className:"text-muted",children:"Define cuándo se aplica la regla y qué descuento otorga"})]})]})}),t.jsx(Re,{modalRef:l,title:"Configurar Condiciones y Acciones",size:"xl",onSubmit:e=>{if(e.preventDefault(),re()){const r=te();x(s=>({...s,...r.conditions})),b(s=>({...s,...r.actions})),$(l.current).modal("hide"),p.fire({icon:"success",title:"¡Configuración guardada!",text:"Las condiciones y acciones han sido configuradas correctamente.",timer:2e3,showConfirmButton:!1})}},children:t.jsx("div",{className:"row",id:"conditions-actions-form",children:t.jsx("div",{className:"col-12",children:f?t.jsxs("div",{children:[t.jsxs("div",{className:"alert alert-info",children:[t.jsxs("h5",{children:[t.jsx("i",{className:"fa fa-info-circle mr-2"}),"Tipo de regla: ",(he=k[f])==null?void 0:he.name]}),t.jsx("p",{children:(ye=k[f])==null?void 0:ye.description}),t.jsxs("small",{children:[t.jsx("strong",{children:"Ejemplo:"})," ",(_e=k[f])==null?void 0:_e.example]})]}),t.jsxs("div",{className:"row",children:[t.jsx("div",{className:"col-md-6",children:t.jsxs("div",{className:"card",children:[t.jsx("div",{className:"card-header",children:t.jsxs("h6",{className:"mb-0",children:[t.jsx("i",{className:"fa fa-filter mr-2"}),"Condiciones (¿Cuándo aplicar?)"]})}),t.jsx("div",{className:"card-body",children:ke()})]})}),t.jsx("div",{className:"col-md-6",children:t.jsxs("div",{className:"card",children:[t.jsx("div",{className:"card-header",children:t.jsxs("h6",{className:"mb-0",children:[t.jsx("i",{className:"fa fa-bolt mr-2"}),"Acciones (¿Qué descuento dar?)"]})}),t.jsx("div",{className:"card-body",children:Be()})]})})]}),t.jsx("div",{className:"mt-3",children:t.jsxs("div",{className:"alert alert-success",children:[t.jsxs("h6",{children:[t.jsx("i",{className:"fa fa-eye mr-2"}),"Vista previa de la regla:"]}),t.jsx("p",{className:"mb-2",children:Me()}),"                  ",t.jsxs("button",{type:"button",className:"btn btn-sm btn-info",onClick:()=>{re()&&p.fire({icon:"success",title:"¡Configuración válida!",text:"La regla está configurada correctamente y lista para usar.",timer:2e3,showConfirmButton:!1})},children:[t.jsx("i",{className:"fa fa-check mr-1"})," Probar configuración"]})]})})]}):t.jsxs("div",{className:"alert alert-warning",children:[t.jsxs("h5",{children:[t.jsx("i",{className:"fa fa-exclamation-triangle mr-2"}),"Selecciona un tipo de regla"]}),t.jsx("p",{children:"Primero debes seleccionar un tipo de regla para configurar las condiciones y acciones."})]})})})})]})};Qe((y,n)=>{Oe.createRoot(y).render(t.jsx(ze,{...n,title:"Reglas de Descuento",children:t.jsx(Xe,{...n})}))});
