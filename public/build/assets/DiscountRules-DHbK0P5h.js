import{j as t}from"./AboutSimple-Cf8x2fCZ.js";import{r as n}from"./index-BH53Isel.js";import{c as oe}from"./ReactAppend-DTVVXReZ.js";import{B as ae}from"./Base-DhUmgPjL.js";import{C as le}from"./CreateReactScript-Bq8gMpEh.js";import{T as ue}from"./Table-DitbKwtZ.js";import{I as d}from"./InputFormGroup-D5I6zpZc.js";import{R as U}from"./ReactAppend-D7S498fx.js";import{D as F}from"./DxButton-DV0H-ZcL.js";import{S as _}from"./SwitchFormGroup-CGYpv_4Q.js";import{S as de}from"./SelectFormGroup-YqB1XVb8.js";import{T as me}from"./TextareaFormGroup-DVzYJtLM.js";import{M as Y}from"./Modal-CIqmjseY.js";import{S as pe}from"./ProductCard-Ap6bpF1Q.js";import{B as ge}from"./BasicRest-B3rfI5GY.js";import{s as j}from"./server.browser-Bf4gQIc7.js";import"./index-yBjzXJbu.js";import"./index-fNjTmf9T.js";import"./Global-ErywZRdd.js";import"./tippy-react.esm-BWiGTO87.js";import"./index-rimy3MAc.js";/* empty css              */import"./Logout-7s5dsuEK.js";import"./main-BvVILmTO.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./MenuItemContainer-BwGvRAHs.js";import"./index.esm-CveLAcri.js";/* empty css               */import"./General-BmbBKdsB.js";import"./LaravelSession-Dz9cpV3l.js";import"./index-CMHsc23u.js";class he extends ge{constructor(){super(),this.path="admin/discount-rules"}async toggleActive(i,a){try{return await this.simpleGet(`/api/${this.path}/${i}/toggle-active`,{method:"PATCH",body:JSON.stringify({active:a})})}catch(u){return console.error("Error toggling active status:",u),!1}}async duplicate(i){try{return await this.simpleGet(`/api/${this.path}/${i}/duplicate`,{method:"POST"})}catch(a){return console.error("Error duplicating rule:",a),!1}}async getProducts(){try{const i=await this.simpleGet(`/api/${this.path}/products`);return(i==null?void 0:i.data)||i||[]}catch(i){return console.error("Error fetching products:",i),[]}}async getCategories(){try{const i=await this.simpleGet(`/api/${this.path}/categories`);return(i==null?void 0:i.data)||i||[]}catch(i){return console.error("Error fetching categories:",i),[]}}async getRuleTypes(){try{const i=await this.simpleGet(`/api/${this.path}/rule-types`);return(i==null?void 0:i.data)||i||{}}catch(i){return console.error("Error fetching rule types:",i),{}}}async getUsageStats(i){try{return await this.simpleGet(`/api/${this.path}/${i}/usage-stats`)}catch(a){return console.error("Error fetching usage stats:",a),null}}}const l=new he,fe=({})=>{var L,H,z;const o=n.useRef(),i=n.useRef(),a=n.useRef(),u=n.useRef(),v=n.useRef(),b=n.useRef(),m=n.useRef(),x=n.useRef(),R=n.useRef(),N=n.useRef(),S=n.useRef(),w=n.useRef(),C=n.useRef(),T=n.useRef(),D=n.useRef(),[J,k]=n.useState(!1),[xe,G]=n.useState(null),[p,V]=n.useState({}),[ye,K]=n.useState([]),[_e,Q]=n.useState([]),[q,g]=n.useState({}),[E,h]=n.useState({}),[y,P]=n.useState(""),B=e=>{const s=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0"),f=String(e.getHours()).padStart(2,"0"),A=String(e.getMinutes()).padStart(2,"0");return`${s}-${r}-${c}T${f}:${A}`},M=e=>{const s=new Date(e),r=String(s.getDate()).padStart(2,"0"),c=String(s.getMonth()+1).padStart(2,"0"),f=String(s.getFullYear()).slice(-2),A=String(s.getHours()).padStart(2,"0"),ce=String(s.getMinutes()).padStart(2,"0");return`${r}/${c}/${f} ${A}:${ce}`},I=e=>({quantity_discount:{conditions:{min_quantity:2,product_ids:[],category_ids:[]},actions:{discount_type:"percentage",discount_value:10}},cart_discount:{conditions:{min_amount:100,currency:"PEN"},actions:{discount_type:"percentage",discount_value:10}},buy_x_get_y:{conditions:{buy_quantity:2,product_ids:[]},actions:{get_quantity:1,discount_type:"fixed",discount_value:0}},category_discount:{conditions:{category_ids:[],min_quantity:1},actions:{discount_type:"percentage",discount_value:15}},tiered_discount:{conditions:{tiers:[{min_quantity:3,max_quantity:5},{min_quantity:6,max_quantity:10},{min_quantity:11,max_quantity:null}]},actions:{tier_discounts:[{discount_type:"percentage",discount_value:5},{discount_type:"percentage",discount_value:10},{discount_type:"percentage",discount_value:15}]}},bundle_discount:{conditions:{required_products:[],min_quantity_each:1},actions:{discount_type:"percentage",discount_value:25}}})[e]||{conditions:{min_quantity:1},actions:{discount_type:"percentage",discount_value:10}},W=e=>{if(P(e),e){const s=I(e);g(s.conditions),h(s.actions)}else g({}),h({})};n.useEffect(()=>{X()},[]);const X=async()=>{const[e,s,r]=await Promise.all([l.getRuleTypes(),l.getProducts(),l.getCategories()]);V(e),K(s),Q(r)},O=e=>{e!=null&&e.id?(k(!0),G(e)):(k(!1),G(null)),u.current.value=(e==null?void 0:e.id)??"",v.current.value=(e==null?void 0:e.name)??"",b.current.value=(e==null?void 0:e.description)??"";const s=(e==null?void 0:e.rule_type)??"";if(P(s),m.current&&($(m.current).val(s).trigger("change"),$(m.current).off("change.ruleType").on("change.ruleType",function(){const r=$(this).val();W(r)})),R.current.value=(e==null?void 0:e.priority)??0,N.current.value=e!=null&&e.starts_at?B(new Date(e.starts_at)):"",S.current.value=e!=null&&e.ends_at?B(new Date(e.ends_at)):"",w.current.value=(e==null?void 0:e.usage_limit)??"",C.current.value=(e==null?void 0:e.usage_limit_per_customer)??"",(e==null?void 0:e.active)!==void 0?$(x.current).prop("checked",e.active).trigger("change"):$(x.current).prop("checked",!0).trigger("change"),$(T.current).prop("checked",(e==null?void 0:e.combinable)??!1).trigger("change"),$(D.current).prop("checked",(e==null?void 0:e.stop_further_rules)??!1).trigger("change"),e!=null&&e.conditions||e!=null&&e.actions)g((e==null?void 0:e.conditions)??{}),h((e==null?void 0:e.actions)??{});else if(s){const r=I(s);g(r.conditions),h(r.actions)}else g({}),h({});$(i.current).modal("show")},Z=async e=>{e.preventDefault();const s={id:u.current.value||void 0,name:v.current.value,description:b.current.value,rule_type:$(m.current).val(),active:x.current.checked,priority:parseInt(R.current.value)||0,starts_at:N.current.value||null,ends_at:S.current.value||null,usage_limit:parseInt(w.current.value)||null,usage_limit_per_customer:parseInt(C.current.value)||null,combinable:T.current.checked,stop_further_rules:D.current.checked,conditions:q,actions:E};await l.save(s)&&($(o.current).dxDataGrid("instance").refresh(),$(i.current).modal("hide"))},ee=async({id:e,value:s})=>{await l.toggleActive(e,s)&&$(o.current).dxDataGrid("instance").refresh()},te=async e=>{await l.duplicate(e)&&$(o.current).dxDataGrid("instance").refresh()},se=async e=>{const{isConfirmed:s}=await pe.fire({title:"Eliminar regla de descuento",text:"¿Estás seguro de eliminar esta regla?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});!s||!await l.delete(e)||$(o.current).dxDataGrid("instance").refresh()},ie=()=>{$(a.current).modal("show")},re=e=>{const s=e.status||"Activa";return`<span class="badge badge-${{Activa:"success",Inactiva:"secondary",Programada:"info",Expirada:"warning",Agotada:"danger"}[s]||"secondary"}">${s}</span>`},ne=e=>{const s=e.conditions||{},r=e.actions||{};let c=e.description||"";return e.rule_type==="quantity_discount"&&s.min_quantity&&r.discount_value?c=`Compra ${s.min_quantity}+ items → ${r.discount_value}${r.discount_type==="percentage"?"%":" soles"} desc.`:e.rule_type==="cart_discount"&&s.min_amount&&r.discount_value?c=`Compras desde S/${s.min_amount} → ${r.discount_value}${r.discount_type==="percentage"?"%":" soles"} desc.`:e.rule_type==="buy_x_get_y"&&s.buy_quantity&&r.get_quantity&&(c=`Compra ${s.buy_quantity} lleva ${r.get_quantity} gratis`),c};return t.jsxs(t.Fragment,{children:[t.jsx(ue,{gridRef:o,title:"Reglas de Descuento",rest:l,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(o.current).dxDataGrid("instance").refresh()}}),e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",text:"Nueva regla",hint:"Crear nueva regla de descuento",onClick:()=>O()}})},columns:[{dataField:"id",caption:"ID",width:"60px",visible:!1},{dataField:"name",caption:"Nombre",width:"25%",cellTemplate:(e,{data:s})=>{U(e,t.jsxs("div",{children:[t.jsx("strong",{className:"d-block",children:s.name}),t.jsx("small",{className:"text-muted",children:ne(s)})]}))}},{dataField:"rule_type",caption:"Tipo",width:"15%",cellTemplate:(e,{data:s})=>{var c;const r=((c=p[s.rule_type])==null?void 0:c.name)||s.rule_type;e.html(j.renderToString(t.jsx("span",{className:"badge badge-info",children:r})))}},{dataField:"priority",caption:"Prioridad",width:"80px",cellTemplate:(e,{data:s})=>{e.html(j.renderToString(t.jsx("span",{className:"badge badge-primary",children:s.priority})))}},{dataField:"dates",caption:"Vigencia",width:"15%",allowFiltering:!1,cellTemplate:(e,{data:s})=>{const r=s.starts_at||s.ends_at?t.jsxs(t.Fragment,{children:["                  ",s.starts_at&&t.jsx("div",{children:t.jsxs("small",{children:[t.jsx("strong",{children:"Desde:"})," ",M(s.starts_at)]})}),s.ends_at&&t.jsx("div",{children:t.jsxs("small",{children:[t.jsx("strong",{children:"Hasta:"})," ",M(s.ends_at)]})})]}):t.jsx("small",{className:"text-muted",children:"Sin límite de tiempo"});e.html(j.renderToString(r))}},{dataField:"usage",caption:"Uso",width:"10%",allowFiltering:!1,cellTemplate:(e,{data:s})=>{const r=s.used_count||0,c=s.usage_limit,f=c?`${r}/${c}`:`${r}`;e.html(j.renderToString(t.jsxs("div",{className:"text-center",children:[t.jsx("strong",{children:f}),c&&t.jsx("div",{className:"progress progress-sm mt-1",children:t.jsx("div",{className:"progress-bar",style:{width:`${Math.min(r/c*100,100)}%`}})})]})))}},{dataField:"status",caption:"Estado",width:"10%",cellTemplate:(e,{data:s})=>{e.html(re(s))}},{dataField:"active",caption:"Activa",width:"80px",cellTemplate:(e,{data:s})=>{U(e,t.jsx(_,{checked:s.active,onChange:r=>ee({id:s.id,value:r.target.checked})}))}},{caption:"Acciones",width:"120px",cellTemplate:(e,{data:s})=>{e.css("text-overflow","unset"),e.append(F({className:"btn btn-xs btn-soft-info mr-1",title:"Duplicar",icon:"fa fa-copy",onClick:()=>te(s.id)})),e.append(F({className:"btn btn-xs btn-soft-primary mr-1",title:"Editar",icon:"fa fa-pen",onClick:()=>O(s)})),e.append(F({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash",onClick:()=>se(s.id)}))},allowFiltering:!1,allowExporting:!1}]}),t.jsx(Y,{modalRef:i,title:J?"Editar regla de descuento":"Nueva regla de descuento",onSubmit:Z,size:"lg",children:t.jsxs("div",{className:"row",id:"discount-rule-form",children:[t.jsx("input",{ref:u,type:"hidden"}),t.jsxs("div",{className:"col-md-8",children:[t.jsx(d,{eRef:v,label:"Nombre de la regla",required:!0}),t.jsx(me,{eRef:b,label:"Descripción",rows:2})]}),t.jsxs("div",{className:"col-md-4",children:[t.jsx(_,{eRef:x,label:"Regla activa"}),t.jsx(d,{eRef:R,label:"Prioridad",type:"number",min:0,specification:"Mayor número = mayor prioridad"})]}),t.jsx("div",{className:"col-md-6",children:t.jsxs(de,{eRef:m,label:"Tipo de regla",required:!0,dropdownParent:"#discount-rule-form",children:[t.jsx("option",{value:"",children:"Seleccione un tipo"}),Object.entries(p).map(([e,s])=>t.jsx("option",{value:e,children:s.name},e))]})}),t.jsx("div",{className:"col-md-3",children:t.jsx(d,{eRef:N,label:"Inicia",type:"datetime-local"})}),t.jsx("div",{className:"col-md-3",children:t.jsx(d,{eRef:S,label:"Termina",type:"datetime-local"})}),t.jsx("div",{className:"col-md-6",children:t.jsx(d,{eRef:w,label:"Límite total de usos",type:"number",min:1})}),t.jsx("div",{className:"col-md-6",children:t.jsx(d,{eRef:C,label:"Límite por cliente",type:"number",min:1})}),t.jsx("div",{className:"col-md-6",children:t.jsx(_,{eRef:T,label:"Combinable con otras reglas"})}),t.jsx("div",{className:"col-md-6",children:t.jsx(_,{eRef:D,label:"Detener evaluación de otras reglas"})}),t.jsxs("div",{className:"col-12",children:[t.jsx("hr",{}),t.jsxs("button",{type:"button",className:"btn btn-info btn-block",onClick:ie,children:[t.jsx("i",{className:"fa fa-cogs mr-2"}),"Configurar Condiciones y Acciones"]}),t.jsx("small",{className:"text-muted",children:"Define cuándo se aplica la regla y qué descuento otorga"})]})]})}),"    ",t.jsx(Y,{modalRef:a,title:"Configurar Condiciones y Acciones",size:"lg",hideSubmit:!0,children:t.jsx("div",{className:"row",children:t.jsx("div",{className:"col-12",children:y?t.jsxs("div",{children:[t.jsxs("div",{className:"alert alert-info",children:[t.jsxs("h5",{children:[t.jsx("i",{className:"fa fa-info-circle mr-2"}),"Tipo de regla: ",(L=p[y])==null?void 0:L.name]}),t.jsx("p",{children:(H=p[y])==null?void 0:H.description}),t.jsxs("small",{children:[t.jsx("strong",{children:"Ejemplo:"})," ",(z=p[y])==null?void 0:z.example]})]}),t.jsxs("div",{className:"row",children:[t.jsxs("div",{className:"col-md-6",children:[t.jsxs("h6",{children:[t.jsx("i",{className:"fa fa-filter mr-2"}),"Condiciones"]}),t.jsx("div",{className:"bg-light p-3 rounded",children:Object.keys(q).length>0?t.jsx("ul",{className:"mb-0",children:Object.entries(q).map(([e,s])=>t.jsxs("li",{children:[t.jsxs("strong",{children:[e,":"]})," ",Array.isArray(s)?s.join(", ")||"No especificado":s||"No especificado"]},e))}):t.jsx("em",{className:"text-muted",children:"No hay condiciones configuradas"})})]}),t.jsxs("div",{className:"col-md-6",children:[t.jsxs("h6",{children:[t.jsx("i",{className:"fa fa-bolt mr-2"}),"Acciones"]}),t.jsx("div",{className:"bg-light p-3 rounded",children:Object.keys(E).length>0?t.jsx("ul",{className:"mb-0",children:Object.entries(E).map(([e,s])=>t.jsxs("li",{children:[t.jsxs("strong",{children:[e,":"]})," ",Array.isArray(s)?s.join(", "):s]},e))}):t.jsx("em",{className:"text-muted",children:"No hay acciones configuradas"})})]})]}),t.jsx("div",{className:"mt-3",children:t.jsxs("div",{className:"alert alert-warning",children:[t.jsx("i",{className:"fa fa-exclamation-triangle mr-2"}),t.jsx("strong",{children:"Configuración automática aplicada:"})," Esta regla ha sido configurada automáticamente con valores por defecto basados en el tipo seleccionado. La funcionalidad de edición manual de condiciones y acciones se implementará en una versión futura."]})})]}):t.jsxs("div",{className:"alert alert-warning",children:[t.jsxs("h5",{children:[t.jsx("i",{className:"fa fa-exclamation-triangle mr-2"}),"Selecciona un tipo de regla"]}),t.jsx("p",{children:"Primero debes seleccionar un tipo de regla para configurar las condiciones y acciones."})]})})})})]})};le((o,i)=>{oe.createRoot(o).render(t.jsx(ae,{...i,title:"Reglas de Descuento",children:t.jsx(fe,{...i})}))});
